name: ES|QL Validation
on:
    push:
      branches: [ "main", "8.*", "9.*" ]
    pull_request:
      branches: [ "*" ]
      paths:
        - 'rules/**/*.toml'
jobs:
  build-and-validate:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        env:
          DR_CLOUD_ID: ${{ secrets.cloud_id }}
          DR_API_KEY: ${{ secrets.api_key }}
        if: ${{ !env.DR_CLOUD_ID && !env.DR_API_KEY }}
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          path: elastic-container
          repository: eric-forte-elastic/elastic-container

      - name: Build and run containers
        env:
          DR_CLOUD_ID: ${{ secrets.cloud_id }}
          DR_API_KEY: ${{ secrets.api_key }}
        if: ${{ !env.DR_CLOUD_ID && !env.DR_API_KEY }}
        run: |
          cd elastic-container
          GENERATED_PASSWORD=$(openssl rand -base64 16)
          sed -i 's/changeme/$GENERATED_PASSWORD/' .env
          echo "GENERATED_PASSWORD=$GENERATED_PASSWORD" >> $GITHUB_ENV
          set -x
          echo $GENERATED_PASSWORD
          cat .env
