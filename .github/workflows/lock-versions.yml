name: lock-versions
on:
  workflow_dispatch:
      inputs:
        branches:
          description: 'List of branches for version locking (comma separated)'
          required: true
          default: '7.13,7.14,7.15'

jobs:
  kibana-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout detection-rules
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.PROTECTIONS_MACHINE_TOKEN }}
          ref: ${{github.event.inputs.kibana_branch}}

      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Build release package
        run: |
          python -m detection_rules dev build-release

      - name: Set github config
        run: |
          git config --global user.email "72879786+protectionsmachine@users.noreply.github.com"
          git config --global user.name "protectionsmachine"

      - name: Lock the versions
        env:
          BRANCHES: "--base-branch ${{github.event.inputs.branches}}"
        run: |
          for i in $(echo $variable | sed "s/,/ /g")
          do
              # call your procedure/other scripts here below
              echo "$i"
          done

          python -m detection_rules dev kibana-pr --assign ${{github.actor}} $LABEL_ARGS $DRAFT_ARGS $BRANCH_ARGS

      - name: Archive production artifacts for branch builds
        uses: actions/upload-artifact@v2
        with:
          name: release-files
          path: |
            detection-rules/releases