[metadata]
creation_date = "2020/02/18"
maturity = "production"
promotion = true
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Elastic Endgame detected ransomware. Click the Elastic Endgame icon in the event.module column or the link in the
rule.reference column for additional information.
"""
from = "now-15m"
index = ["endgame-*"]
interval = "10m"
language = "kuery"
license = "Elastic License v2"
max_signals = 10000
name = "Ransomware - Detected - Elastic Endgame"
risk_score = 99
rule_id = "8cb4f625-7743-4dfb-ae1b-ad92be9df7bd"
setup = """## Setup

This rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.

**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.

To make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.

**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects."""
severity = "critical"
tags = ["Data Source: Elastic Endgame"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:ransomware_event or endgame.event_subtype_full:ransomware_event)
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Ransomware - Detected - Elastic Endgame

Elastic Endgame is a security solution designed to detect and respond to ransomware threats by monitoring system events and identifying suspicious activities. Adversaries exploit vulnerabilities to deploy ransomware, encrypting files and demanding payment. The detection rule identifies ransomware activity by analyzing alerts and specific event actions, enabling timely intervention to mitigate damage.

### Possible investigation steps

- Review the alert details in Elastic Endgame by clicking the icon in the event.module column or the link in the rule.reference column to gather initial context about the detected ransomware event.
- Examine the event.kind field to confirm that the alert is indeed an alert type and not a benign event.
- Check the event.module field to ensure the alert is generated by the endgame module, confirming the source of detection.
- Analyze the endgame.metadata.type field to verify that the alert is categorized as a detection, indicating a potential threat.
- Investigate the event.action and endgame.event_subtype_full fields to identify the specific ransomware event or subtype that triggered the alert.
- Correlate the alert with other related alerts or events in the system to determine if this is part of a larger attack pattern or isolated incident.
- Use Osquery to gather additional system information. For example, run the following query to list processes that have been started recently, which might indicate ransomware activity:
  ```sql
  SELECT pid, name, path, cmdline, start_time FROM processes WHERE start_time > (SELECT datetime('now', '-1 hour'));
  ```
- Check for any recent file modifications or encryptions on the system by reviewing file access logs or using file integrity monitoring tools.
- Investigate user activity around the time of the alert to identify any suspicious logins or actions that could be related to the ransomware execution.
- Review network traffic logs for any unusual outbound connections that might indicate communication with a command and control server or data exfiltration attempts.

### False positive analysis

- Known false positives for the Ransomware - Detected - Elastic Endgame rule may include legitimate software updates or backup processes that mimic ransomware behavior by encrypting files temporarily. 
- Users can manage these false positives by creating exceptions for specific processes or applications that are known to perform legitimate encryption activities, ensuring they are not flagged as threats.
- Regularly review and update the list of exceptions to accommodate new software updates or changes in legitimate processes that could trigger alerts.
- Implement a monitoring strategy to differentiate between benign and malicious encryption activities by analyzing the context and frequency of the detected events.
- Collaborate with IT and security teams to identify and document legitimate processes that may trigger false positives, ensuring these are accounted for in the security policy.

### Response and remediation

- Immediately isolate the affected systems from the network to prevent the spread of ransomware to other devices.
- Conduct a thorough investigation to identify the ransomware variant and entry point by analyzing logs and alerts from Elastic Endgame.
- Use endpoint detection and response tools to terminate malicious processes and remove ransomware executables from the affected systems.
- Restore encrypted files from the most recent clean backups to ensure data integrity and minimize downtime.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if additional systems are compromised.
- Implement enhanced logging policies to capture detailed system and network activity, aiding in future investigations and threat hunting.
- Integrate Elastic Endgame with other security solutions, such as SIEM and threat intelligence platforms, to improve detection and response capabilities.
- Apply security patches and updates to all systems to close vulnerabilities exploited by the ransomware.
- Conduct a post-incident review to identify gaps in the security posture and update incident response plans accordingly.
- Educate employees on recognizing phishing attempts and other common ransomware delivery methods to reduce the risk of future incidents."""

