[metadata]
creation_date = "2020/02/18"
maturity = "production"
promotion = true
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Elastic Endgame detected Credential Dumping. Click the Elastic Endgame icon in the event.module column or the link in
the rule.reference column for additional information.
"""
from = "now-15m"
index = ["endgame-*"]
interval = "10m"
language = "kuery"
license = "Elastic License v2"
max_signals = 10000
name = "Credential Dumping - Detected - Elastic Endgame"
risk_score = 73
rule_id = "571afc56-5ed9-465d-a2a9-045f099f6e7e"
setup = """## Setup

This rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.

**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.

To make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.

**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects."""
severity = "high"
tags = ["Data Source: Elastic Endgame", "Use Case: Threat Detection", "Tactic: Credential Access"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:cred_theft_event or endgame.event_subtype_full:cred_theft_event)
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Credential Dumping - Detected - Elastic Endgame

Elastic Endgame is a security solution that identifies suspicious activities like credential dumping, where attackers extract sensitive authentication data to gain unauthorized access. Adversaries exploit system vulnerabilities to perform such actions, often targeting OS credentials. The detection rule leverages specific event types and actions to flag these malicious attempts, aligning with MITRE ATT&CK's framework for identifying credential access threats.

### Possible investigation steps

- Review the alert details in Elastic Endgame to understand the context, including the event.kind, event.module, and endgame.metadata.type fields to confirm the detection type and source.
- Examine the event.action and endgame.event_subtype_full fields to identify the specific credential theft event that triggered the alert.
- Check the timestamp of the alert to determine when the suspicious activity occurred and correlate it with other events in the same timeframe.
- Investigate the affected host by reviewing its recent activity logs to identify any unusual behavior or unauthorized access attempts.
- Use Osquery to gather more information about the processes running on the affected host. For example, run the following query to list processes that might be involved in credential dumping:
  ```sql
  SELECT pid, name, path, cmdline FROM processes WHERE name IN ('lsass.exe', 'mimikatz.exe', 'procdump.exe');
  ```
- Analyze user account activity on the affected host to identify any unauthorized access or privilege escalation attempts.
- Review network logs to detect any suspicious outbound connections that might indicate data exfiltration following the credential dumping.
- Cross-reference the alert with other security tools and logs to identify any related alerts or indicators of compromise (IOCs) that might suggest a broader attack campaign.
- Investigate any recent changes to system configurations or installed software that could have introduced vulnerabilities exploited for credential dumping.
- Document all findings and observations to build a comprehensive timeline of events and support further analysis or escalation if necessary.

### False positive analysis

- Known false positives for the Credential Dumping - Detected - Elastic Endgame rule may include legitimate administrative tools or scripts that access credential stores for authorized purposes, such as system backups or password management software.
- Security teams can manage these false positives by creating exceptions for specific processes or applications that are known to perform credential access in a non-malicious context, ensuring these are well-documented and regularly reviewed.
- Users should also consider the context of the detected event, such as the time of day or the user account involved, to determine if the activity aligns with expected behavior.
- Implementing a whitelist of trusted applications and processes that are allowed to access credentials can help reduce false positives while maintaining security.
- Regularly updating the detection rules and maintaining communication with IT and security teams can help in identifying and excluding benign activities that trigger alerts.

### Response and remediation

- Isolate the affected system from the network to prevent further unauthorized access and lateral movement.
- Conduct a thorough investigation to identify the source and scope of the credential dumping activity, utilizing logs and forensic tools.
- Reset passwords for compromised accounts and implement multi-factor authentication to enhance security.
- Review and update security patches and configurations to address vulnerabilities exploited during the attack.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging policies to capture detailed authentication and access events for future investigations.
- Integrate additional security solutions, such as endpoint detection and response (EDR) tools, to improve threat detection capabilities.
- Restore the system to its operational state by reimaging affected machines and verifying the integrity of critical files and applications.
- Conduct a post-incident review to identify gaps in security controls and update incident response plans accordingly.
- Apply hardening measures, such as disabling unnecessary services and enforcing least privilege access, to reduce the attack surface."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1003"
name = "OS Credential Dumping"
reference = "https://attack.mitre.org/techniques/T1003/"
[[rule.threat.technique.subtechnique]]
id = "T1003.001"
name = "LSASS Memory"
reference = "https://attack.mitre.org/techniques/T1003/001/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

