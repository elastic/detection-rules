[metadata]
creation_date = "2025/12/04"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/12/04"

[rule]
author = ["Elastic"]
description = """
Detects when GenAI tools access sensitive files such as cloud credentials, SSH keys, browser password databases, or
shell configurations. Attackers leverage GenAI agents to systematically locate and exfiltrate credentials, API keys,
and tokens. Access to credential stores (.aws/credentials, .ssh/id_*) suggests harvesting, while writes to shell
configs (.bashrc, .zshrc) indicate persistence attempts.
"""
from = "now-9m"
index = ["logs-endpoint.events.*"]
language = "eql"
license = "Elastic License v2"
name = "GenAI Process Accessing Sensitive Files"
note = """## Triage and analysis

### Investigating GenAI Process Accessing Sensitive Files

This rule detects GenAI tools accessing credential files, SSH keys, browser data, or shell configurations. While GenAI tools legitimately access project files, access to sensitive credential stores is unusual and warrants investigation.

### Possible investigation steps

- Review the GenAI process that triggered the alert to identify which tool is being used and verify if it's an expected/authorized tool.
- Investigate the user account associated with the GenAI process to determine if this activity is expected for that user.
- Review the types of sensitive files being accessed (credentials, keys, browser data, etc.) to assess the potential impact of credential harvesting or data exfiltration.
- Check for other alerts or suspicious activity on the same host around the same time, particularly network exfiltration events.
- Verify if the GenAI tool or extension is from a trusted source and if it's authorized for use in your environment.
- Determine if the GenAI process accessed multiple sensitive directories in sequence, an indication of credential harvesting.
- Check if the GenAI tool recently created or accessed AI agent config files, which may contain instructions enabling autonomous file scanning.
- Review whether the access was preceded by an MCP server, LangChain agent, or background automation.

### False positive analysis

- Automated security scanning or auditing tools that leverage GenAI may access sensitive files as part of their normal operation.
- Development workflows that use GenAI tools for code analysis may occasionally access credential files.

### Response and remediation

- Immediately review the GenAI process that accessed the documents to determine if it's compromised or malicious.
- Review, rotate, and revoke any API keys, tokens, or credentials that may have been exposed or used by the GenAI tool.
- Investigate the document access patterns to determine the scope of potential data exfiltration.
- Update security policies to restrict or monitor GenAI tool usage in the environment, especially for access to sensitive files.
"""
references = [
  "https://atlas.mitre.org/techniques/AML.T0085",
  "https://atlas.mitre.org/techniques/AML.T0085.001",
  "https://atlas.mitre.org/techniques/AML.T0055",
  "https://glama.ai/blog/2025-11-11-the-lethal-trifecta-securing-model-context-protocol-against-data-flow-attacks",
  "https://www.elastic.co/security-labs/elastic-advances-llm-security",
  "https://specterops.io/blog/2025/11/21/an-evening-with-claude-code"
]
risk_score = 73
rule_id = "c0136397-f82a-45e5-9b9f-a3651d77e21a"
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "OS: macOS",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Collection",
    "Tactic: Credential Access",
    "Data Source: Elastic Defend",
    "Resources: Investigation Guide",
    "Domain: LLM",
    "Mitre Atlas: T0085",
    "Mitre Atlas: T0085.001",
    "Mitre Atlas: T0055",
]
timestamp_override = "event.ingested"
type = "eql"
query = '''
file where event.action in ("open", "creation", "modification") and event.outcome == "success" and

  // GenAI process or child of GenAI process
  (
    process.name in (
      "ollama.exe", "ollama", "Ollama",
      "textgen.exe", "textgen", "text-generation-webui.exe", "oobabooga.exe",
      "lmstudio.exe", "lmstudio", "LM Studio",
      "claude.exe", "claude", "Claude",
      "cursor.exe", "cursor", "Cursor",
      "copilot.exe", "copilot", "Copilot",
      "codex.exe", "codex",
      "Jan", "jan.exe", "jan",
      "gpt4all.exe", "gpt4all", "GPT4All",
      "gemini-cli.exe", "gemini-cli",
      "genaiscript.exe", "genaiscript",
      "grok.exe", "grok",
      "qwen.exe", "qwen",
      "koboldcpp.exe", "koboldcpp", "KoboldCpp",
      "llama-server", "llama-cli"
    ) or
    process.parent.name in (
      "ollama.exe", "ollama", "Ollama",
      "textgen.exe", "textgen", "text-generation-webui.exe", "oobabooga.exe",
      "lmstudio.exe", "lmstudio", "LM Studio",
      "claude.exe", "claude", "Claude",
      "cursor.exe", "cursor", "Cursor", "Cursor Helper", "Cursor Helper (Plugin)",
      "copilot.exe", "copilot", "Copilot",
      "codex.exe", "codex",
      "Jan", "jan.exe", "jan", "Jan Helper",
      "gpt4all.exe", "gpt4all", "GPT4All",
      "gemini-cli.exe", "gemini-cli",
      "genaiscript.exe", "genaiscript",
      "grok.exe", "grok",
      "qwen.exe", "qwen",
      "koboldcpp.exe", "koboldcpp", "KoboldCpp",
      "llama-server", "llama-cli"
    )
  ) and

  // Sensitive file paths
  (
    // Cloud credentials
    file.path like~ ("*/.aws/credentials*", "*/.aws/config*", "*/.azure/*", "*/.config/gcloud/*") or
    // SSH keys and config
    file.path like~ ("*/.ssh/id_*", "*/.ssh/config*", "*/.ssh/known_hosts*", "*/.ssh/authorized_keys*") or
    // Shell configs (persistence)
    file.path like~ ("*/.bashrc*", "*/.bash_profile*", "*/.zshrc*", "*/.zshenv*", "*/.zprofile*", "*/.profile*", "*/.bash_logout*") or
    // Browser credentials
    file.path like~ ("*/Login Data*", "*/Cookies*", "*/Web Data*", "*\\Login Data*", "*\\Cookies*", "*\\Web Data*") or
    // macOS Keychain
    file.path like~ ("*/Keychain/*.keychain*", "*/keychains/*.keychain-db*") or
    // Git credentials
    file.path like~ ("*/.git-credentials*", "*/.netrc*") or
    // GPG/PGP keys
    file.path like~ ("*/.gnupg/*", "*/.pgp/*") or
    // Docker credentials
    file.path like~ ("*/.docker/config.json*") or
    // Kubernetes config
    file.path like~ ("*/.kube/config*") or
    // Package manager tokens
    file.path like~ ("*/.npmrc*", "*/.yarnrc*") or
    // Python credentials
    file.path like~ ("*/.pypirc*", "*/pip.conf*") or
    // GitHub CLI config
    file.path like~ ("*/.config/gh/*", "*/.config/hub*") or
    // Password managers
    file.path like~ ("*1Password*", "*Bitwarden*", "*KeePass*", "*LastPass*") or
    // Windows credentials
    file.path like~ ("*\\AppData\\*\\Credentials\\*", "*\\AppData\\*\\Vault\\*")
  ) and

  // Exclusions
  not (
    // Claude accessing own credentials
    (process.name == "security" and
     process.parent.name in ("claude", "claude.exe", "Claude", "node", "node.exe") and
     process.command_line like~ ("*Claude Code*", "*Claude Code-credentials*", "*claude-code*")) or
    
    // GenAI tools accessing own config
    (file.path like~ ("*Claude*", "*Cursor*", "*claude-code*", "*/anthropic/*",
                      "*/.ollama/*", "*Ollama*", "*codex*", "*Jan*", "*/jan/*",
                      "*Copilot*", "*LM Studio*", "*gpt4all*") and
     process.parent.name in ("claude", "claude.exe", "Claude", "cursor", "cursor.exe",
                             "Cursor", "ollama", "ollama.exe", "Ollama", "codex", "codex.exe",
                             "Jan", "jan", "Copilot", "LM Studio", "gpt4all")) or
    
    // IDE extensions accessing state files
    (file.path like~ ("*/.vscode/*", "*/.cursor/*") and
     process.executable like~ ("*/.vscode/extensions/*", "*/.cursor/extensions/*")) or
    
    // Shell config sourcing (read-only)
    (event.action == "open" and
     process.name in ("zsh", "bash", "sh", "fish") and
     process.parent.name in ("claude", "claude.exe", "cursor", "cursor.exe", "codex", "codex.exe",
                             "Jan", "jan", "Ollama", "ollama", "LM Studio") and
     file.path like~ ("*/.zshrc", "*/.bashrc", "*/.bash_profile", "*/.profile")) or
    
    // Code search tools
    (process.name in ("rg", "ripgrep") or process.command_line like~ "*--ripgrep*") or
    
    // Git config (not credentials)
    (process.name == "git" and
     file.path like~ ("*/.gitconfig", "*/.git/config", "*/.git/HEAD") and
     not file.path like~ "*/.git-credentials*") or
    
    // System info commands
    process.name in ("uname", "sw_vers", "which", "hostname", "id", "whoami",
                     "ioreg", "scutil", "defaults", "env", "getconf", "locale")
  )
'''

[[rule.threat]]
framework = "MITRE ATLAS"

  [rule.threat.tactic]
  name = "Collection"
  id = "AML.TA0009"
  reference = "https://atlas.mitre.org/tactics/AML.TA0009/"

  [[rule.threat.technique]]
  name = "Data from AI Services"
  id = "AML.T0085"
  reference = "https://atlas.mitre.org/techniques/AML.T0085/"

    [[rule.threat.technique.subtechnique]]
    name = "AI Agent Tools"
    id = "AML.T0085.001"
    reference = "https://atlas.mitre.org/techniques/AML.T0085.001"

[[rule.threat]]
framework = "MITRE ATLAS"

  [rule.threat.tactic]
  name = "Credential Access"
  id = "AML.TA0013"
  reference = "https://atlas.mitre.org/tactics/AML.TA0013/"

  [[rule.threat.technique]]
  name = "Unsecured Credentials"
  id = "AML.T0055"
  reference = "https://atlas.mitre.org/techniques/AML.T0055/"
