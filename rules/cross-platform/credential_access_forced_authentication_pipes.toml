[metadata]
creation_date = "2024/07/23"
integration = ["endpoint", "system"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies a potential forced authentication using related SMB named pipes. Attackers may attempt to force targets to
authenticate to a host controlled by them to capture hashes or enable relay attacks.
"""
from = "now-9m"
index = ["logs-endpoint.events.network-*", "logs-system.security-*", "winlogbeat-*"]
language = "eql"
license = "Elastic License v2"
name = "Active Directory Forced Authentication from Linux Host - SMB Named Pipes"
references = [
    "https://github.com/p0dalirius/windows-coerced-authentication-methods",
    "https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications",
    "https://attack.mitre.org/techniques/T1187/",
]
risk_score = 47
rule_id = "c24e9a43-f67e-431d-991b-09cdb83b3c0c"
setup = """## Setup

This rule uses Elastic Endpoint network events from Linux hosts and system integration events from Domain controllers
for correlation. Both data sources should be collected from the hosts for this detection to work.

The 'Audit Detailed File Share' audit policy must be configured (Success Failure).
Steps to implement the logging policy with Advanced Audit Configuration:
```
Computer Configuration >
Policies >
Windows Settings >
Security Settings >
Advanced Audit Policies Configuration >
Audit Policies >
Object Access >
Audit Detailed File Share (Success,Failure)
```
"""
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Data Source: Elastic Defend",
    "Data Source: Active Directory",
    "Use Case: Active Directory Monitoring",
    "Data Source: System",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
sequence with maxspan=15s
[network where host.os.type == "linux" and event.action == "connection_attempted" and destination.port == 445 and not startswith~(string(destination.ip), string(host.ip))] by host.ip, data_stream.namespace
[file where host.os.type == "windows" and event.code == "5145" and file.name : ("Spoolss", "netdfs", "lsarpc", "lsass", "netlogon", "samr", "efsrpc", "FssagentRpc")] by source.ip, data_stream.namespace
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Active Directory Forced Authentication from Linux Host - SMB Named Pipes

Active Directory (AD) and SMB named pipes facilitate communication and resource sharing in networks. Adversaries exploit these by forcing authentication from a Linux host to capture credentials or perform relay attacks. The detection rule identifies suspicious connection attempts to SMB ports from Linux hosts and monitors specific named pipes on Windows, indicating potential forced authentication attempts.

### Possible investigation steps

- Review the alert details to confirm the source and destination IP addresses involved in the suspicious connection attempt, focusing on the `host.ip` and `destination.ip` fields.
- Verify the Linux host's activity by checking recent network logs for any unusual or unauthorized connection attempts to SMB port 445, using the `event.action` and `destination.port` fields.
- Cross-reference the `source.ip` from the Windows event logs with known IP addresses to determine if the connection originated from a trusted or suspicious source.
- Investigate the specific named pipes accessed on the Windows host by examining the `file.name` field in the event logs to identify any unusual or unauthorized access attempts.
- Use Osquery to gather additional context on the Linux host by running a query to list all active network connections: `SELECT * FROM process_open_sockets WHERE remote_port = 445;`
- Check for any recent changes or anomalies in the Linux host's configuration or installed software that could indicate compromise or unauthorized access.
- Analyze the Windows event logs for any other related events around the same timestamp as the alert to identify potential patterns or additional suspicious activity.
- Investigate the user accounts involved in the connection attempt by reviewing authentication logs on both the Linux and Windows hosts to identify any unauthorized access attempts.
- Correlate the alert with other security tools and logs, such as intrusion detection systems or endpoint protection solutions, to gather additional context and evidence.
- Document all findings and observations during the investigation to build a comprehensive understanding of the incident and support further analysis or escalation if necessary.

### False positive analysis

- Routine administrative tasks: Linux hosts performing legitimate administrative tasks on Windows servers may trigger the rule. These tasks often involve connecting to SMB ports for file sharing or management purposes. Users can manage this by creating exceptions for known administrative IP addresses or specific time windows when these tasks are scheduled.
- Backup operations: Automated backup processes from Linux systems to Windows servers might generate connection attempts to SMB ports. To handle this, users can exclude IP addresses of backup servers or specific data streams associated with backup operations.
- Monitoring and security tools: Security or monitoring tools running on Linux hosts may attempt to connect to Windows systems for log collection or system checks, leading to false positives. Users should identify and whitelist these tools by their IP addresses or data stream namespaces.
- Development and testing environments: In environments where Linux hosts are used for testing or development, frequent connections to Windows systems might occur as part of normal operations. Users can exclude these environments by defining exceptions for specific subnets or hostnames associated with development and testing activities.

### Response and remediation

- Immediately isolate the affected Linux host from the network to prevent further unauthorized access or credential capture.
- Conduct a thorough investigation of the Linux host to identify any malicious scripts or tools used for forced authentication attempts.
- Review and analyze logs from both the Linux and Windows systems to trace the source and scope of the attack, focusing on the specific named pipes and network connections involved.
- Change passwords for any accounts that may have been exposed or compromised during the attack to prevent unauthorized access.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if the attack is part of a larger campaign.
- Implement enhanced logging policies to capture detailed authentication events and network traffic, ensuring that future suspicious activities are detected promptly.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to correlate events and improve detection capabilities.
- Restore the affected systems to their operational state by removing any malicious software and applying necessary security patches and updates.
- Harden the security posture of the network by disabling unnecessary SMB services and enforcing strong authentication mechanisms, such as multi-factor authentication (MFA).
- Conduct a post-incident review to identify gaps in the current security posture and update incident response plans to address similar threats in the future."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1187"
name = "Forced Authentication"
reference = "https://attack.mitre.org/techniques/T1187/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

