[metadata]
creation_date = "2020/01/12"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies use of Bifrost, a known macOS Kerberos pentesting tool, which can be used to dump cached Kerberos tickets or
attempt unauthorized authentication techniques such as pass-the-ticket/hash and kerberoasting.
"""
from = "now-9m"
index = ["logs-endpoint.events.*"]
language = "kuery"
license = "Elastic License v2"
name = "Potential Kerberos Attack via Bifrost"
references = ["https://github.com/its-a-feature/bifrost"]
risk_score = 73
rule_id = "16904215-2c95-4ac8-bf5c-12354e047192"
setup = """## Setup

This rule requires data coming in from Elastic Defend.

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, for MacOS it is recommended to select "Traditional Endpoints".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
"""
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: macOS",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Tactic: Lateral Movement",
    "Data Source: Elastic Defend",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.category:process and host.os.type:macos and event.type:start and
 process.args:("-action" and ("-kerberoast" or askhash or asktgs or asktgt or s4u or ("-ticket" and ptt) or (dump and (tickets or keytab))))
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Kerberos Attack via Bifrost

Kerberos is a network authentication protocol designed to provide secure identity verification for users and services. Adversaries exploit tools like Bifrost on macOS to manipulate Kerberos tickets, enabling unauthorized access through techniques like pass-the-ticket or kerberoasting. The detection rule identifies suspicious process activities linked to Bifrost's known attack methods, focusing on specific command-line arguments indicative of such exploits.

### Possible investigation steps

- Review the alert details to confirm the presence of suspicious command-line arguments such as "-action", "-kerberoast", "askhash", "asktgs", "asktgt", "s4u", "-ticket ptt", or "dump tickets/keytab" in the process arguments.
- Correlate the process start event with the user account associated with the process to determine if the account is legitimate and authorized to perform such actions.
- Examine the parent process of the suspicious activity to identify if it was initiated by a legitimate application or script, which might indicate a false positive.
- Check the process execution history on the affected host to identify any other unusual or unauthorized activities that might be related to the alert.
- Utilize Osquery to gather additional context on the suspicious process. For example, run the following query to list all processes with similar arguments: `SELECT pid, name, path, cmdline FROM processes WHERE cmdline LIKE '%-action%' AND (cmdline LIKE '%-kerberoast%' OR cmdline LIKE '%askhash%' OR cmdline LIKE '%asktgs%' OR cmdline LIKE '%asktgt%' OR cmdline LIKE '%s4u%' OR (cmdline LIKE '%-ticket%' AND cmdline LIKE '%ptt%') OR (cmdline LIKE '%dump%' AND (cmdline LIKE '%tickets%' OR cmdline LIKE '%keytab%')));`
- Investigate the network connections established by the suspicious process to identify any unusual or unauthorized communication with external or internal systems.
- Analyze the system logs for any Kerberos-related events that coincide with the time of the alert to identify potential unauthorized authentication attempts.
- Review recent changes to the system, such as software installations or updates, that might have introduced the Bifrost tool or similar utilities.
- Check for any other alerts or indicators of compromise on the same host or within the same network segment that might suggest a broader attack campaign.
- Consult threat intelligence sources to determine if there are any known campaigns or threat actors currently exploiting Bifrost or similar tools, which could provide additional context for the investigation.

### False positive analysis

- Legitimate administrative activities: System administrators may use Bifrost or similar tools for legitimate purposes such as testing Kerberos configurations or performing security audits. These activities can trigger the detection rule, leading to false positives.
- Automated scripts: Some organizations may have automated scripts that interact with Kerberos tickets for maintenance or monitoring purposes. These scripts might use command-line arguments similar to those flagged by the detection rule.
- Security testing: Security teams conducting penetration tests or red team exercises might intentionally use Bifrost to simulate attacks, which could be misidentified as genuine threats.
- To manage false positives, users can create exceptions for known benign activities by whitelisting specific processes or users that are verified to perform legitimate tasks. Additionally, organizations can refine the detection rule to exclude certain command-line arguments or process paths that are consistently associated with non-threatening behavior.

### Response and remediation

- Isolate the affected macOS system from the network to prevent further unauthorized access or lateral movement.
- Conduct a thorough investigation to confirm the presence of Bifrost or any unauthorized Kerberos ticket manipulation by reviewing process logs and command-line arguments.
- Revoke any compromised Kerberos tickets and reset credentials for affected accounts to prevent further unauthorized access.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine the scope of the attack.
- Implement enhanced logging policies to capture detailed process execution and command-line arguments on macOS systems for future investigations.
- Integrate threat intelligence feeds and endpoint detection and response (EDR) solutions to improve detection capabilities for similar threats.
- Restore the system to its operational state by applying the latest security patches and updates to macOS and related software.
- Conduct a security audit of Kerberos configurations and policies to ensure they adhere to best practices and reduce the risk of exploitation.
- Educate users and administrators on recognizing and reporting suspicious activities related to Kerberos authentication and ticket usage.
- Review and update access controls and permissions to ensure the principle of least privilege is enforced across the network."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1550"
name = "Use Alternate Authentication Material"
reference = "https://attack.mitre.org/techniques/T1550/"
[[rule.threat.technique.subtechnique]]
id = "T1550.003"
name = "Pass the Ticket"
reference = "https://attack.mitre.org/techniques/T1550/003/"



[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1558"
name = "Steal or Forge Kerberos Tickets"
reference = "https://attack.mitre.org/techniques/T1558/"
[[rule.threat.technique.subtechnique]]
id = "T1558.003"
name = "Kerberoasting"
reference = "https://attack.mitre.org/techniques/T1558/003/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

