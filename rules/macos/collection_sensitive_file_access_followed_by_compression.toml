[metadata]
creation_date = "2026/01/30"
integration = ["endpoint"]
maturity = "production"
updated_date = "2026/01/30"

[rule]
author = ["Elastic"]
description = """
Detects when a sensitive file is accessed followed by the immediate creation of a compressed file in a 
suspicious location. This activity can indicate an attempt to collect sensitive local data and stage it 
for exfiltration.
"""
from = "now-9m"
index = ["logs-endpoint.events.file-*"]
language = "eql"
license = "Elastic License v2"
name = "Sensitive File Access followed by Compression"
risk_score = 73
rule_id = "a0fbd7a9-1923-4e05-92df-b484168f17bc"
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: macOS",
    "Use Case: Threat Detection",
    "Tactic: Collection",
    "Data Source: Elastic Defend"
]
type = "eql"
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Sensitive File Access followed by Compression

This rule detects when sensitive files like SSH keys, AWS credentials, or browser data are accessed and then compressed. This behavior is commonly seen in data exfiltration attacks where threat actors stage collected data for transfer.

### Possible investigation steps

- Identify the user account and process that accessed the sensitive files.
- Review the compression target to understand what data was staged.
- Check for any subsequent network connections that could indicate exfiltration.
- Examine the process lineage to identify the initial access vector.

### False positive analysis

- Legitimate backup operations may access and compress sensitive files.
- System administrators may perform manual archiving of configuration files.

### Response and remediation

- Isolate the affected system to prevent data exfiltration.
- Identify and contain any exfiltrated data.
- Rotate any compromised credentials immediately.
- Conduct forensic analysis to determine the scope of the breach.
"""
query = '''
sequence by process.entity_id with maxspan=30s
  [file where host.os.type == "macos" and event.action == "open" and 
    not file.name in~ ("System.keychain", "login.keychain-db", "preferences.plist", "com.apple.TimeMachine.plist")]
  [file where host.os.type == "macos" and event.action == "modification" and 
    file.extension in ("zip", "gzip", "gz") and
    file.path like~ ("/Users/Shared/*", "/Library/WebServer/*", "/Users/*/Library/WebServer/*",
                     "/Library/Graphics/*", "/Users/*/Library/Graphics/*", "/Library/Fonts/*",
                     "/Users/*/Library/Fonts/*", "/private/var/root/Library/HTTPStorages/*",
                     "/tmp/*", "/var/tmp/*", "/private/tmp/*") and
    not file.path like~ ("/Library/Logs/CrashReporter/*", "/private/tmp/publish.*")]
'''

[[rule.threat]]
framework = "MITRE ATT&CK"

  [rule.threat.tactic]
  name = "Collection"
  id = "TA0009"
  reference = "https://attack.mitre.org/tactics/TA0009/"

  [[rule.threat.technique]]
  name = "Data Staged"
  id = "T1074"
  reference = "https://attack.mitre.org/techniques/T1074/"

    [[rule.threat.technique.subtechnique]]
    name = "Local Data Staging"
    id = "T1074.001"
    reference = "https://attack.mitre.org/techniques/T1074/001/"

  [[rule.threat.technique]]
  name = "Archive Collected Data"
  id = "T1560"
  reference = "https://attack.mitre.org/techniques/T1560/"

[[rule.threat]]
framework = "MITRE ATT&CK"

  [rule.threat.tactic]
  name = "Exfiltration"
  id = "TA0010"
  reference = "https://attack.mitre.org/tactics/TA0010/"
