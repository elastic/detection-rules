[metadata]
creation_date = "2021/01/19"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Detects attempts to exploit privilege escalation vulnerabilities related to the Adobe Acrobat Reader
PrivilegedHelperTool responsible for installing updates. For more information, refer to CVE-2020-9615, CVE-2020-9614 and
CVE-2020-9613 and verify that the impacted system is patched.
"""
false_positives = ["Trusted system or Adobe Acrobat Related processes."]
from = "now-9m"
index = ["logs-endpoint.events.*"]
language = "kuery"
license = "Elastic License v2"
name = "Suspicious Child Process of Adobe Acrobat Reader Update Service"
references = [
    "https://rekken.github.io/2020/05/14/Security-Flaws-in-Adobe-Acrobat-Reader-Allow-Malicious-Program-to-Gain-Root-on-macOS-Silently/",
]
risk_score = 73
rule_id = "f85ce03f-d8a8-4c83-acdc-5c8cd0592be7"
setup = """## Setup

This rule requires data coming in from Elastic Defend.

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, for MacOS it is recommended to select "Traditional Endpoints".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
"""
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: macOS",
    "Use Case: Threat Detection",
    "Tactic: Privilege Escalation",
    "Use Case: Vulnerability",
    "Data Source: Elastic Defend",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.category:process and host.os.type:macos and event.type:(start or process_started) and
  process.parent.name:com.adobe.ARMDC.SMJobBlessHelper and
  user.name:root and
  not process.executable: (/Library/PrivilegedHelperTools/com.adobe.ARMDC.SMJobBlessHelper or
                           /usr/bin/codesign or
                           /private/var/folders/zz/*/T/download/ARMDCHammer or
                           /usr/sbin/pkgutil or
                           /usr/bin/shasum or
                           /usr/bin/perl* or
                           /usr/sbin/spctl or
                           /usr/sbin/installer or
                           /usr/bin/csrutil)
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Suspicious Child Process of Adobe Acrobat Reader Update Service

Adobe Acrobat Reader's update service uses a privileged helper tool to manage updates on macOS, running with elevated permissions. Adversaries may exploit vulnerabilities in this service to escalate privileges by executing unauthorized processes as the root user. The detection rule identifies unusual child processes spawned by the update service, excluding known legitimate executables, to flag potential exploitation attempts.

### Possible investigation steps

- Review the alert details to confirm the process name and executable path that triggered the alert, ensuring it matches the criteria specified in the detection rule.
- Verify the parent process name is `com.adobe.ARMDC.SMJobBlessHelper` and the user context is `root` to confirm the alert's legitimacy.
- Check the process execution timeline to identify any preceding or subsequent suspicious activities that might indicate a broader attack pattern.
- Use Osquery to list all child processes spawned by `com.adobe.ARMDC.SMJobBlessHelper` to identify any other potentially unauthorized processes:
  ```sql
  SELECT pid, name, path, cmdline FROM processes WHERE parent = (SELECT pid FROM processes WHERE name = 'com.adobe.ARMDC.SMJobBlessHelper');
  ```
- Investigate the command line arguments of the suspicious process to understand its intended actions and potential impact.
- Cross-reference the suspicious process's executable path with known legitimate software paths to rule out false positives.
- Examine system logs for any unusual activity around the time the suspicious process was executed, focusing on authentication and system modification logs.
- Check for any recent installations or updates of Adobe Acrobat Reader that might have introduced vulnerabilities or been exploited.
- Investigate the network activity of the suspicious process to identify any external communications that could indicate data exfiltration or command-and-control activity.
- Review the system's patch status to ensure it is up-to-date with security patches, particularly those addressing CVE-2020-9615, CVE-2020-9614, and CVE-2020-9613.

### False positive analysis

- Known false positives may include legitimate administrative scripts or tools that are executed by the root user but are not part of the predefined list of allowed executables. These could be custom scripts or third-party management tools that are not typically associated with malicious activity.
- Users can handle these false positives by reviewing the flagged processes to determine if they are part of regular administrative tasks or maintenance activities. If confirmed as non-threatening, these processes can be added to an exclusion list to prevent future alerts.
- Another potential false positive scenario involves software updates or installations that utilize temporary or dynamically generated paths not covered by the existing exclusion list. Users should verify the legitimacy of these processes and consider updating the exclusion list to include these paths if they are deemed safe.
- It is important to regularly review and update the exclusion list to reflect changes in legitimate software behavior or new administrative tools that may be introduced into the environment, ensuring that only genuine threats are flagged by the detection rule.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or lateral movement.
- Conduct a thorough investigation to confirm the alert by reviewing process execution logs and identifying any unauthorized child processes spawned by the Adobe Acrobat Reader update service.
- Verify the system's patch status and ensure that it is updated with the latest security patches, specifically addressing CVE-2020-9615, CVE-2020-9614, and CVE-2020-9613.
- Terminate any suspicious processes identified during the investigation that are not part of the legitimate update service operations.
- Restore the system to a known good state using backups or system restore points if available and ensure that all security patches are applied.
- Implement enhanced logging policies to capture detailed process execution data and user activity, focusing on privileged operations and service executions.
- Integrate security solutions such as Endpoint Detection and Response (EDR) tools to provide real-time monitoring and automated response capabilities.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if additional systems are affected.
- Conduct a post-incident review to identify gaps in security controls and update security policies and procedures to prevent future exploitation attempts.
- Implement hardening measures such as restricting the execution of unnecessary privileged services, enforcing the principle of least privilege, and regularly auditing privileged accounts and services."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1068"
name = "Exploitation for Privilege Escalation"
reference = "https://attack.mitre.org/techniques/T1068/"


[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"

