[metadata]
creation_date = "2026/01/30"
integration = ["endpoint"]
maturity = "production"
updated_date = "2026/01/30"

[rule]
author = ["Elastic"]
description = """
Detects the use of process environment variables (DYLD_INSERT_LIBRARIES or LD_PRELOAD) to inject a shared 
library into a binary at or prior to execution. A threat actor may use this technique to load a malicious 
shared library for persistence, privilege escalation, and defense evasion. This activity is uncommon and 
typically indicates malicious behavior.
"""
from = "now-9m"
index = ["logs-endpoint.events.process-*", "logs-endpoint.events.library-*"]
language = "eql"
license = "Elastic License v2"
name = "Dylib Injection via Process Environment Variables"
references = [
    "https://wojciechregula.blog/post/learn-xpc-exploitation-part-3-code-injections/",
    "https://attack.mitre.org/techniques/T1574/006/"
]
risk_score = 73
rule_id = "fb8790fc-d485-45e2-8d6e-2fb813f4af95"
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: macOS",
    "Use Case: Threat Detection",
    "Tactic: Defense Evasion",
    "Tactic: Persistence",
    "Data Source: Elastic Defend"
]
type = "eql"
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Dylib Injection via Process Environment Variables

This rule detects the use of DYLD environment variables to inject malicious dynamic libraries into processes. This technique allows threat actors to hook legitimate application functionality for credential theft or code execution.

### Possible investigation steps

- Identify the process using DYLD injection environment variables.
- Locate and analyze the injected dylib file.
- Determine the target application being hijacked.
- Review the parent process to understand the injection context.

### False positive analysis

- Development and debugging tools may use DYLD variables legitimately.
- Security research tools may inject libraries for analysis.

### Response and remediation

- Terminate the process using malicious dylib injection.
- Remove the injected dylib file from the system.
- Investigate how the dylib was placed on the system.
- Review System Integrity Protection status on the affected system.
"""
query = '''
sequence by process.entity_id with maxspan=15s
  [process where host.os.type == "macos" and event.type == "start" and event.action == "exec" and
    process.env_vars like ("DYLD_INSERT_LIBRARIES=?*", "LD_PRELOAD=?*") and
    not process.env_vars like ("DYLD_INSERT_LIBRARIES=", "LD_PRELOAD=", "LD_PRELOAD=<null>") and
    not process.executable like ("/Users/*/Library/Developer/Xcode/*", "/Users/*/Library/Developer/CoreSimulator/*") and
    not process.parent.executable like ("/usr/bin/xcrun", "/Applications/Xcode*.app/*", "/Library/Developer/*")]
  [library where host.os.type == "macos" and event.action == "load" and
    not dll.name like ("*.aot", "*.so") and
    not dll.code_signature.trusted == true and
    not dll.path like ("/System/*", "/usr/lib/*", "/opt/homebrew/*", "/private/var/folders/*",
                       "/Library/Apple/*", "/Library/Developer/*",
                       "/Users/*/Library/Developer/Xcode/*", "/Users/*/Library/Developer/CoreSimulator/*")]
'''

[[rule.threat]]
framework = "MITRE ATT&CK"

  [rule.threat.tactic]
  name = "Defense Evasion"
  id = "TA0005"
  reference = "https://attack.mitre.org/tactics/TA0005/"

  [[rule.threat.technique]]
  name = "Hijack Execution Flow"
  id = "T1574"
  reference = "https://attack.mitre.org/techniques/T1574/"

    [[rule.threat.technique.subtechnique]]
    name = "Dynamic Linker Hijacking"
    id = "T1574.006"
    reference = "https://attack.mitre.org/techniques/T1574/006/"

[[rule.threat]]
framework = "MITRE ATT&CK"

  [rule.threat.tactic]
  name = "Persistence"
  id = "TA0003"
  reference = "https://attack.mitre.org/tactics/TA0003/"

  [[rule.threat.technique]]
  name = "Hijack Execution Flow"
  id = "T1574"
  reference = "https://attack.mitre.org/techniques/T1574/"

    [[rule.threat.technique.subtechnique]]
    name = "Dynamic Linker Hijacking"
    id = "T1574.006"
    reference = "https://attack.mitre.org/techniques/T1574/006/"
