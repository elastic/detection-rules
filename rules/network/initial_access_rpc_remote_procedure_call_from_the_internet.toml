[metadata]
creation_date = "2020/02/18"
integration = ["network_traffic", "panw"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
This rule detects network events that may indicate the use of RPC traffic from the Internet. RPC is commonly used by
system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be
directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or
backdoor vector.
"""
from = "now-9m"
index = ["packetbeat-*", "auditbeat-*", "filebeat-*", "logs-network_traffic.*", "logs-panw.panos*"]
language = "kuery"
license = "Elastic License v2"
name = "RPC (Remote Procedure Call) from the Internet"
references = ["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"]
risk_score = 73
rule_id = "143cb236-0956-4f42-a706-814bcaa0cf5a"
severity = "high"
tags = ["Tactic: Initial Access", "Domain: Endpoint", "Use Case: Threat Detection", "Data Source: PAN-OS"]
timestamp_override = "event.ingested"
type = "query"

query = '''
(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and
  network.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) and
  not source.ip:(
    10.0.0.0/8 or
    127.0.0.0/8 or
    169.254.0.0/16 or
    172.16.0.0/12 or
    192.0.0.0/24 or
    192.0.0.0/29 or
    192.0.0.8/32 or
    192.0.0.9/32 or
    192.0.0.10/32 or
    192.0.0.170/32 or
    192.0.0.171/32 or
    192.0.2.0/24 or
    192.31.196.0/24 or
    192.52.193.0/24 or
    192.168.0.0/16 or
    192.88.99.0/24 or
    224.0.0.0/4 or
    100.64.0.0/10 or
    192.175.48.0/24 or
    198.18.0.0/15 or
    198.51.100.0/24 or
    203.0.113.0/24 or
    240.0.0.0/4 or
    "::1" or
    "FE80::/10" or
    "FF00::/8"
  ) and
  destination.ip:(
    10.0.0.0/8 or
    172.16.0.0/12 or
    192.168.0.0/16
  )
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating RPC (Remote Procedure Call) from the Internet

RPC allows systems to execute code on remote machines, facilitating administrative tasks and resource sharing. However, when exposed to the Internet, it becomes a target for attackers seeking initial access or backdoor entry. The detection rule identifies suspicious RPC traffic by monitoring TCP port 135 and filtering out internal IP addresses, focusing on potential threats from external sources.

### Possible investigation steps

- Review the alert details to confirm the source IP address is external and not part of the excluded internal IP ranges specified in the detection rule.
- Verify the destination IP address to ensure it belongs to your internal network, as specified in the detection rule.
- Check historical logs for any previous RPC traffic from the same external IP address to identify patterns or repeated attempts.
- Analyze the network traffic flow data to determine the volume and frequency of RPC requests from the external source.
- Use packet capture tools to inspect the payload of the suspicious RPC traffic for any signs of malicious activity or anomalies.
- Cross-reference the external IP address with threat intelligence databases to check for any known malicious activity associated with it.
- Investigate the destination host to determine if it has any vulnerabilities or misconfigurations that could be exploited via RPC.
- Utilize Osquery to gather more information about the destination host. For example, run the following Osquery query to list active network connections and identify any unusual or unauthorized connections:
  ```sql
  SELECT * FROM process_open_sockets WHERE remote_address = '<external_ip>';
  ```
- Check for any recent changes or updates on the destination host that might have inadvertently exposed RPC services to the Internet.
- Collaborate with the system administrators to verify if there is a legitimate reason for RPC traffic from the Internet and document any findings or anomalies for further analysis.

### False positive analysis

- **Internal Misconfigurations**: Sometimes, internal systems may be misconfigured to route traffic through external IPs, triggering false positives. Ensure network configurations are correct and internal traffic is not mistakenly flagged as external.
- **Third-Party Services**: Certain legitimate third-party services might use RPC over the Internet for valid reasons, such as remote management or monitoring. Identify these services and create exceptions for their IP addresses to prevent false alerts.
- **VPN and Proxy Usage**: Users connecting through VPNs or proxies might appear as external sources. Verify if the flagged IPs belong to known VPN or proxy services and consider excluding them if they are part of regular operations.
- **Cloud-Based Resources**: Cloud environments might have public-facing IPs that are used for internal communications. Review cloud configurations and whitelist known IP ranges that are part of your cloud infrastructure.
- **Testing and Development Environments**: Traffic from testing or development environments might mimic suspicious patterns. Document these environments and exclude their IPs from the rule to avoid unnecessary alerts.
- **Regular Audits**: Conduct regular audits of the exceptions list to ensure that only legitimate and necessary exclusions are maintained, reducing the risk of overlooking genuine threats.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or lateral movement.
- Conduct a thorough investigation to determine the scope of the intrusion, focusing on identifying any unauthorized access or changes made to the system.
- Review logs and network traffic to identify the source of the RPC traffic and any other potentially malicious activity.
- Apply patches and updates to the affected system and any other vulnerable systems to mitigate the exploited vulnerability.
- Change all passwords and credentials that may have been compromised during the incident.
- Restore the system from a known good backup if unauthorized changes or malware are detected.
- Implement network segmentation to limit exposure of critical systems and services to the Internet.
- Enhance logging and monitoring to include detailed records of RPC traffic and other critical services for future investigations.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to improve detection and response capabilities.
- Conduct a post-incident review to identify gaps in security controls and update incident response plans accordingly."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1190"
name = "Exploit Public-Facing Application"
reference = "https://attack.mitre.org/techniques/T1190/"


[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

