[metadata]
creation_date = "2020/02/18"
integration = ["network_traffic", "panw"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
This rule detects network events that may indicate the use of RDP traffic from the Internet. RDP is commonly used by
system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be
directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or
backdoor vector.
"""
false_positives = [
    """
    Some network security policies allow RDP directly from the Internet but usage that is unfamiliar to server or
    network owners can be unexpected and suspicious. RDP services may be exposed directly to the Internet in some
    networks such as cloud environments. In such cases, only RDP gateways, bastions or jump servers may be expected
    expose RDP directly to the Internet and can be exempted from this rule. RDP may be required by some work-flows such
    as remote access and support for specialized software products and servers. Such work-flows are usually known and
    not unexpected.
    """,
]
from = "now-9m"
index = ["packetbeat-*", "auditbeat-*", "filebeat-*", "logs-network_traffic.*", "logs-panw.panos*"]
language = "kuery"
license = "Elastic License v2"
name = "RDP (Remote Desktop Protocol) from the Internet"
references = ["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"]
risk_score = 47
rule_id = "8c1bdde8-4204-45c0-9e0c-c85ca3902488"
severity = "medium"
tags = ["Tactic: Command and Control", "Domain: Endpoint", "Use Case: Threat Detection", "Data Source: PAN-OS"]
timeline_id = "300afc76-072d-4261-864d-4149714bf3f1"
timeline_title = "Comprehensive Network Timeline"
timestamp_override = "event.ingested"
type = "query"

query = '''
(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and
  network.transport:tcp and (destination.port:3389 or event.dataset:zeek.rdp) and
  not source.ip:(
    10.0.0.0/8 or
    127.0.0.0/8 or
    169.254.0.0/16 or
    172.16.0.0/12 or
    192.0.0.0/24 or
    192.0.0.0/29 or
    192.0.0.8/32 or
    192.0.0.9/32 or
    192.0.0.10/32 or
    192.0.0.170/32 or
    192.0.0.171/32 or
    192.0.2.0/24 or
    192.31.196.0/24 or
    192.52.193.0/24 or
    192.168.0.0/16 or
    192.88.99.0/24 or
    224.0.0.0/4 or
    100.64.0.0/10 or
    192.175.48.0/24 or
    198.18.0.0/15 or
    198.51.100.0/24 or
    203.0.113.0/24 or
    240.0.0.0/4 or
    "::1" or
    "FE80::/10" or
    "FF00::/8"
  ) and
  destination.ip:(
    10.0.0.0/8 or
    172.16.0.0/12 or
    192.168.0.0/16
  )
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating RDP (Remote Desktop Protocol) from the Internet

RDP enables remote access to systems, facilitating administrative tasks and resource sharing. However, when exposed to the internet, it becomes a target for attackers seeking unauthorized access. Adversaries exploit RDP for initial access or persistence. The detection rule identifies suspicious RDP traffic by monitoring TCP connections on port 3389 from non-private IPs, flagging potential threats.

### Possible investigation steps

- Review the alert details to confirm the source IP address is indeed from a non-private range, as specified in the query, and verify if it is known or expected to access the network.
- Check historical logs for any previous connections from the same source IP to determine if this is a recurring event or a new occurrence.
- Analyze the destination IP address within the private range to identify the specific system being accessed and determine its role and importance within the network.
- Investigate the user accounts associated with the RDP session to ensure they are legitimate and authorized to access the system remotely.
- Utilize Osquery to gather more information about the RDP service on the destination machine. For example, run the following query to list active RDP sessions: `SELECT * FROM logged_in_users WHERE tty = 'rdp-tcp';`
- Examine the network traffic logs for any unusual patterns or anomalies around the time of the alert, such as large data transfers or connections to other suspicious IP addresses.
- Cross-reference the alert with any recent changes or updates to the system or network configuration that might explain the RDP exposure.
- Check for any other security alerts or incidents involving the same source or destination IP addresses to identify potential patterns or coordinated attacks.
- Review the system's security settings and logs for any signs of compromise, such as unauthorized changes to firewall rules or user account settings.
- Consult threat intelligence sources to determine if the source IP address or any related indicators are associated with known malicious activity or threat actors.

### False positive analysis

- **Internal Testing and Monitoring**: Organizations may conduct legitimate RDP sessions from external IPs for testing or monitoring purposes. To manage this, users can create exceptions for known IP addresses used by their IT or security teams.
- **Third-Party Vendors**: Some businesses rely on third-party vendors for remote support or maintenance, which may involve RDP access from external IPs. Users should whitelist the IP addresses of trusted vendors to prevent false positives.
- **Remote Workforce**: Employees working remotely might use RDP to access internal resources. If these connections are from known and secure locations, their IPs can be added to an exception list.
- **Cloud Services**: Connections from cloud service providers might be flagged if they are not part of the internal network. Users should identify and exclude IP ranges associated with their cloud services to avoid false alerts.
- **VPN Misconfigurations**: If a VPN is not properly configured, RDP traffic might appear to originate from an external IP. Ensuring correct VPN setup and excluding known VPN IPs can help mitigate this issue.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access.
- Verify the alert by checking logs and network traffic to confirm the presence of unauthorized RDP connections.
- Change all passwords associated with the affected system and any accounts that may have been compromised.
- Conduct a thorough investigation to identify the source of the unauthorized access and any potential lateral movement within the network.
- Remove any unauthorized users or backdoors that may have been installed by the attacker.
- Restore the system from a known good backup to ensure no malicious software remains.
- Implement network segmentation to limit RDP access to only necessary internal IP addresses.
- Enable and configure logging for RDP access attempts and integrate with a Security Information and Event Management (SIEM) system for real-time monitoring.
- Apply security patches and updates to the affected system and ensure all systems are regularly updated.
- Review and update firewall rules to block RDP traffic from the internet and consider using a VPN for secure remote access."""


[[rule.threat]]
framework = "MITRE ATT&CK"

[rule.threat.tactic]
id = "TA0011"
name = "Command and Control"
reference = "https://attack.mitre.org/tactics/TA0011/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1021"
name = "Remote Services"
reference = "https://attack.mitre.org/techniques/T1021/"


[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1190"
name = "Exploit Public-Facing Application"
reference = "https://attack.mitre.org/techniques/T1190/"


[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

