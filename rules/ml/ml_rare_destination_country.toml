[metadata]
creation_date = "2021/04/05"
integration = ["endpoint", "network_traffic"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
anomaly_threshold = 75
author = ["Elastic"]
description = """
A machine learning job detected a rare destination country name in the network logs. This can be due to initial access,
persistence, command-and-control, or exfiltration activity. For example, when a user clicks on a link in a phishing
email or opens a malicious document, a request may be sent to download and run a payload from a server in a country
which does not normally appear in network traffic or business work-flows. Malware instances and persistence mechanisms
may communicate with command-and-control (C2) infrastructure in their country of origin, which may be an unusual
destination country for the source network.
"""
false_positives = [
    """
    Business workflows that occur very occasionally, and involve a business relationship with an organization in a
    country that does not routinely appear in network events, can trigger this alert. A new business workflow with an
    organization in a country with which no workflows previously existed may trigger this alert - although the model
    will learn that the new destination country is no longer anomalous as the activity becomes ongoing. Business
    travelers who roam to many countries for brief periods may trigger this alert.
    """,
]
from = "now-30m"
interval = "15m"
license = "Elastic License v2"
machine_learning_job_id = "rare_destination_country"
name = "Network Traffic to Rare Destination Country"
setup = """## Setup

This rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:
- Elastic Defend
- Network Packet Capture

### Anomaly Detection Setup

Once the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the "Definition" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration to your system:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).

### Network Packet Capture Integration Setup
The Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment — ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.

#### The following steps should be executed in order to add the Elastic Agent System integration "network_traffic" to your system:
- Go to the Kibana home page and click “Add integrations”.
- In the query bar, search for “Network Packet Capture” and select the integration to see more details about it.
- Click “Add Network Packet Capture”.
- Configure the integration name and optionally add a description.
- Review optional and advanced settings accordingly.
- Add the newly installed “network_traffic” to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.
- Click “Save and Continue”.
- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).
"""
references = ["https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"]
risk_score = 21
rule_id = "35f86980-1fb1-4dff-b311-3be941549c8d"
severity = "low"
tags = ["Use Case: Threat Detection", "Rule Type: ML", "Rule Type: Machine Learning"]
type = "machine_learning"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Network Traffic to Rare Destination Country

The detection of network traffic to uncommon destination countries leverages machine learning to identify anomalies in network logs. Adversaries exploit this by directing traffic to servers in atypical locations for activities like data exfiltration or command-and-control communication. This detection rule flags such anomalies, helping analysts investigate potential threats that deviate from normal business operations.

### Possible investigation steps

- Review the alert details to identify the rare destination country and the associated network traffic logs.
- Examine the source IP address and user account involved in the alert to determine if they are legitimate and expected within the network.
- Check historical network logs to see if there have been previous connections to the same destination country from the same source IP or user account.
- Analyze the time and frequency of the connections to the rare destination country to identify any patterns or anomalies.
- Investigate the domain or IP address of the destination server to determine if it is associated with known malicious activity or threat actors.
- Use Osquery to gather additional context on the source machine. For example, run the following query to list recent network connections: `SELECT * FROM process_open_sockets WHERE remote_address = '<destination IP>';`
- Correlate the network traffic with other security events, such as endpoint detection alerts, to identify any related suspicious activities.
- Check for any recent changes or unusual behavior in the user account or device associated with the alert, such as new software installations or configuration changes.
- Consult threat intelligence sources to gather information on the rare destination country and any known threats or campaigns targeting that region.
- Document all findings and observations to build a comprehensive understanding of the potential threat and to assist in further analysis or escalation if necessary.

### False positive analysis

- Legitimate business operations may occasionally involve communication with servers in rare destination countries, such as when a company expands its operations internationally or engages with new global partners. These activities can trigger false positives.
- Automated software updates or cloud services might route traffic through servers located in uncommon countries, leading to benign alerts.
- Employees traveling internationally and accessing company resources from unusual locations can also result in false positives.
- To manage these false positives, users can create exceptions for known and verified business activities that involve rare destination countries, ensuring these are documented and regularly reviewed.
- Implementing a whitelist of trusted IP addresses or domains associated with legitimate services and partners can help reduce unnecessary alerts.
- Regularly updating the list of known business-related destinations and incorporating feedback from network analysts can further refine the detection rule and minimize false positives.

### Response and remediation

- Immediately isolate the affected systems from the network to prevent further data exfiltration or communication with command-and-control servers.
- Conduct a thorough investigation of the network logs to identify the scope of the anomaly and determine if other systems are affected.
- Analyze the network traffic to the rare destination country to understand the nature of the communication and identify any malicious payloads or commands.
- Review user activity and access logs to identify any unauthorized access or suspicious behavior that may have led to the anomaly.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and action.
- Implement enhanced logging policies to capture detailed network traffic data, including destination IP addresses and geolocation information, for future investigations.
- Integrate threat intelligence feeds to correlate the detected anomaly with known threat actors or campaigns targeting similar organizations.
- Restore affected systems to their operational state by removing any malicious software and applying necessary security patches.
- Conduct a post-incident review to identify gaps in the current security posture and implement hardening measures, such as network segmentation and stricter access controls.
- Update security awareness training for employees to recognize phishing attempts and other social engineering tactics that could lead to similar incidents."""

