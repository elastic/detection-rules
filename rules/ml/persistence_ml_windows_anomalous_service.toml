[metadata]
creation_date = "2020/03/25"
integration = ["endpoint", "windows"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
anomaly_threshold = 50
author = ["Elastic"]
description = """
A machine learning job detected an unusual Windows service, This can indicate execution of unauthorized services,
malware, or persistence mechanisms. In corporate Windows environments, hosts do not generally run many rare or unique
services. This job helps detect malware and persistence mechanisms that have been installed and run as a service.
"""
false_positives = [
    """
    A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this
    alert.
    """,
]
from = "now-45m"
interval = "15m"
license = "Elastic License v2"
machine_learning_job_id = ["v3_windows_anomalous_service"]
name = "Unusual Windows Service"
setup = """## Setup

This rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:
- Elastic Defend
- Windows

### Anomaly Detection Setup

Once the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the "Definition" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration to your system:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).

### Windows Integration Setup
The Windows integration allows you to monitor the Windows OS, services, applications, and more.

#### The following steps should be executed in order to add the Elastic Agent System integration "windows" to your system:
- Go to the Kibana home page and click “Add integrations”.
- In the query bar, search for “Windows” and select the integration to see more details about it.
- Click “Add Windows”.
- Configure the integration name and optionally add a description.
- Review optional and advanced settings accordingly.
- Add the newly installed “windows” to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.
- Click “Save and Continue”.
- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).
"""
references = ["https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"]
risk_score = 21
rule_id = "1781d055-5c66-4adf-9c71-fc0fa58338c7"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Rule Type: ML",
    "Rule Type: Machine Learning",
    "Tactic: Persistence",
]
type = "machine_learning"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Unusual Windows Service
Windows services are crucial for running background processes and applications. Adversaries exploit this by creating or modifying services to maintain persistence or execute unauthorized actions. The 'Unusual Windows Service' detection rule leverages machine learning to identify atypical services, flagging potential threats by comparing against known service baselines, thus aiding in early detection of malicious activities.

### Possible investigation steps

- Review the alert details to identify the specific service name, service path, and the host where the unusual service was detected.
- Check the service's creation or modification timestamp to determine when the service was installed or altered.
- Investigate the service's executable path to verify its legitimacy and check for any known malicious file signatures or hashes.
- Use Osquery to gather additional information about the service with a query like: `SELECT name, display_name, path, start_type, status FROM services WHERE name = '<service_name>';` to confirm its current state and configuration.
- Cross-reference the service name and executable path against known good baselines or whitelists to identify any deviations.
- Examine the parent process that created or modified the service to understand the context of its creation.
- Analyze the user account under which the service is running to determine if it has the necessary privileges and if the account has been compromised.
- Review recent system and security logs on the affected host for any related suspicious activities or anomalies around the time the service was created or modified.
- Check for any network connections initiated by the service to identify potential command and control communication or data exfiltration.
- Consult threat intelligence sources to see if the service name, path, or associated file hashes have been reported in any recent threat campaigns or advisories.

### False positive analysis

- Known false positives for the Unusual Windows Service rule often include legitimate software updates or installations that create temporary services, as well as custom in-house applications that are not widely recognized by the machine learning model.
- To manage these false positives, users can create exceptions for specific services that are known to be safe and frequently appear in their environment. This can be done by maintaining a whitelist of approved services or by configuring the detection rule to ignore certain service names or patterns.
- It's important to regularly review and update the list of exceptions to ensure that new legitimate services are not mistakenly flagged as threats, while also ensuring that the list does not become overly permissive, which could allow actual threats to go undetected.
- Users should also consider the context of the flagged service, such as the time of day it was created or modified, the user account associated with the change, and any related network activity, to better assess whether it is a false positive or a potential threat.

### Response and remediation

- Isolate the affected system from the network to prevent further spread of potential malware or unauthorized services.
- Conduct a thorough investigation of the unusual service, including its origin, purpose, and any associated files or processes.
- Review system logs and security alerts to identify any additional indicators of compromise or related suspicious activities.
- Remove or disable the unauthorized service and any associated files or registry entries to eliminate the threat.
- Restore the system from a known good backup if the integrity of the system is in question.
- Escalate the incident to the security operations team or incident response team for further analysis and to determine if additional systems are affected.
- Implement enhanced logging policies to capture detailed information on service creation and modification activities for future investigations.
- Integrate threat intelligence feeds and endpoint detection and response (EDR) solutions to improve detection capabilities and provide context for unusual service activities.
- Apply security patches and updates to the operating system and applications to mitigate vulnerabilities that could be exploited by similar threats.
- Conduct a post-incident review to identify gaps in security controls and update security policies and procedures to prevent recurrence."""
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1543"
name = "Create or Modify System Process"
reference = "https://attack.mitre.org/techniques/T1543/"
[[rule.threat.technique.subtechnique]]
id = "T1543.003"
name = "Windows Service"
reference = "https://attack.mitre.org/techniques/T1543/003/"



[rule.threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"

