[metadata]
creation_date = "2020/03/25"
integration = ["auditd_manager", "endpoint"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
anomaly_threshold = 50
author = ["Elastic"]
description = """
A machine learning job detected an unusual network destination domain name. This can be due to initial access,
persistence, command-and-control, or exfiltration activity. For example, when a user clicks on a link in a phishing
email or opens a malicious document, a request may be sent to download and run a payload from an uncommon web server
name. When malware is already running, it may send requests to an uncommon DNS domain the malware uses for
command-and-control communication.
"""
false_positives = [
    """
    Web activity that occurs rarely in small quantities can trigger this alert. Possible examples are browsing technical
    support or vendor URLs that are used very sparsely. A user who visits a new and unique web destination may trigger
    this alert when the activity is sparse. Web applications that generate URLs unique to a transaction may trigger this
    when they are used sparsely. Web domains can be excluded in cases such as these.
    """,
]
from = "now-45m"
interval = "15m"
license = "Elastic License v2"
machine_learning_job_id = "packetbeat_rare_server_domain"
name = "Unusual Network Destination Domain Name"
setup = """## Setup

This rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:
- Elastic Defend
- Auditd Manager

### Anomaly Detection Setup

Once the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the "Definition" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration to your system:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).

### Auditd Manager Integration Setup
The Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.
Auditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.

#### The following steps should be executed in order to add the Elastic Agent System integration "auditd_manager" to your system:
- Go to the Kibana home page and click “Add integrations”.
- In the query bar, search for “Auditd Manager” and select the integration to see more details about it.
- Click “Add Auditd Manager”.
- Configure the integration name and optionally add a description.
- Review optional and advanced settings accordingly.
- Add the newly installed “auditd manager” to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.
- Click “Save and Continue”.
- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).

#### Rule Specific Setup Note
Auditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.
However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the "audit rules" configuration box or the "auditd rule files" box by specifying a file to read the audit rules from.
- For this detection rule no additional audit rules are required.
"""
references = ["https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"]
risk_score = 21
rule_id = "17e68559-b274-4948-ad0b-f8415bb31126"
severity = "low"
tags = ["Use Case: Threat Detection", "Rule Type: ML", "Rule Type: Machine Learning"]
type = "machine_learning"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Unusual Network Destination Domain Name

Machine learning models analyze network traffic to identify domain names that deviate from typical patterns, flagging potential threats. Adversaries exploit this by using rare domains for malicious activities like phishing or command-and-control. The detection rule identifies these anomalies, alerting analysts to investigate potential security incidents.

### Possible investigation steps

- Review the alert details to identify the unusual domain name and the associated network activity, including timestamps and source IP addresses.
- Cross-reference the unusual domain name with threat intelligence databases to check for any known associations with malicious activities.
- Analyze the network traffic logs to determine the volume and frequency of requests to the unusual domain, looking for patterns that may indicate automated or scripted activity.
- Investigate the source IP address to identify the device or user responsible for the network request, using asset management systems or endpoint detection and response (EDR) tools.
- Use Osquery to gather additional context from the affected endpoint. For example, run the following query to list recent DNS queries made by the device: `SELECT name, COUNT(name) AS query_count FROM dns_queries GROUP BY name ORDER BY query_count DESC LIMIT 10;`
- Check the endpoint's process execution logs to identify any suspicious processes that may have initiated the network request to the unusual domain.
- Examine user activity logs to determine if the user associated with the source IP address engaged in any unusual behavior, such as clicking on phishing links or downloading suspicious files.
- Review email logs for the user to identify any recent phishing attempts that may have led to the network request to the unusual domain.
- Analyze any related alerts or incidents in the security information and event management (SIEM) system to identify potential correlations or patterns with other suspicious activities.
- Consult with other analysts or teams to gather additional insights or context that may aid in understanding the significance of the unusual domain name and its potential impact.

### False positive analysis

- Legitimate business applications or services may use uncommon domain names for updates or communication, leading to false positives. Users should verify the domain's legitimacy and consider adding it to an allowlist if it is deemed safe.
- Newly registered domains for legitimate purposes, such as marketing campaigns or new product launches, might trigger alerts. Users can monitor these domains for a period to ensure they are not associated with malicious activity before excluding them.
- Internal development or testing environments often use unique domain names that could be flagged. Users should document these environments and exclude their domains from the detection rule to prevent unnecessary alerts.
- Third-party services or APIs that are not widely recognized might be misidentified as threats. Users should confirm the service's authenticity and functionality, then create exceptions for these domains if they are verified as non-threatening.
- Temporary or one-time use domains for legitimate purposes, such as event registrations or surveys, may cause false positives. Users should assess the context and frequency of access to these domains and exclude them if they are determined to be safe.

### Response and remediation

- Isolate the affected system from the network to prevent further communication with the suspicious domain.
- Conduct a thorough investigation of the system to identify any malicious processes or files, focusing on indicators of initial access, persistence, command-and-control, or exfiltration activities.
- Analyze network logs and DNS queries to determine the scope of the incident and identify any other systems that may have communicated with the unusual domain.
- Remove any identified malware or unauthorized software from the affected system and ensure all security patches are up to date.
- Change passwords and credentials that may have been compromised during the incident.
- Escalate the incident to the security operations center (SOC) or incident response team if the threat appears to be part of a larger attack campaign.
- Implement enhanced logging and monitoring policies to capture detailed network and DNS activity for future investigations.
- Integrate threat intelligence feeds to improve detection of rare or suspicious domains in real-time.
- Restore the system to its operational state by verifying the integrity of critical files and applications, and ensure all security measures are re-enabled.
- Apply system hardening measures, such as disabling unnecessary services and enforcing least privilege access, to reduce the attack surface and prevent future incidents."""

