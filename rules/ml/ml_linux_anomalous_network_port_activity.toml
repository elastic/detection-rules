[metadata]
creation_date = "2020/03/25"
integration = ["auditd_manager", "endpoint"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
anomaly_threshold = 50
author = ["Elastic"]
description = """
Identifies unusual destination port activity that can indicate command-and-control, persistence mechanism, or data
exfiltration activity. Rarely used destination port activity is generally unusual in Linux fleets, and can indicate
unauthorized access or threat actor activity.
"""
false_positives = ["A newly installed program or one that rarely uses the network could trigger this alert."]
from = "now-45m"
interval = "15m"
license = "Elastic License v2"
machine_learning_job_id = ["v3_linux_anomalous_network_port_activity"]
name = "Unusual Linux Network Port Activity"
setup = """## Setup

This rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:
- Elastic Defend
- Auditd Manager

### Anomaly Detection Setup

Once the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the "Definition" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration to your system:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).

### Auditd Manager Integration Setup
The Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.
Auditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.

#### The following steps should be executed in order to add the Elastic Agent System integration "auditd_manager" to your system:
- Go to the Kibana home page and click “Add integrations”.
- In the query bar, search for “Auditd Manager” and select the integration to see more details about it.
- Click “Add Auditd Manager”.
- Configure the integration name and optionally add a description.
- Review optional and advanced settings accordingly.
- Add the newly installed “auditd manager” to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.
- Click “Save and Continue”.
- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).

#### Rule Specific Setup Note
Auditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.
However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the "audit rules" configuration box or the "auditd rule files" box by specifying a file to read the audit rules from.
- For this detection rule no additional audit rules are required.
"""
references = ["https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"]
risk_score = 21
rule_id = "3c7e32e6-6104-46d9-a06e-da0f8b5795a0"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Rule Type: ML",
    "Rule Type: Machine Learning",
]
type = "machine_learning"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Unusual Linux Network Port Activity

In Linux environments, network ports facilitate communication between applications and services. Adversaries may exploit rarely used ports for malicious activities like command-and-control or data exfiltration, bypassing standard monitoring. The 'Unusual Linux Network Port Activity' detection rule identifies anomalies in port usage, flagging potential unauthorized access or threat actor presence by focusing on atypical destination port activity.

### Possible investigation steps

- Review the alert details to identify the specific destination port and source IP address involved in the unusual activity.
- Check historical logs to determine if the destination port has been used previously and if so, assess the frequency and context of its usage.
- Correlate the source IP address with known assets or users within the organization to determine if the activity aligns with expected behavior.
- Use Osquery to gather additional context on the host involved. For example, run the following query to list active network connections and identify processes using the unusual port:
  ```sql
  SELECT pid, name, local_address, local_port, remote_address, remote_port FROM process_open_sockets WHERE local_port = <unusual_port>;
  ```
- Investigate the process identified in the previous step to determine its legitimacy by checking its executable path, hash, and associated user.
- Analyze network traffic logs to identify any patterns or anomalies associated with the unusual port, such as repeated connections or data transfers.
- Cross-reference the unusual port activity with threat intelligence feeds to check for known malicious indicators or patterns.
- Examine system logs for any signs of compromise or suspicious activity around the time the unusual port activity was detected.
- Verify if there are any recent changes or deployments on the host that could explain the unusual port activity, such as new software installations or updates.
- Consult with relevant teams or personnel to gather additional context or insights regarding the unusual port activity, ensuring a comprehensive understanding of the situation.

### False positive analysis

- Known false positives may include legitimate applications or services that use non-standard ports for communication, such as custom internal tools or legacy systems that have not been updated to use standard ports.
- Automated backup or monitoring solutions might use unusual ports for data transfer, which can trigger alerts if not properly documented or excluded.
- Development and testing environments often experiment with different port configurations, leading to benign anomalies in port usage.
- To manage these false positives, users can create exceptions for known and verified applications or services that consistently use specific non-standard ports.
- Regularly review and update the list of exceptions to ensure that only legitimate activities are excluded, maintaining the effectiveness of the detection rule.
- Collaborate with network and system administrators to document and understand the purpose of unusual port usage within the organization, reducing unnecessary alerts.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
- Conduct a thorough investigation of the unusual port activity by reviewing network logs and identifying the source and destination of the traffic.
- Verify the legitimacy of the process or application using the unusual port by cross-referencing with known software and services.
- If malicious activity is confirmed, terminate any suspicious processes and remove any unauthorized software or scripts.
- Escalate the incident to the security operations team for further analysis and to determine if the activity is part of a larger attack campaign.
- Implement enhanced logging policies to capture detailed network traffic and system events for future analysis and detection.
- Integrate threat intelligence feeds and anomaly detection tools to improve the identification of unusual network activities.
- Restore the system to its operational state by applying the latest security patches and updates, and ensure all security configurations are correctly set.
- Conduct a post-incident review to identify gaps in the current security posture and update incident response plans accordingly.
- Implement network segmentation and access controls to limit the exposure of critical systems and reduce the risk of similar incidents in the future."""

