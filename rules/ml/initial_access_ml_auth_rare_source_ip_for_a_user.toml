[metadata]
creation_date = "2021/06/10"
integration = ["auditd_manager", "endpoint", "system"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
anomaly_threshold = 75
author = ["Elastic"]
description = """
A machine learning job detected a user logging in from an IP address that is unusual for the user. This can be due to
credentialed access via a compromised account when the user and the threat actor are in different locations. An unusual
source IP address for a username could also be due to lateral movement when a compromised account is used to pivot
between hosts.
"""
false_positives = ["Business travelers who roam to new locations may trigger this alert."]
from = "now-30m"
interval = "15m"
license = "Elastic License v2"
machine_learning_job_id = "auth_rare_source_ip_for_a_user"
name = "Unusual Source IP for a User to Logon from"
setup = """## Setup

This rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:
- Elastic Defend
- Auditd Manager
- System

### Anomaly Detection Setup

Once the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the "Definition" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration to your system:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).

### Auditd Manager Integration Setup
The Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.
Auditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.

#### The following steps should be executed in order to add the Elastic Agent System integration "auditd_manager" to your system:
- Go to the Kibana home page and click “Add integrations”.
- In the query bar, search for “Auditd Manager” and select the integration to see more details about it.
- Click “Add Auditd Manager”.
- Configure the integration name and optionally add a description.
- Review optional and advanced settings accordingly.
- Add the newly installed “auditd manager” to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.
- Click “Save and Continue”.
- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).

#### Rule Specific Setup Note
Auditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.
However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the "audit rules" configuration box or the "auditd rule files" box by specifying a file to read the audit rules from.
- For this detection rule no additional audit rules are required.

### System Integration Setup
The System integration allows you to collect system logs and metrics from your servers with Elastic Agent.

#### The following steps should be executed in order to add the Elastic Agent System integration "system" to your system:
- Go to the Kibana home page and click “Add integrations”.
- In the query bar, search for “System” and select the integration to see more details about it.
- Click “Add System”.
- Configure the integration name and optionally add a description.
- Review optional and advanced settings accordingly.
- Add the newly installed “system” to an existing or a new agent policy, and deploy the agent on your system from which system log files are desirable.
- Click “Save and Continue”.
- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/system).
"""
references = ["https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"]
risk_score = 21
rule_id = "d4b73fa0-9d43-465e-b8bf-50230da6718b"
severity = "low"
tags = [
    "Use Case: Identity and Access Audit",
    "Use Case: Threat Detection",
    "Rule Type: ML",
    "Rule Type: Machine Learning",
    "Tactic: Initial Access",
]
type = "machine_learning"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Unusual Source IP for a User to Logon from

Machine learning models analyze login patterns to identify atypical IP addresses for users, flagging potential threats like compromised accounts or lateral movement. Adversaries exploit valid credentials to access systems from unexpected locations. This detection rule leverages these models to alert analysts to suspicious logins, aiding in early threat identification and response.

### Possible investigation steps

- Review the alert details to identify the unusual source IP address and the associated user account.
- Check the login history for the user to determine if the IP address has been used previously and assess the frequency of its occurrence.
- Correlate the unusual IP address with known threat intelligence sources to check if it has been associated with malicious activity.
- Analyze the geolocation of the unusual IP address to determine if it aligns with the user's typical login locations or if it is from a high-risk region.
- Investigate the time of the login event to see if it coincides with the user's normal working hours or if it is an anomaly.
- Use Osquery to gather additional context on the endpoint from which the login was attempted. Example query: `SELECT * FROM logged_in_users WHERE user = '<username>';`
- Examine any recent changes in the user's account permissions or group memberships that could indicate unauthorized access.
- Review any concurrent login attempts from different locations for the same user, which could suggest account compromise.
- Check for any recent password changes or failed login attempts for the user account that could indicate a brute force attack.
- Investigate any other security alerts or logs related to the user or the unusual IP address to identify potential patterns or related incidents.

### False positive analysis

- Known false positives for the "Unusual Source IP for a User to Logon from" rule can occur when users travel or work remotely, leading to logins from legitimate but previously unseen IP addresses. 
- Another common false positive scenario is when users access systems through VPNs or proxy services, which can result in logins from IP addresses that differ from their usual patterns.
- To manage these false positives, users can create exceptions for known and verified IP addresses associated with frequent travel destinations or remote work locations.
- Implementing a whitelist for IP addresses associated with trusted VPN or proxy services can help reduce unnecessary alerts.
- Regularly updating the list of approved IP addresses based on user travel patterns and organizational changes can further minimize false positives.
- Analysts should review and validate the context of flagged logins, considering factors like time of access and user activity, to distinguish between legitimate and suspicious behavior.

### Response and remediation

- Immediately isolate the affected user account by disabling it to prevent further unauthorized access.
- Conduct a thorough investigation to determine the scope of the breach, including identifying any other compromised accounts or systems.
- Analyze the unusual IP address to gather intelligence on its origin and any associated malicious activity.
- Review recent login activity for the affected user and other users to identify any patterns or additional suspicious logins.
- Reset passwords for the compromised account and any other accounts that may have been affected, ensuring the use of strong, unique passwords.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging and monitoring policies to capture detailed login events and network activity for future investigations.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to improve detection capabilities.
- Restore the system to its operational state by ensuring all compromised accounts are secured and any malicious software is removed.
- Apply hardening measures such as multi-factor authentication (MFA) and least privilege access to reduce the risk of future incidents."""
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"


[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

