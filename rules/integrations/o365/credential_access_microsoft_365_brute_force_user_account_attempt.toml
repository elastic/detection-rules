[metadata]
creation_date = "2020/11/30"
integration = ["o365"]
maturity = "production"
min_stack_comments = "ES|QL not available until 8.13.0 in technical preview."
min_stack_version = "8.13.0"
updated_date = "2025/01/08"

[rule]
author = ["Elastic", "Willem D'Haese", "Austin Songer"]
description = """
Identifies potential brute-force attempts against Microsoft 365 user accounts by detecting a high number of failed login attempts or login sources within a 30-minute window. Attackers may attempt to brute force user accounts to gain unauthorized access to Microsoft 365 services.
"""
false_positives = [
    """
    Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false
    positives.
    """,
]
from = "now-9m"
language = "esql"
license = "Elastic License v2"
name = "Attempts to Brute Force a Microsoft 365 User Account"
references = [
    "https://blueteamblog.com/7-ways-to-monitor-your-office-365-logs-using-siem",
    "https://learn.microsoft.com/en-us/purview/audit-log-detailed-properties",
]
risk_score = 47
rule_id = "26f68dba-ce29-497b-8e13-b4fde1db5a2d"
severity = "medium"
tags = [
    "Domain: Cloud",
    "Domain: SaaS",
    "Data Source: Microsoft 365",
    "Use Case: Identity and Access Audit",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
]
timestamp_override = "event.ingested"
type = "esql"

query = '''
from logs-o365.audit-*
// truncate the timestamp to a 30-minute window
| eval target_time_window = DATE_TRUNC(30 minutes, @timestamp)
| mv_expand event.category
| where event.dataset == "o365.audit"
  and event.category == "authentication"

  // filter only on Entra ID or Exchange audit logs in O365 integration
  and event.provider in ("AzureActiveDirectory", "Exchange")

  // filter only for UserLoginFailed or partial failures
  and event.action in ("UserLoginFailed", "PasswordLogonInitialAuthUsingPassword")

  // ignore specific logon errors
  and not o365.audit.LogonError in (
    "EntitlementGrantsNotFound",
    "UserStrongAuthEnrollmentRequired",
    "UserStrongAuthClientAuthNRequired",
    "InvalidReplyTo",
    "SsoArtifactExpiredDueToConditionalAccess",
    "PasswordResetRegistrationRequiredInterrupt",
    "SsoUserAccountNotFoundInResourceTenant",
    "UserStrongAuthExpired",
    "CmsiInterrupt"
)

  // ignore unavailable
  and o365.audit.UserId != "Not Available"

  // filters out non user or application logins based on target
  and o365.audit.Target.Type in ("0", "2", "3", "5", "6", "10")

  // filters only for logins from user or application, ignoring oauth:token
  and to_lower(o365.audit.ExtendedProperties.RequestType) rlike "(.*)login(.*)"

// keep only relevant fields
| keep event.provider, event.dataset, event.category, o365.audit.UserId, event.action, source.ip, o365.audit.LogonError, o365.audit.ExtendedProperties.RequestType, o365.audit.Target.Type, target_time_window

// count the number of login sources and failed login attempts
| stats
  login_source_count = count(source.ip),
  failed_login_count = count(*) by target_time_window, o365.audit.UserId

// filter for users with more than 20 login sources or failed login attempts
| where (login_source_count >= 20 or failed_login_count >= 20)
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Attempts to Brute Force a Microsoft 365 User Account

Microsoft 365 is a cloud-based suite offering productivity and collaboration tools. Adversaries may exploit its authentication mechanisms by attempting brute-force attacks, trying numerous password combinations to gain unauthorized access. The detection rule identifies such attempts by analyzing audit logs for unusual patterns, such as a high number of failed logins or diverse login sources within a short timeframe, indicating potential brute-force activity.

### Possible investigation steps

- Review the `o365.audit.UserId` field to identify the specific user account targeted by the brute-force attempt and check for any unusual activity associated with this account.
- Examine the `source.ip` field to identify the IP addresses involved in the failed login attempts. Cross-reference these IPs with threat intelligence sources to determine if they are known for malicious activity.
- Analyze the `target_time_window` to understand the timeframe of the brute-force attempt and correlate it with other security events or alerts that occurred during the same period.
- Investigate the `event.provider` field to determine whether the brute-force attempts were made against Azure Active Directory or Exchange, which may provide insights into the attacker's target.
- Check the `o365.audit.LogonError` field to identify the specific errors encountered during the login attempts, which may indicate the attacker's method or level of access.
- Utilize the `event.action` field to confirm the nature of the failed login attempts, ensuring they align with the expected actions for a brute-force attack.
- Use Osquery to gather additional context on the affected user account. For example, run the following query to check recent login activities on the user's device:
  ```sql
  SELECT * FROM logins WHERE user = '<o365.audit.UserId>';
  ```
- Investigate the `o365.audit.ExtendedProperties.RequestType` field to determine the type of login request, which may help identify if the attacker is using a specific method or tool.
- Review the `o365.audit.Target.Type` field to understand the type of target involved in the login attempts, which can help differentiate between user and application logins.
- Correlate the findings with other security tools and logs, such as endpoint detection and response (EDR) solutions, to gather a comprehensive view of the attack and its potential impact.

### False positive analysis

- High volume of legitimate login attempts: Users or applications that frequently log in from multiple locations or devices may trigger the rule. To manage this, create exceptions for known IP addresses or user accounts that are verified as non-threatening.
- Automated scripts or services: Some organizations use automated scripts or services that log in to Microsoft 365 accounts for legitimate purposes, which may appear as brute-force attempts. Identify these scripts and whitelist their IP addresses or user accounts to prevent false positives.
- Shared accounts: Accounts used by multiple users across different locations can generate numerous login attempts from various sources. Consider implementing stricter access controls or monitoring these accounts separately to reduce false positives.
- Frequent password changes: Users who frequently change their passwords may inadvertently cause multiple failed login attempts. Educate users on best practices for password management and consider excluding these accounts from the rule if they are known to follow security protocols.
- Security testing: Internal security teams conducting penetration tests or security assessments may trigger the rule. Coordinate with these teams to whitelist their activities during testing periods to avoid false positives.

### Response and remediation

- Immediately isolate the affected user account by disabling it to prevent further unauthorized access.
- Conduct a thorough investigation of the audit logs to identify the source IP addresses involved in the brute-force attempts and block these IPs at the firewall or network level.
- Reset the password for the compromised user account and enforce a strong password policy to prevent easy guessing.
- Enable multi-factor authentication (MFA) for the affected account and other high-risk accounts to add an additional layer of security.
- Review and update conditional access policies to restrict access based on location, device compliance, and other risk factors.
- Escalate the incident to the security operations team for further analysis and to determine if other accounts or systems have been targeted.
- Implement enhanced logging and monitoring policies to capture detailed authentication events and integrate with a Security Information and Event Management (SIEM) system for real-time analysis.
- Conduct a security awareness training session for users to educate them on recognizing phishing attempts and the importance of using strong, unique passwords.
- Restore the system to its operational state by verifying that no unauthorized changes were made during the attack and ensuring all security patches are up to date.
- Harden the environment by reviewing and applying security best practices, such as disabling legacy authentication protocols and regularly reviewing access permissions."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1110"
name = "Brute Force"
reference = "https://attack.mitre.org/techniques/T1110/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

