[metadata]
creation_date = "2020/11/19"
integration = ["o365"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies when a malware filter policy has been deleted in Microsoft 365. A malware filter policy is used to alert
administrators that an internal user sent a message that contained malware. This may indicate an account or machine
compromise that would need to be investigated. Deletion of a malware filter policy may be done to evade detection.
"""
false_positives = [
    """
    A malware filter policy may be deleted by a system or network administrator. Verify that the configuration change
    was expected. Exceptions can be added to this rule to filter expected behavior.
    """,
]
from = "now-30m"
index = ["filebeat-*", "logs-o365*"]
language = "kuery"
license = "Elastic License v2"
name = "Microsoft 365 Exchange Malware Filter Policy Deletion"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Microsoft 365 Exchange Malware Filter Policy Deletion

Microsoft 365 Exchange uses malware filter policies to detect and alert administrators about emails containing malware, which helps in identifying potential account or machine compromises. Adversaries may delete these policies to bypass detection mechanisms, facilitating undetected malicious activities. The detection rule monitors audit logs for successful deletions of these policies, signaling potential defense evasion attempts.

### Possible investigation steps

- Review the audit logs for the specific event.action:"Remove-MalwareFilterPolicy" to confirm the deletion event and gather details such as the timestamp, user account involved, and the IP address from which the action was performed.
- Cross-reference the user account identified in the deletion event with recent login activity to determine if there are any unusual or suspicious login patterns, such as logins from unfamiliar locations or IP addresses.
- Investigate the event.outcome:success field to ensure that the deletion was indeed successful and not a failed attempt, which might indicate a different type of issue or misconfiguration.
- Examine the event.provider:Exchange and event.category:web fields to verify that the event is correctly categorized and associated with the Exchange service, ensuring the alert is not a false positive.
- Utilize Osquery to gather additional context on the user account involved in the deletion. For example, run a query to list recent activities by the user: `SELECT * FROM users WHERE username = 'suspected_user';`
- Check for any recent changes to permissions or roles associated with the user account to determine if they were granted elevated privileges that could have allowed the policy deletion.
- Investigate other security logs and alerts around the same timeframe to identify any correlated events or activities that might indicate a broader attack or compromise.
- Review the organization's change management records to verify if the deletion was part of an authorized change or maintenance activity, potentially ruling out malicious intent.
- Analyze email logs to identify any recent emails sent by the user account that might have contained malware, which could suggest a motive for deleting the malware filter policy.
- Consult with other security team members or stakeholders to gather additional insights or context that might aid in understanding the significance of the policy deletion and any potential impact on the organization.

### False positive analysis

- Routine administrative tasks: Legitimate IT administrators may delete malware filter policies as part of regular maintenance or policy updates. To manage this, organizations can create exceptions for known administrative accounts or schedule maintenance windows where such activities are expected.
- Policy reconfiguration: During reconfiguration or migration of policies, deletions might occur as part of the process. Users can handle these by documenting and approving such changes in advance, allowing for temporary exceptions during the reconfiguration period.
- Testing and development environments: In environments where policies are frequently created and deleted for testing purposes, these actions might trigger false positives. To mitigate this, users can exclude specific test accounts or environments from the detection rule.
- Automated scripts or tools: Some organizations use automated scripts or third-party tools to manage their Microsoft 365 environment, which might include policy deletions. Identifying and excluding these scripts or tools from the detection rule can help reduce false positives.

### Response and remediation

- Immediately isolate affected accounts or systems to prevent further malicious activity and contain the threat.
- Review audit logs and email logs to identify any other suspicious activities or policy deletions that may indicate a broader compromise.
- Conduct a thorough investigation to determine the scope of the compromise, including identifying any other compromised accounts or systems.
- Restore the deleted malware filter policy from a backup or recreate it to ensure continued protection against malware threats.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging and monitoring for Microsoft 365 Exchange to detect similar activities in the future, ensuring audit logs are retained for an appropriate duration.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to correlate events and improve detection capabilities.
- Educate users and administrators on recognizing phishing attempts and the importance of maintaining security policies.
- Apply security patches and updates to all systems and applications to mitigate vulnerabilities that could be exploited by adversaries.
- Review and strengthen access controls and permissions to ensure that only authorized personnel can modify or delete security policies.

## Setup

The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-malwarefilterpolicy?view=exchange-ps",
]
risk_score = 47
rule_id = "d743ff2a-203e-4a46-a3e3-40512cfe8fbb"
severity = "medium"
tags = [
    "Domain: Cloud",
    "Data Source: Microsoft 365",
    "Use Case: Configuration Audit",
    "Tactic: Defense Evasion",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Remove-MalwareFilterPolicy" and event.outcome:success
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1562"
name = "Impair Defenses"
reference = "https://attack.mitre.org/techniques/T1562/"


[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

