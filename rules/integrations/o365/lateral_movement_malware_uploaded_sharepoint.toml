[metadata]
creation_date = "2022/01/10"
integration = ["o365"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies the occurence of files uploaded to SharePoint being detected as Malware by the file scanning engine.
Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their
access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunities
to gain initial access to other endpoints in the environment.
"""
false_positives = ["Benign files can trigger signatures in the built-in virus protection"]
from = "now-30m"
index = ["filebeat-*", "logs-o365*"]
language = "kuery"
license = "Elastic License v2"
name = "SharePoint Malware File Upload"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating SharePoint Malware File Upload

SharePoint serves as a collaborative platform for file sharing within organizations, but its openness can be exploited by adversaries. Attackers may upload malicious files to SharePoint, leveraging it to spread malware laterally across the network. The detection rule identifies such threats by monitoring specific SharePoint events where files are flagged as malware, helping to mitigate potential breaches.

### Possible investigation steps

- Review the alert details to confirm the presence of `event.dataset:o365.audit`, `event.provider:SharePoint`, `event.code:SharePointFileOperation`, and `event.action:FileMalwareDetected` to ensure the alert is valid and triggered by the correct conditions.
- Identify the user account associated with the file upload by examining the event logs for user identifiers, such as user ID or email address, to determine if the account is compromised or if the user was unaware of the file's malicious nature.
- Investigate the file's origin by checking the file name, size, and hash values in the event logs to see if it matches known malware signatures or if it has been flagged in other security tools.
- Cross-reference the file hash with threat intelligence databases to gather additional context on the file's reputation and any known associated threat actors or campaigns.
- Analyze the SharePoint site and document library where the file was uploaded to understand the potential impact and scope of exposure within the organization.
- Check for any other recent file uploads by the same user or to the same SharePoint site to identify patterns or additional suspicious activities.
- Use Osquery to gather more information about the affected endpoints. For example, run a query to list all files recently accessed or modified by the user: `SELECT * FROM file WHERE path LIKE '/path/to/sharepoint/directory/%' AND mtime > (SELECT strftime('%s', 'now') - 86400);`
- Review access logs and permissions for the SharePoint site to identify any unauthorized access or privilege escalation attempts that may have facilitated the malware upload.
- Investigate any lateral movement attempts by checking for subsequent access to other network resources or systems by the user or associated accounts.
- Document all findings and evidence collected during the investigation to support further analysis and potential escalation to the incident response team.

### False positive analysis

- Files flagged as malware may include legitimate software or scripts that are incorrectly identified by the scanning engine due to heuristic or signature-based detection methods. This can occur with custom-developed applications or scripts that are not widely recognized.
- Frequent uploads of large datasets or files from trusted internal sources might trigger false positives if the scanning engine misinterprets the data patterns as malicious.
- Users can manage these false positives by creating exceptions for specific files or file types that are consistently flagged but verified as safe. This can be done by adjusting the scanning engine's sensitivity settings or by whitelisting certain file hashes or sources.
- Regularly updating the scanning engine's malware definitions and maintaining a list of known safe files can help reduce the occurrence of false positives.
- Implementing a review process for flagged files, where security teams can manually verify the legitimacy of the files before taking action, can also help in managing false positives effectively.

### Response and remediation

- Immediately isolate the affected SharePoint site or document library to prevent further access and potential spread of the malware.
- Notify the IT security team and relevant stakeholders about the detected malware to initiate a coordinated response.
- Conduct a thorough investigation to identify the source and scope of the malware upload, including reviewing user activity logs and file access history.
- Remove the malicious file from SharePoint and perform a comprehensive scan of the environment to ensure no other instances of the malware exist.
- Reset credentials and enforce multi-factor authentication for users involved in the incident to prevent unauthorized access.
- Escalate the incident to higher-level security teams if the malware is part of a broader attack campaign or if multiple systems are affected.
- Implement enhanced logging and monitoring policies to capture detailed SharePoint activity, focusing on file uploads and access patterns.
- Integrate advanced threat detection tools with SharePoint to improve real-time monitoring and automated response capabilities.
- Restore affected systems and SharePoint sites to their operational state from clean backups, ensuring no remnants of the malware remain.
- Conduct a post-incident review to identify gaps in security controls and apply hardening measures, such as restricting file types allowed for upload and educating users on safe file-sharing practices.

## Setup

The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide",
]
risk_score = 73
rule_id = "0e52157a-8e96-4a95-a6e3-5faae5081a74"
severity = "high"
tags = ["Domain: Cloud", "Data Source: Microsoft 365", "Tactic: Lateral Movement"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:o365.audit and event.provider:SharePoint and event.code:SharePointFileOperation and event.action:FileMalwareDetected
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1080"
name = "Taint Shared Content"
reference = "https://attack.mitre.org/techniques/T1080/"


[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"

