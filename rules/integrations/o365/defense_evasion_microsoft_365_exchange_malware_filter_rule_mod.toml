[metadata]
creation_date = "2020/11/19"
integration = ["o365"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies when a malware filter rule has been deleted or disabled in Microsoft 365. An adversary or insider threat may
want to modify a malware filter rule to evade detection.
"""
false_positives = [
    """
    A malware filter rule may be deleted by a system or network administrator. Verify that the configuration change was
    expected. Exceptions can be added to this rule to filter expected behavior.
    """,
]
from = "now-30m"
index = ["filebeat-*", "logs-o365*"]
language = "kuery"
license = "Elastic License v2"
name = "Microsoft 365 Exchange Malware Filter Rule Modification"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Microsoft 365 Exchange Malware Filter Rule Modification

Microsoft 365 Exchange uses malware filter rules to protect email systems by identifying and blocking malicious content. Adversaries may attempt to delete or disable these rules to bypass security measures, facilitating the delivery of harmful payloads. The detection rule monitors audit logs for successful actions that remove or disable malware filter rules, signaling potential defense evasion attempts.

### Possible investigation steps

- Review the audit logs for the specific `event.action` values "Remove-MalwareFilterRule" or "Disable-MalwareFilterRule" to confirm the alert's validity and gather initial context.
- Examine the `event.outcome` field to ensure the action was successful, as unsuccessful attempts may indicate a different type of issue or misconfiguration.
- Identify the `event.provider` and `event.category` fields to confirm that the event is related to Exchange and web activities, ensuring the alert is relevant to the Microsoft 365 environment.
- Investigate the user account associated with the action by reviewing the `user.name` and `user.id` fields to determine if the account is legitimate or potentially compromised.
- Check the `source.ip` and `source.geo.location` fields to identify the origin of the action, looking for unusual or unexpected locations that might indicate unauthorized access.
- Analyze the `event.time` field to establish a timeline of events, correlating with other security events or anomalies that occurred around the same time.
- Use Osquery to further investigate the user account and device involved. For example, run a query to list recent logins: `SELECT * FROM users WHERE username = 'suspicious_user';`
- Review any recent changes to permissions or roles associated with the user account to determine if they have been granted elevated privileges that could facilitate such actions.
- Cross-reference the alert with other security tools and logs, such as endpoint protection or network monitoring, to identify any related suspicious activities or patterns.
- Consult with the IT or security team to verify if the action was part of a legitimate administrative task or change management process, potentially ruling out malicious intent.

### False positive analysis

- Routine administrative tasks: Legitimate IT administrators may occasionally remove or disable malware filter rules as part of regular maintenance or updates, which can trigger false positives. 
- Policy updates: Changes in organizational security policies might necessitate the modification of malware filter rules, leading to alerts that are not indicative of malicious activity.
- Testing and troubleshooting: Security teams may disable or remove rules temporarily for testing or troubleshooting purposes, which can be mistaken for suspicious behavior.
- To manage these false positives, organizations can implement exception lists that include known and trusted administrative accounts or IP addresses involved in regular maintenance activities.
- Regularly review and update the exception lists to ensure they reflect current administrative practices and personnel changes, minimizing unnecessary alerts.
- Implement a change management process that logs and approves legitimate rule modifications, providing context for alerts and reducing the likelihood of false positives.

### Response and remediation

- Immediately isolate affected accounts or systems to prevent further unauthorized changes to malware filter rules.
- Conduct a thorough investigation to identify the source of the modification, including reviewing audit logs and correlating with other security events.
- Verify the integrity of other security configurations and rules within Microsoft 365 to ensure no additional unauthorized changes have been made.
- Restore the deleted or disabled malware filter rules from backups or recreate them based on documented configurations.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging and monitoring for Microsoft 365, focusing on changes to security configurations and rules.
- Integrate threat intelligence feeds to correlate with observed activities and identify potential indicators of compromise.
- Review and update access controls and permissions to ensure that only authorized personnel can modify security rules.
- Conduct a post-incident review to identify gaps in security controls and processes, and implement necessary improvements.
- Educate and train staff on recognizing and reporting suspicious activities related to security rule modifications.

## Setup

The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-malwarefilterrule?view=exchange-ps",
    "https://docs.microsoft.com/en-us/powershell/module/exchange/disable-malwarefilterrule?view=exchange-ps",
]
risk_score = 47
rule_id = "ca79768e-40e1-4e45-a097-0e5fbc876ac2"
severity = "medium"
tags = [
    "Domain: Cloud",
    "Data Source: Microsoft 365",
    "Use Case: Configuration Audit",
    "Tactic: Defense Evasion",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:("Remove-MalwareFilterRule" or "Disable-MalwareFilterRule") and event.outcome:success
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1562"
name = "Impair Defenses"
reference = "https://attack.mitre.org/techniques/T1562/"


[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

