[metadata]
creation_date = "2021/05/17"
integration = ["o365"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic", "Austin Songer"]
description = """
Identifies accounts with a high number of single sign-on (SSO) logon errors. Excessive logon errors may indicate an
attempt to brute force a password or SSO token.
"""
false_positives = [
    """
    Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false
    positives.
    """,
]
from = "now-20m"
index = ["filebeat-*", "logs-o365*"]
language = "kuery"
license = "Elastic License v2"
name = "O365 Excessive Single Sign-On Logon Errors"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating O365 Excessive Single Sign-On Logon Errors

Single Sign-On (SSO) streamlines user access across multiple applications using one set of credentials, enhancing user experience and security. However, adversaries may exploit SSO by attempting brute force attacks to gain unauthorized access. The detection rule monitors for unusual spikes in SSO logon errors, specifically targeting invalid or expired tokens, to identify potential brute force attempts.

### Possible investigation steps

- Review the alert details to identify the specific account(s) associated with the excessive SSO logon errors, focusing on the `o365.audit.LogonError` field for "SsoArtifactInvalidOrExpired".
- Check the timestamp of the logon errors to determine if there is a pattern or specific time frame when the errors occurred.
- Investigate the source IP addresses associated with the logon attempts to identify any unusual or suspicious locations, using the `event.dataset` and `event.provider` fields for context.
- Correlate the identified IP addresses with known threat intelligence sources to check for any malicious activity or reputation.
- Examine the user account's recent activity logs for any other anomalies or unusual behavior, such as logins from different geographic locations or changes in user settings.
- Use Osquery to gather additional context on the affected systems. For example, run a query to list recent login attempts: `SELECT * FROM logon_sessions WHERE logon_type = 'SSO' AND status = 'failed';`
- Analyze the frequency and volume of the logon errors to determine if they align with typical brute force attack patterns.
- Check for any recent changes in the user's account settings or permissions that could have triggered the errors.
- Investigate if there are any other accounts experiencing similar logon errors, which could indicate a broader attack.
- Review any recent security updates or changes in the SSO configuration that might have inadvertently caused the logon errors.

### False positive analysis

- Users with expired passwords or tokens may trigger excessive SSO logon errors, leading to false positives. Regularly updating credentials and tokens can help mitigate this issue.
- Automated scripts or applications using outdated credentials can cause repeated logon errors. Ensure that all automated processes are updated with current credentials to prevent unnecessary alerts.
- Users frequently accessing multiple applications simultaneously might experience token expiration, resulting in logon errors. Consider extending token expiration times for specific users or applications to reduce false positives.
- Network latency or connectivity issues can lead to repeated logon attempts and errors. Monitoring network performance and addressing connectivity issues can help minimize these occurrences.
- Implement exception rules for known non-threatening behaviors, such as specific users or IP addresses that consistently generate logon errors due to legitimate reasons, to prevent them from triggering alerts.

### Response and remediation

- Immediately isolate the affected accounts to prevent further unauthorized access and reset their passwords.
- Review the logs for the affected accounts to identify any successful logins or suspicious activities following the logon errors.
- Conduct a thorough investigation to determine if the logon errors are part of a broader brute force attack or if they are isolated incidents.
- Escalate the incident to the security operations center (SOC) or incident response team if there is evidence of a coordinated attack or if sensitive data may have been accessed.
- Implement multi-factor authentication (MFA) for all users to add an additional layer of security against brute force attacks.
- Enhance logging policies to ensure detailed records of authentication attempts and errors are captured for future analysis.
- Integrate threat intelligence feeds to correlate logon errors with known malicious IP addresses or threat actors.
- Educate users on recognizing phishing attempts and the importance of using strong, unique passwords to reduce the risk of credential compromise.
- Restore affected systems and accounts to their operational state by ensuring all security patches are applied and configurations are hardened.
- Regularly review and update security policies and procedures to address any gaps identified during the investigation and to improve the organization's overall security posture.

## Setup

The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
risk_score = 73
rule_id = "2de10e77-c144-4e69-afb7-344e7127abd0"
severity = "high"
tags = [
    "Domain: Cloud",
    "Data Source: Microsoft 365",
    "Use Case: Identity and Access Audit",
    "Tactic: Credential Access",
]
timestamp_override = "event.ingested"
type = "threshold"

query = '''
event.dataset:o365.audit and event.provider:AzureActiveDirectory and event.category:authentication and o365.audit.LogonError:"SsoArtifactInvalidOrExpired"
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1110"
name = "Brute Force"
reference = "https://attack.mitre.org/techniques/T1110/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

[rule.threshold]
field = ["user.id"]
value = 5

