[metadata]
creation_date = "2020/12/01"
integration = ["o365"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies a high number (25) of failed Microsoft 365 user authentication attempts from a single IP address within 30
minutes, which could be indicative of a password spraying attack. An adversary may attempt a password spraying attack to
obtain unauthorized access to user accounts.
"""
false_positives = [
    """
    Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false
    positives.
    """,
]
from = "now-30m"
index = ["filebeat-*", "logs-o365*"]
language = "kuery"
license = "Elastic License v2"
name = "Deprecated - Potential Password Spraying of Microsoft 365 User Accounts"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Deprecated - Potential Password Spraying of Microsoft 365 User Accounts

Microsoft 365 is a cloud-based suite offering productivity and collaboration tools, which relies on robust authentication mechanisms to secure user access. Adversaries may exploit these mechanisms through password spraying, a technique involving numerous login attempts with common passwords across many accounts. The detection rule identifies such attempts by monitoring failed logins from a single IP, flagging potential unauthorized access efforts.

### Possible investigation steps

- Review the alert details to confirm the number of failed login attempts from the specific IP address and verify if it meets the threshold of 25 failed attempts within 30 minutes.
- Identify the IP address involved in the alert and perform a reverse DNS lookup to gather more information about its origin and whether it is associated with known malicious activity.
- Cross-reference the IP address with threat intelligence sources to determine if it has been previously reported for suspicious or malicious activities.
- Examine the list of user accounts targeted by the failed login attempts to identify any patterns, such as common roles or departments, which might indicate a targeted attack.
- Check the event logs for successful logins from the same IP address to determine if any unauthorized access was achieved.
- Analyze the timestamps of the failed login attempts to identify any unusual patterns or timing that could provide additional context about the attack.
- Use Osquery to investigate the affected systems for any signs of compromise or unusual activity. For example, run the following Osquery query to check for recent login attempts on a specific system: `SELECT * FROM last WHERE username IN ('user1', 'user2', 'user3') AND time > (SELECT strftime('%s', 'now') - 1800);`
- Investigate any other authentication-related events from the same IP address or involving the same user accounts to identify potential lateral movement or further attack attempts.
- Review the organization's security policies and configurations for Microsoft 365 to ensure that they align with best practices for preventing password spraying attacks.
- Collaborate with other teams, such as network or security operations, to gather additional context or logs that might assist in the investigation, such as firewall logs or network traffic analysis.

### False positive analysis

- High volume of failed login attempts from a single IP may occur due to legitimate reasons such as users mistyping passwords or using outdated credentials, especially after a password change policy is enforced.
- Automated scripts or applications that use outdated credentials for authentication can trigger false positives if they repeatedly attempt to log in.
- Shared IP addresses, such as those from corporate networks or VPNs, can result in multiple failed login attempts being logged from the same IP, even if they originate from different users.
- To manage these false positives, users can create exceptions for known IP addresses associated with trusted networks or services.
- Implementing a monitoring system to track and whitelist IP addresses that consistently show non-threatening behavior can help reduce false positives.
- Regularly updating and maintaining a list of known applications or scripts that may cause failed login attempts can assist in excluding these from triggering alerts.

### Response and remediation

- Immediately block the IP address from which the failed login attempts originated to prevent further unauthorized access attempts.
- Review the affected user accounts for any signs of successful unauthorized access or suspicious activity and reset passwords as necessary.
- Enable multi-factor authentication (MFA) for all user accounts to add an additional layer of security against password spraying attacks.
- Conduct a thorough investigation of the logs to identify any other IP addresses or accounts that may be involved in similar activities.
- Escalate the incident to the security operations center (SOC) or relevant IT security team for further analysis and response.
- Implement or enhance logging policies to ensure comprehensive capture of authentication events, including both successful and failed login attempts.
- Integrate threat intelligence feeds to identify known malicious IP addresses and enhance detection capabilities.
- Educate users on the importance of using strong, unique passwords and the risks associated with password spraying attacks.
- Restore any affected systems or accounts to their operational state by ensuring all security patches are applied and configurations are secure.
- Review and update security policies and procedures to incorporate lessons learned from the incident and improve future response efforts.

This rule has been deprecated in favor of `Attempts to Brute Force a Microsoft 365 User Account` (26f68dba-ce29-497b-8e13-b4fde1db5a2d)."""
risk_score = 73
rule_id = "3efee4f0-182a-40a8-a835-102c68a4175d"
severity = "high"
tags = [
    "Domain: Cloud",
    "Data Source: Microsoft 365",
    "Use Case: Identity and Access Audit",
    "Tactic: Credential Access",
]
timestamp_override = "event.ingested"
type = "threshold"

query = '''
event.dataset:o365.audit and event.provider:(Exchange or AzureActiveDirectory) and event.category:authentication and
event.action:("UserLoginFailed" or "PasswordLogonInitialAuthUsingPassword")
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1110"
name = "Brute Force"
reference = "https://attack.mitre.org/techniques/T1110/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

[rule.threshold]
field = ["source.ip"]
value = 25

