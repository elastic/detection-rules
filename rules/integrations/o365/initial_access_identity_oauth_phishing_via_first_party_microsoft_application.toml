[metadata]
creation_date = "2025/04/23"
integration = ["o365"]
maturity = "production"
updated_date = "2025/12/17"

[rule]
author = ["Elastic"]
description = """
Detects potentially suspicious OAuth authorization activity in Microsoft 365 where first-party Microsoft applications
from the FOCI (Family of Client IDs) group are used to request access to Microsoft Graph or legacy Azure AD resources.
This rule uses split detection logic: (1) Developer tools like Azure CLI, Visual Studio Code, and Azure PowerShell
accessing either Microsoft Graph or legacy AAD are flagged, as these are commonly abused in phishing campaigns like
ConsentFix. (2) Any FOCI family application accessing legacy Windows Azure Active Directory
(00000002-0000-0000-c000-000000000000) is flagged, as this deprecated resource is rarely accessed legitimately and
attackers use it for stealth. First-party apps are trusted by default in all tenants, allowed to request permissions
without admin approval, and cannot be deleted or blocked - making them ideal for OAuth phishing attacks.
"""
from = "now-25m"
index = ["logs-o365.audit-*"]
language = "kuery"
license = "Elastic License v2"
name = "M365 Identity OAuth Phishing via First-Party Microsoft Application"
note = """## Triage and analysis

### Investigating M365 Identity OAuth Phishing via First-Party Microsoft Application

This rule identifies successful Microsoft 365 sign-ins where first-party Microsoft applications from the FOCI (Family of Client IDs) group are used in potentially suspicious OAuth flows. The rule uses split detection logic:

**Detection Logic 1 - Developer Tools → Graph or Legacy AAD:**
- **Visual Studio Code** (`aebc6443-996d-45c2-90f0-388ff96faa56`)
- **Azure CLI** (`04b07795-8ddb-461a-bbee-02f9e1bf7b46`)
- **Azure PowerShell** (`1950a258-227b-4e31-a9cf-717495945fc2`)

These developer tools accessing Microsoft Graph or legacy AAD are flagged because they use localhost redirect URIs, making them ideal for OAuth code theft attacks like ConsentFix.

**Detection Logic 2 - Any FOCI App → Legacy AAD Only:**
Any of the 38 FOCI family applications accessing legacy Windows Azure Active Directory (`00000002-0000-0000-c000-000000000000`) is suspicious because this deprecated API is rarely used legitimately. Attackers intentionally target legacy AAD to evade detection rules focused on Microsoft Graph.

**FOCI Family Applications** (partial list - see Secureworks research for full list):
- Microsoft Office, Teams, Outlook Mobile, OneDrive, SharePoint
- Microsoft Edge, Power BI, Intune Company Portal, Microsoft Authenticator
- And 30+ other Microsoft first-party applications

The behavior is typically seen in targeted attacks where users are lured into clicking a Microsoft login URL that redirects to a legitimate Microsoft URI (such as `insiders.vscode.dev` or `localhost`) and displays an OAuth code. If the user returns this code (e.g., via Signal, WhatsApp, or pasting into a phishing page), the attacker can use it to gain access to the user's data via Microsoft Graph APIs — all without prompting for explicit consent or MFA, especially when default or pre-consented apps are abused.

**ConsentFix Attack Pattern**: Victims land on compromised high-reputation websites via search engines, are shown a fake Cloudflare Turnstile, and tricked into completing a legitimate Microsoft OAuth flow. The redirect URL contains a localhost URI with an authorization code that victims are socially engineered to paste back into the attacker's page.

### Possible investigation steps

- Review `user.name` or `o365.audit.UserId` to identify the impacted account.
- Validate whether the user expected to authorize the application (Azure CLI, VS Code, or Azure PowerShell) at the time of the event.
- Check if `o365.audit.ActorIpAddress` is an unexpected or geolocated IP — especially outside of corporate ranges or from proxy networks.
- Look at `user_agent.original` and `o365.audit.DeviceProperties` to determine the device and browser involved — known attacker flows often show Chrome + MacOS or headless browser variants.
- Confirm the `Target.ID` to identify the resource being accessed:
  - Microsoft Graph: `00000003-0000-0000-c000-000000000000`
  - Windows Azure Active Directory (legacy): `00000002-0000-0000-c000-000000000000`
- Check for follow-up access events or mailbox enumeration using the Graph API from unfamiliar service principals or devices.
- Review the `ExtendedProperties.RequestType` = `OAuth2:Authorize` and `ResultStatusDetail` = `Redirect` — this indicates that the user was redirected after authorization, which typically exposes the OAuth `code`.
- For Azure CLI-based attacks, look for subsequent non-interactive sign-ins from different IPs using the same session, particularly accessing legacy AAD or Intune resources.

### False positive analysis

- Developers or IT users intentionally using Visual Studio Code, Azure CLI, or Azure PowerShell to connect to Microsoft 365 may trigger this rule.
- Legitimate Visual Studio Code extensions that sync or query Graph API data (e.g., calendars, tasks, cloud-hosted notebooks).
- Enterprise use cases where these tools are used for integrated identity workflows or automation.
- Exclude known user agents and hosts that regularly use these applications against Graph.
- Whitelist specific source IPs or devices tied to developer machines.
- Correlate with user context and behavior — if the user has no reason to be developing or testing code, the event may be more suspicious.
- Add exception rules for managed devices or corporate laptops using this flow regularly.
- Azure CLI usage for legitimate infrastructure management tasks.

### Response and remediation

- Reach out to the user to confirm if they expected this login or may have shared an OAuth code.
- Suspend or reset credentials if the login appears suspicious or if the code was likely returned to a third party.
- Review recent Microsoft Graph activity (email, file access, Teams) for this user and service principal.
- Block or restrict future use of OAuth tokens from unknown apps or IPs via Conditional Access.
- Add alerts for first-party application IDs combined with low-reputation IPs or unexpected device fingerprints.
- Require MFA and Conditional Access for all OAuth flows — even for Microsoft first-party apps.
- Disable or restrict app consent for users, and require admin approval for Graph API scopes.
- Educate users about OAuth-based phishing techniques — especially those that ask users to share "codes" after clicking a Microsoft login link.
- Regularly audit `ApplicationId`, `RequestType`, and `ResultStatusDetail` values in `o365.audit` to spot anomalous usage patterns.
- Consider blocking localhost redirect URIs for OAuth flows where possible.
"""
references = [
    "https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/reference-azure-monitor-sign-ins-log-schema",
    "https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/",
    "https://pushsecurity.com/blog/consentfix",
    "https://github.com/secureworks/family-of-client-ids-research",
]
risk_score = 47
rule_id = "929d0766-204b-11f0-9c1f-f661ea17fbcd"
severity = "medium"
tags = [
    "Domain: Cloud",
    "Domain: SaaS",
    "Data Source: Microsoft 365",
    "Data Source: Microsoft 365 Audit Logs",
    "Use Case: Identity and Access Audit",
    "Resources: Investigation Guide",
    "Tactic: Initial Access",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset: "o365.audit"
    and event.action: "UserLoggedIn"
    and o365.audit.ExtendedProperties.RequestType: "OAuth2:Authorize"
    and o365.audit.ExtendedProperties.ResultStatusDetail: "Redirect"
    and o365.audit.UserType: ("0" or "2" or "3" or "5" or "6" or "10")
    and (
        (
            o365.audit.ApplicationId: (
                "aebc6443-996d-45c2-90f0-388ff96faa56" or
                "04b07795-8ddb-461a-bbee-02f9e1bf7b46" or
                "1950a258-227b-4e31-a9cf-717495945fc2"
            )
            and o365.audit.Target.ID: (
                "00000003-0000-0000-c000-000000000000" or
                "00000002-0000-0000-c000-000000000000"
            )
        ) or
        (
            o365.audit.ApplicationId: (
                "00b41c95-dab0-4487-9791-b9d2c32c80f2" or
                "1fec8e78-bce4-4aaf-ab1b-5451cc387264" or
                "26a7ee05-5602-4d76-a7ba-eae8b7b67941" or
                "27922004-5251-4030-b22d-91ecd9a37ea4" or
                "4813382a-8fa7-425e-ab75-3b753aab3abb" or
                "ab9b8c07-8f02-4f72-87fa-80105867a763" or
                "d3590ed6-52b3-4102-aeff-aad2292ab01c" or
                "872cd9fa-d31f-45e0-9eab-6e460a02d1f1" or
                "af124e86-4e96-495a-b70a-90f90ab96707" or
                "2d7f3606-b07d-41d1-b9d2-0d0c9296a6e8" or
                "844cca35-0656-46ce-b636-13f48b0eecbd" or
                "87749df4-7ccf-48f8-aa87-704bad0e0e16" or
                "cf36b471-5b44-428c-9ce7-313bf84528de" or
                "0ec893e0-5785-4de6-99da-4ed124e5296c" or
                "22098786-6e16-43cc-a27d-191a01a1e3b5" or
                "4e291c71-d680-4d0e-9640-0a3358e31177" or
                "57336123-6e14-4acc-8dcf-287b6088aa28" or
                "57fcbcfa-7cee-4eb1-8b25-12d2030b4ee0" or
                "66375f6b-983f-4c2c-9701-d680650f588f" or
                "9ba1a5c7-f17a-4de9-a1f1-6178c8d51223" or
                "a40d7d7d-59aa-447e-a655-679a4107e548" or
                "a569458c-7f2b-45cb-bab9-b7dee514d112" or
                "b26aadf8-566f-4478-926f-589f601d9c74" or
                "c0d2a505-13b8-4ae0-aa9e-cddd5eab0b12" or
                "d326c1ce-6cc6-4de2-bebc-4591e5e13ef0" or
                "e9c51622-460d-4d3d-952d-966a5b1da34c" or
                "eb539595-3fe1-474e-9c1d-feb3625d1be5" or
                "ecd6b820-32c2-49b6-98a6-444530e5a77a" or
                "f05ff7c9-f75a-4acd-a3b5-f4b6a870245d" or
                "f44b1140-bc5e-48c6-8dc0-5cf5a53c0e34" or
                "be1918be-3fe3-4be9-b32b-b542fc27f02e" or
                "cab96880-db5b-4e15-90a7-f3f1d62ffe39" or
                "d7b530a4-7680-4c23-a8bf-c52c121d2e87" or
                "dd47d17a-3194-4d86-bfd5-c6ae6f5651e3" or
                "e9b154d0-7658-433b-bb25-6b8e0a8a7c59"
            )
            and o365.audit.Target.ID: "00000002-0000-0000-c000-000000000000"
        )
    )
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"
[[rule.threat.technique.subtechnique]]
id = "T1078.004"
name = "Cloud Accounts"
reference = "https://attack.mitre.org/techniques/T1078/004/"


[[rule.threat.technique]]
id = "T1566"
name = "Phishing"
reference = "https://attack.mitre.org/techniques/T1566/"
[[rule.threat.technique.subtechnique]]
id = "T1566.002"
name = "Spearphishing Link"
reference = "https://attack.mitre.org/techniques/T1566/002/"



[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

