[metadata]
creation_date = "2022/01/10"
integration = ["o365"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies the occurence of files uploaded to OneDrive being detected as Malware by the file scanning engine. Attackers
can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access.
Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunity to gain
initial access to other endpoints in the environment.
"""
false_positives = ["Benign files can trigger signatures in the built-in virus protection"]
from = "now-30m"
index = ["filebeat-*", "logs-o365*"]
language = "kuery"
license = "Elastic License v2"
name = "OneDrive Malware File Upload"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating OneDrive Malware File Upload

OneDrive, a cloud storage service, facilitates file sharing and collaboration within organizations. However, adversaries can exploit this by uploading malware, which can spread across shared environments, leading to lateral movement. The detection rule monitors OneDrive audit logs for malware detection events, identifying potential threats when malicious files are uploaded, thus helping to prevent unauthorized access and propagation.

### Possible investigation steps

- Review the OneDrive audit logs to confirm the event details, focusing on fields such as `event.dataset`, `event.provider`, `event.code`, and `event.action` to ensure the alert is valid and corresponds to a malware detection.
- Identify the user account associated with the file upload by examining the `user.name` and `user.id` fields in the audit logs to determine if the account is compromised or if the upload was accidental.
- Investigate the file details, including the file name, size, and hash, by checking the `file.name`, `file.size`, and `file.hash` fields to gather more context about the nature of the file.
- Check the file's origin by reviewing the `source.ip` and `source.geo.location` fields to understand where the file was uploaded from and if it matches the user's typical behavior.
- Analyze the file's sharing permissions and access history using the `file.permissions` and `file.accessed` fields to determine if the file has been shared with other users or accessed by unauthorized parties.
- Use Osquery to gather additional context on the endpoint from which the file was uploaded. For example, run the following Osquery query to list recent file modifications in the OneDrive directory: `SELECT * FROM file WHERE directory LIKE '%OneDrive%' AND mtime > (SELECT strftime('%s', 'now') - 86400);`
- Correlate the OneDrive event with other security logs, such as endpoint detection and response (EDR) or intrusion detection system (IDS) logs, to identify any related suspicious activities or alerts.
- Investigate the user's recent activity by reviewing additional OneDrive and Office 365 audit logs to identify any other unusual or unauthorized actions performed by the user.
- Check for any other malware detection events in the OneDrive environment by searching for similar `event.action:FileMalwareDetected` events to assess if this is an isolated incident or part of a larger campaign.
- Document all findings and evidence collected during the investigation to support further analysis and potential escalation to the incident response team.

### False positive analysis

- Legitimate software updates or patches may be flagged as malware if they contain code patterns similar to known threats. Users should verify the source and integrity of these files before excluding them from detection.
- Files with macros or scripts used in business operations might trigger false positives due to their executable nature. It's important to assess the necessity and origin of these files and whitelist them if they are deemed safe.
- Internal security tools or penetration testing files could be misidentified as malicious. Ensure these tools are recognized and documented within the organization to prevent unnecessary alerts.
- Large files or compressed archives might be flagged due to heuristic scanning limitations. Users should review these files for any suspicious content and create exceptions for trusted sources.
- Frequent collaboration documents that undergo regular changes might be mistakenly detected as threats. Implementing a review process for these documents can help in identifying genuine threats while allowing safe files to be excluded from alerts.

### Response and remediation

- Immediately isolate the affected OneDrive account to prevent further spread of the malware within the organization.
- Notify the user associated with the account about the detected malware and provide guidance on avoiding similar incidents in the future.
- Conduct a thorough investigation of the uploaded file to determine its origin and potential impact on the organization.
- Remove the malicious file from all shared locations and ensure it is quarantined for further analysis.
- Review OneDrive audit logs and other relevant logs to identify any lateral movement or additional compromised accounts.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement or update logging policies to ensure comprehensive monitoring of file uploads and sharing activities in OneDrive.
- Integrate threat intelligence feeds and security solutions to enhance detection capabilities for similar threats in the future.
- Restore affected systems and accounts to their operational state by removing any residual malware and applying necessary security patches.
- Strengthen security measures by enforcing multi-factor authentication, regular security awareness training, and least privilege access controls.

## Setup

The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide",
]
risk_score = 73
rule_id = "bba1b212-b85c-41c6-9b28-be0e5cdfc9b1"
severity = "high"
tags = ["Domain: Cloud", "Data Source: Microsoft 365", "Tactic: Lateral Movement"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:o365.audit and event.provider:OneDrive and event.code:SharePointFileOperation and event.action:FileMalwareDetected
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1080"
name = "Taint Shared Content"
reference = "https://attack.mitre.org/techniques/T1080/"


[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"

