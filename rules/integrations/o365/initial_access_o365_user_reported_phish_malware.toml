[metadata]
creation_date = "2022/01/12"
integration = ["o365"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Detects the occurrence of emails reported as Phishing or Malware by Users. Security Awareness training is essential to
stay ahead of scammers and threat actors, as security products can be bypassed, and the user can still receive a
malicious message. Educating users to report suspicious messages can help identify gaps in security controls and prevent
malware infections and Business Email Compromise attacks.
"""
false_positives = ["Legitimate files reported by the users"]
from = "now-30m"
index = ["filebeat-*", "logs-o365*"]
language = "kuery"
license = "Elastic License v2"
name = "O365 Email Reported by User as Malware or Phish"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating O365 Email Reported by User as Malware or Phish

Office 365 (O365) provides email services that are crucial for business communication but can be exploited by adversaries through phishing attacks to gain unauthorized access. Users reporting suspicious emails help identify potential threats that bypass security measures. The detection rule leverages audit logs from the Security Compliance Center to flag emails reported as malicious, enabling swift investigation and response to phishing attempts.

### Possible investigation steps

- Review the alert details in the Security Compliance Center to gather initial information, focusing on the `event.dataset:o365.audit`, `event.provider:SecurityComplianceCenter`, and `event.action:AlertTriggered` fields to confirm the alert's legitimacy.
- Identify the user who reported the email and gather context on their role and typical email activity to assess the potential impact of the threat.
- Examine the reported email's metadata, including sender address, subject line, and timestamp, to identify any patterns or anomalies that could indicate a phishing attempt.
- Cross-reference the sender's email address and domain against known threat intelligence sources to determine if they are associated with previous phishing campaigns.
- Analyze the email headers and body for suspicious links or attachments, using tools to safely extract and inspect these elements for malicious content.
- Utilize Osquery to investigate the user's device for any signs of compromise or unusual activity. Example query: `SELECT * FROM processes WHERE name LIKE '%outlook%' AND user = '<username>';` to check for any suspicious processes related to email activity.
- Check the organization's email gateway logs for any other instances of emails from the same sender or domain to determine if this is an isolated incident or part of a broader campaign.
- Investigate any other alerts or incidents involving the same user or email address to identify potential patterns or repeated targeting.
- Review the organization's security awareness training records to verify if the user has completed recent training, which could provide insight into their ability to recognize phishing attempts.
- Document all findings and observations in a centralized incident management system to maintain a comprehensive record for future reference and analysis.

### False positive analysis

- Users may report legitimate marketing emails or newsletters as phishing due to unfamiliarity with the sender or content, leading to false positives.
- Internal company emails with unusual formatting or language might be flagged by users as suspicious, especially if they deviate from typical communication patterns.
- Automated system notifications or alerts from trusted services can be mistakenly reported as phishing if users are not aware of their purpose or origin.
- To manage these false positives, organizations can create exceptions for known and verified senders by adding them to an allowlist, reducing unnecessary alerts.
- Regularly updating user training to include examples of legitimate emails can help reduce the number of false reports by improving user discernment.
- Implementing a feedback loop where users are informed about the outcome of their reports can enhance their understanding and accuracy in identifying true threats.

### Response and remediation

- Immediately isolate the affected email account to prevent further unauthorized access or spread of malicious content.
- Conduct a thorough investigation of the reported email, including headers and links, to confirm the phishing attempt and identify any compromised accounts.
- Remove the malicious email from all user inboxes and quarantine it to prevent further interaction.
- Escalate the incident to the security operations team if the phishing attempt is part of a larger campaign or if multiple users are affected.
- Review and update email filtering rules and security policies to block similar threats in the future.
- Implement enhanced logging policies to capture detailed email activity and user actions for better future analysis.
- Integrate threat intelligence feeds to improve detection capabilities and stay informed about emerging phishing tactics.
- Educate users on recognizing phishing attempts and reinforce the importance of reporting suspicious emails promptly.
- Restore any affected systems or accounts to their operational state by resetting passwords and verifying system integrity.
- Apply security hardening measures, such as multi-factor authentication and regular security awareness training, to reduce the risk of future incidents.

## Setup

The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://support.microsoft.com/en-us/office/use-the-report-message-add-in-b5caa9f1-cdf3-4443-af8c-ff724ea719d2?ui=en-us&rs=en-us&ad=us",
]
risk_score = 47
rule_id = "5930658c-2107-4afc-91af-e0e55b7f7184"
severity = "medium"
tags = ["Domain: Cloud", "Data Source: Microsoft 365", "Tactic: Initial Access"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.action:AlertTriggered and rule.name:"Email reported by user as malware or phish"
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1566"
name = "Phishing"
reference = "https://attack.mitre.org/techniques/T1566/"
[[rule.threat.technique.subtechnique]]
id = "T1566.001"
name = "Spearphishing Attachment"
reference = "https://attack.mitre.org/techniques/T1566/001/"

[[rule.threat.technique.subtechnique]]
id = "T1566.002"
name = "Spearphishing Link"
reference = "https://attack.mitre.org/techniques/T1566/002/"



[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

