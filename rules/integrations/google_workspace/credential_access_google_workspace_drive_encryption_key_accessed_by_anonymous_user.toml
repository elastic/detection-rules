[metadata]
creation_date = "2023/03/21"
integration = ["google_workspace"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Detects when an external (anonymous) user has viewed, copied or downloaded an encryption key file from a Google
Workspace drive. Adversaries may gain access to encryption keys stored in private drives from rogue access links that do
not have an expiration. Access to encryption keys may allow adversaries to access sensitive data or authenticate on
behalf of users.
"""
false_positives = [
    """
    A user may generate a shared access link to encryption key files to share with others. It is unlikely that the
    intended recipient is an external or anonymous user.
    """,
]
from = "now-130m"
index = ["filebeat-*", "logs-google_workspace*"]
interval = "10m"
language = "eql"
license = "Elastic License v2"
name = "Google Workspace Drive Encryption Key(s) Accessed from Anonymous User"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Google Workspace Drive Encryption Key(s) Accessed from Anonymous User

Google Workspace Drive allows users to store and share files, including sensitive encryption keys. If these keys are shared via links without proper restrictions, they can be accessed by unauthorized users. Adversaries exploit this by using rogue links to obtain keys, potentially compromising data security. The detection rule identifies suspicious activities by monitoring anonymous access to key files, focusing on actions like viewing or downloading, and flags files with specific extensions indicative of encryption keys.

### Possible investigation steps

- Review the alert details to confirm the file extension matches those indicative of encryption keys, as specified in the query (e.g., "pem", "key", "pfx").
- Verify the event.action field to determine the specific action taken (e.g., "view", "copy", "download") and assess the potential impact of the action.
- Check the google_workspace.drive.visibility field to confirm that the file was shared with "people_with_link", indicating it was accessible to anyone with the link.
- Investigate the source.user.email field to ensure it is empty, confirming the access was anonymous.
- Cross-reference the file name and path with internal records to identify the owner and intended access permissions of the file.
- Use Google Workspace audit logs to trace any recent changes to the file's sharing settings or access permissions.
- Conduct a search for other files with similar extensions in the same Google Workspace Drive to assess if there are additional files at risk.
- Utilize Osquery to gather more context on the file access. Example query: `SELECT * FROM google_drive_files WHERE visibility = 'people_with_link' AND extension IN ('pem', 'key', 'pfx') AND user_email = '';`
- Analyze historical access patterns to the file to identify any previous unauthorized access attempts or changes in access patterns.
- Collaborate with the file owner to understand the necessity of the current sharing settings and gather insights into any recent activities that might have led to the exposure.

### False positive analysis

- **Shared Team Resources**: Files containing encryption keys might be shared among team members using links for collaborative purposes. If these links are accessed by team members who are not logged into their Google accounts, it could trigger a false positive. To manage this, ensure that team members are logged in when accessing shared resources or create exceptions for specific shared links known to be safe.
- **Automated System Access**: Some systems or scripts may access encryption key files using anonymous links for automated processes. These accesses can be mistaken for unauthorized activity. To handle this, document and whitelist known automated processes that require such access.
- **Third-party Integrations**: Certain third-party applications may require access to encryption keys stored in Google Workspace Drive. If these applications use anonymous links, they might be flagged as suspicious. Users should verify and whitelist trusted third-party applications that need access to these files.
- **Testing and Development**: During testing or development phases, encryption keys might be shared via links for convenience. These activities can be misinterpreted as malicious. To mitigate this, establish a separate environment for testing and development with its own set of rules or exceptions.
- **Expired Employee Access**: Former employees might still have access to shared links if not properly revoked. This can lead to false positives if they access files anonymously. Regularly audit and update access permissions to prevent this issue.

### Response and remediation

- Immediately revoke access to the shared link for the identified encryption key file to prevent further unauthorized access.
- Conduct a thorough investigation to determine the extent of the exposure, including identifying any other files accessed by the anonymous user and reviewing access logs for suspicious activities.
- Notify the affected parties and stakeholders about the potential data breach and the steps being taken to mitigate the risk.
- Change the encryption keys that were accessed and update any systems or services that rely on these keys to prevent unauthorized access.
- Implement access controls to ensure that sensitive files, such as encryption keys, are only shared with specific users and not via public links.
- Enable detailed logging and monitoring for Google Workspace activities to detect and respond to similar incidents in the future.
- Integrate Google Workspace with a Security Information and Event Management (SIEM) system to enhance threat detection and response capabilities.
- Review and update the organization's data sharing policies to include guidelines on securely sharing sensitive information.
- Conduct a security awareness training session for employees to educate them on the risks of sharing sensitive files via public links and best practices for data protection.
- Consider implementing additional security measures such as Data Loss Prevention (DLP) tools to automatically detect and prevent the sharing of sensitive information.

## Setup

The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.

### Important Information Regarding Google Workspace Event Lag Times
- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.
- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.
- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.
- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).
- See the following references for further information:
  - https://support.google.com/a/answer/7061566
  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html"""
references = [
    "https://support.google.com/drive/answer/2494822",
    "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
    "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
]
risk_score = 73
rule_id = "980b70a0-c820-11ed-8799-f661ea17fbcc"
severity = "high"
tags = [
    "Domain: Cloud",
    "Data Source: Google Workspace",
    "Use Case: Configuration Audit",
    "Tactic: Credential Access",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
file where event.dataset == "google_workspace.drive" and event.action : ("copy", "view", "download") and
    google_workspace.drive.visibility: "people_with_link" and source.user.email == "" and
    file.extension: (
        "token","assig", "pssc", "keystore", "pub", "pgp.asc", "ps1xml", "pem", "gpg.sig", "der", "key",
        "p7r", "p12", "asc", "jks", "p7b", "signature", "gpg", "pgp.sig", "sst", "pgp", "gpgz", "pfx", "crt",
        "p8", "sig", "pkcs7", "jceks", "pkcs8", "psc1", "p7c", "csr", "cer", "spc", "ps2xml")
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1552"
name = "Unsecured Credentials"
reference = "https://attack.mitre.org/techniques/T1552/"
[[rule.threat.technique.subtechnique]]
id = "T1552.004"
name = "Private Keys"
reference = "https://attack.mitre.org/techniques/T1552/004/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

