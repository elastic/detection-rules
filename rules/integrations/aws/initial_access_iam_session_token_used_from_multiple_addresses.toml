[metadata]
creation_date = "2025/04/11"
integration = ["aws"]
maturity = "production"
updated_date = "2025/07/16"

[rule]
author = ["Elastic"]
description = """
This rule identifies potentially suspicious activity by detecting instances where a single IAM user's temporary session
token is accessed from multiple IP addresses within a short time frame. Such behavior may suggest that an adversary has
compromised temporary credentials and is utilizing them from various locations. To enhance detection accuracy and
minimize false positives, the rule incorporates criteria that evaluate unique IP addresses, user agents, cities, and
networks. These additional checks help distinguish between legitimate distributed access patterns and potential
credential misuse. Detected activities are classified into different types based on the combination of unique
indicators, with each classification assigned a fidelity score reflecting the likelihood of malicious behavior. High
fidelity scores are given to patterns most indicative of threats, such as multiple unique IPs, networks, cities, and
user agents. Medium and low fidelity scores correspond to less severe patterns, enabling security teams to effectively
prioritize alerts.
"""
false_positives = [
    """
    Highly distributed environments (e.g., globally deployed automation or edge nodes) may cause a single IAM user to
    appear from multiple IPs. Review the geolocation, network context, and user agent patterns to rule out benign use.
    """,
]
from = "now-32m"
interval = "5m"
language = "esql"
license = "Elastic License v2"
name = "AWS Access Token Used from Multiple Addresses"
note = """## Triage and Analysis

### Investigating AWS Access Token Used from Multiple Addresses

Access tokens are bound to a single user. Usage from multiple IP addresses may indicate the token was stolen and used elsewhere. By correlating this with additional detection criteria like multiple user agents, different cities, and different networks, we can improve the fidelity of the rule and help to eliminate false positives associated with expected behavior, like dual-stack IPV4/IPV6 usage.

#### Possible Investigation Steps

- **Identify the IAM User**: Examine the `aws.cloudtrail.user_identity.arn` stored in `user_id` and correlate with the `source.ips` stored in `ip_list` and `unique_ips` count to determine how widely the token was used.
- **Correlate Additional Detection Context**: Examine `activity_type` and `fidelity_score` to determine additional cities, networks or user agents associated with the token usage.
- **Determine Access Key Type**: Examine the `access_key_id` to determine whether the token is short-term (beginning with ASIA) or long-term (beginning with AKIA).
- **Check Recent MFA Events**: Determine whether the user recently enabled MFA, registered devices, or assumed a role using this token.
- **Review Workload Context**: Confirm whether the user was expected to be active across multiple cities, networks or user agent environments.
- **Trace Adversary Movement**: Pivot to related actions (e.g., `s3:ListBuckets`, `iam:ListUsers`, `sts:GetCallerIdentity`) to track further enumeration.

### False Positive Analysis

- Automation frameworks that rotate through multiple IPs or cloud functions with dynamic egress IPs may cause this alert to fire.
- Confirm geolocation and workload context before escalating.

### Response and Remediation

- **Revoke the Token**: Disable or rotate the IAM credentials and invalidate the temporary session token.
- **Audit the Environment**: Look for signs of lateral movement or data access during the token's validity.
- **Strengthen Controls**: Require MFA for high-privilege actions, restrict access via policy conditions (e.g., IP range or device).

### References

- [IAM Long-Term Credentials](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html)
- [STS Temporary Credentials](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html)
- [Using MFA with Temporary Credentials](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_enable-regions.html)
- [AWS Threat Detection Use Cases](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-standards-fsbp-controls.html)
"""
references = ["https://www.sygnia.co/blog/sygnia-investigation-bybit-hack/"]
risk_score = 47
rule_id = "0d92d30a-5f3e-4b71-bc3d-4a0c4914b7e0"
severity = "medium"
tags = [
    "Domain: Cloud",
    "Data Source: AWS",
    "Data Source: Amazon Web Services",
    "Data Source: AWS IAM",
    "Data Source: AWS CloudTrail",
    "Tactic: Initial Access",
    "Use Case: Identity and Access Audit",
    "Resources: Investigation Guide",
]
timestamp_override = "event.ingested"
type = "esql"

query = '''
FROM logs-aws.cloudtrail* METADATA _id, _version, _index
| WHERE @timestamp > NOW() - 30 minutes
  AND event.dataset == "aws.cloudtrail"
  AND aws.cloudtrail.user_identity.arn IS NOT NULL
  AND aws.cloudtrail.user_identity.type == "IAMUser"
  AND source.ip IS NOT NULL
  AND NOT (
    user_agent.original LIKE "%Terraform%" OR
    user_agent.original LIKE "%Ansible%" OR
    user_agent.original LIKE "%Pulumni%"
  )
  AND `source.as.organization.name` != "AMAZON-AES"
  AND event.provider NOT IN (
    "health.amazonaws.com", "monitoring.amazonaws.com", "notifications.amazonaws.com",
    "ce.amazonaws.com", "cost-optimization-hub.amazonaws.com",
    "servicecatalog-appregistry.amazonaws.com", "securityhub.amazonaws.com"
  )

| EVAL
  Esql.time_window.date_trunc = DATE_TRUNC(30 minutes, @timestamp),
  Esql.user.id = aws.cloudtrail.user_identity.arn,
  Esql.user.access_key_id = aws.cloudtrail.user_identity.access_key_id,
  Esql.source.ip = source.ip,
  Esql.user_agent.original = user_agent.original,
  Esql.source.ip_string = TO_STRING(source.ip),
  Esql.source.ip_user_agent_pair = CONCAT(Esql.source.ip_string, " - ", user_agent.original),
  Esql.source.ip_city_pair = CONCAT(Esql.source.ip_string, " - ", source.geo.city_name),
  Esql.source.geo.city_name = source.geo.city_name,
  Esql.event.timestamp = @timestamp,
  Esql.source.network.org_name = `source.as.organization.name`

| STATS
  Esql.event.action.values = VALUES(event.action),
  Esql.event.provider.values = VALUES(event.provider),
  Esql.user.access_key_id.values = VALUES(Esql.user.access_key_id),
  Esql.user.id.values = VALUES(Esql.user.id),
  Esql.source.ip.values = VALUES(Esql.source.ip),
  Esql.user_agent.original.values = VALUES(Esql.user_agent.original),
  Esql.source.ip_user_agent_pair.values = VALUES(Esql.source.ip_user_agent_pair),
  Esql.source.geo.city_name.values = VALUES(Esql.source.geo.city_name),
  Esql.source.ip_city_pair.values = VALUES(Esql.source.ip_city_pair),
  Esql.source.network.org_name.values = VALUES(Esql.source.network.org_name),
  Esql.source.ip.count_distinct = COUNT_DISTINCT(Esql.source.ip),
  Esql.user_agent.original.count_distinct = COUNT_DISTINCT(Esql.user_agent.original),
  Esql.source.geo.city_name.count_distinct = COUNT_DISTINCT(Esql.source.geo.city_name),
  Esql.source.network.org_name.count_distinct = COUNT_DISTINCT(Esql.source.network.org_name),
  Esql.timestamp.first_seen = MIN(Esql.event.timestamp),
  Esql.timestamp.last_seen = MAX(Esql.event.timestamp),
  Esql.event.count = COUNT()
  BY Esql.time_window.date_trunc, Esql.user.access_key_id

| EVAL
  Esql.activity.type = CASE(
    Esql.source.ip.count_distinct >= 2 AND Esql.source.network.org_name.count_distinct >= 2 AND Esql.source.geo.city_name.count_distinct >= 2 AND Esql.user_agent.original.count_distinct >= 2, "multiple_ip_network_city_user_agent",
    Esql.source.ip.count_distinct >= 2 AND Esql.source.network.org_name.count_distinct >= 2 AND Esql.source.geo.city_name.count_distinct >= 2, "multiple_ip_network_city",
    Esql.source.ip.count_distinct >= 2 AND Esql.source.geo.city_name.count_distinct >= 2, "multiple_ip_and_city",
    Esql.source.ip.count_distinct >= 2 AND Esql.source.network.org_name.count_distinct >= 2, "multiple_ip_and_network",
    Esql.source.ip.count_distinct >= 2 AND Esql.user_agent.original.count_distinct >= 2, "multiple_ip_and_user_agent",
    "normal_activity"
  ),
  Esql.activity.fidelity_score = CASE(
    Esql.activity.type == "multiple_ip_network_city_user_agent", "high",
    Esql.activity.type == "multiple_ip_network_city", "high",
    Esql.activity.type == "multiple_ip_and_city", "medium",
    Esql.activity.type == "multiple_ip_and_network", "medium",
    Esql.activity.type == "multiple_ip_and_user_agent", "low"
  )

| KEEP
  Esql.time_window.date_trunc,
  Esql.activity.type,
  Esql.activity.fidelity_score,
  Esql.event.count,
  Esql.timestamp.first_seen,
  Esql.timestamp.last_seen,
  Esql.user.id.values,
  Esql.user.access_key_id.values,
  Esql.event.action.values,
  Esql.event.provider.values,
  Esql.source.ip.values,
  Esql.user_agent.original.values,
  Esql.source.ip_user_agent_pair.values,
  Esql.source.geo.city_name.values,
  Esql.source.ip_city_pair.values,
  Esql.source.network.org_name.values,
  Esql.source.ip.count_distinct,
  Esql.user_agent.original.count_distinct,
  Esql.source.geo.city_name.count_distinct,
  Esql.source.network.org_name.count_distinct

| WHERE Esql.activity.type != "normal_activity"
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"
[[rule.threat.technique.subtechnique]]
id = "T1078.004"
name = "Cloud Accounts"
reference = "https://attack.mitre.org/techniques/T1078/004/"



[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

