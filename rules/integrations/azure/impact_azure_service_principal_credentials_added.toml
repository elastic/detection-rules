[metadata]
creation_date = "2021/05/05"
integration = ["azure"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic", "Austin Songer"]
description = """
Identifies when new Service Principal credentials have been added in Azure. In most organizations, credentials will be
added to service principals infrequently. Hijacking an application (by adding a rogue secret or certificate) with
granted permissions will allow the attacker to access data that is normally protected by MFA requirements.
"""
false_positives = [
    """
    Service principal credential additions may be done by a system or network administrator. Verify whether the
    username, hostname, and/or resource name should be making changes in your environment. Credential additions from
    unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted
    from the rule.
    """,
]
from = "now-25m"
index = ["filebeat-*", "logs-azure*"]
interval = "10m"
language = "kuery"
license = "Elastic License v2"
name = "Azure Service Principal Credentials Added"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Azure Service Principal Credentials Added

Azure Service Principals are identities used by applications or services to access Azure resources securely. They typically have specific permissions and are less frequently updated. Adversaries may exploit this by adding unauthorized credentials, bypassing MFA, and accessing sensitive data. The detection rule monitors audit logs for successful additions of credentials, signaling potential misuse or hijacking attempts.

### Possible investigation steps

- Review the audit logs to confirm the event details, focusing on the `event.dataset:azure.auditlogs` and `azure.auditlogs.operation_name:"Add service principal credentials"` fields to ensure the alert is valid.
- Check the `event.outcome` field to verify the success of the credential addition and determine if it aligns with expected behavior.
- Identify the service principal involved by examining the relevant fields in the audit logs, such as the service principal's name or ID.
- Investigate the user or application that performed the credential addition by reviewing the `user.name` or `user.id` fields in the logs.
- Cross-reference the time of the credential addition with other security events or logs to identify any suspicious activity or patterns.
- Analyze the permissions and roles assigned to the service principal to assess the potential impact of unauthorized access.
- Use Osquery to gather additional context on the affected service principal. For example, run a query to list all credentials associated with the service principal: `SELECT * FROM azure_service_principal_credentials WHERE service_principal_id = '<service_principal_id>';`.
- Review recent changes or updates to the service principal's configuration or permissions to identify any unauthorized modifications.
- Check for any recent or unusual login attempts or access patterns associated with the service principal to detect potential misuse.
- Collaborate with the application or service owner to verify if the credential addition was authorized and aligns with expected operational procedures.

### False positive analysis

- Routine administrative tasks: In some organizations, service principal credentials may be updated as part of regular maintenance or automated processes. These updates can trigger the detection rule, leading to false positives.
- DevOps and CI/CD pipelines: Automated systems that manage deployments and infrastructure might add or update service principal credentials frequently, which can be mistaken for unauthorized activity.
- Third-party integrations: Some third-party applications or services may require periodic updates to service principal credentials, which could be misinterpreted as suspicious behavior.
- To manage these false positives, users can create exceptions for known and trusted sources or processes that regularly update service principal credentials. This can be done by identifying specific patterns or attributes in the audit logs that are associated with legitimate activities and excluding them from triggering alerts.
- Implementing a whitelist of service principals that are expected to have frequent credential updates can help reduce noise and focus on truly suspicious activities.
- Regularly reviewing and updating the list of exceptions is crucial to ensure that new legitimate behaviors are accounted for and that the detection rule remains effective against potential threats.

### Response and remediation

- Immediately revoke the newly added credentials to prevent unauthorized access to Azure resources.
- Conduct a thorough investigation to determine the source and method of the unauthorized credential addition, focusing on recent changes and access logs.
- Review and audit all permissions associated with the affected service principal to identify any potential misuse or over-permissioning.
- Escalate the incident to the security operations team and relevant stakeholders for further analysis and response coordination.
- Implement additional monitoring and alerting for any further unauthorized changes to service principal credentials.
- Enhance logging policies to ensure comprehensive capture of all authentication and authorization events related to service principals.
- Integrate Azure Security Center and other security tools to provide a unified view of security alerts and incidents.
- Restore the system to its operational state by ensuring all legitimate credentials are intact and functioning as expected.
- Conduct a post-incident review to identify gaps in security controls and processes, and update policies accordingly.
- Implement hardening measures such as enforcing stricter access controls, regular credential rotation, and multi-factor authentication for all service principals.

## Setup

The Azure Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = ["https://www.fireeye.com/content/dam/collateral/en/wp-m-unc2452.pdf"]
risk_score = 47
rule_id = "f766ffaf-9568-4909-b734-75d19b35cbf4"
severity = "medium"
tags = ["Domain: Cloud", "Data Source: Azure", "Use Case: Identity and Access Audit", "Tactic: Impact"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:azure.auditlogs and azure.auditlogs.operation_name:"Add service principal credentials" and event.outcome:(success or Success)
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1496"
name = "Resource Hijacking"
reference = "https://attack.mitre.org/techniques/T1496/"


[rule.threat.tactic]
id = "TA0040"
name = "Impact"
reference = "https://attack.mitre.org/tactics/TA0040/"

