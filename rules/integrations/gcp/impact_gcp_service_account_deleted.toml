[metadata]
creation_date = "2020/09/22"
integration = ["gcp"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies when a service account is deleted in Google Cloud Platform (GCP). A service account is a special type of
account used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to
make authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users
through domain-wide delegation. An adversary may delete a service account in order to disrupt their target's business
operations.
"""
false_positives = [
    """
    Service accounts may be deleted by system administrators. Verify that the behavior was expected. Exceptions can be
    added to this rule to filter expected behavior.
    """,
]
index = ["filebeat-*", "logs-gcp*"]
language = "kuery"
license = "Elastic License v2"
name = "GCP Service Account Deletion"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating GCP Service Account Deletion

Service accounts in GCP are crucial for applications and VMs to perform authorized operations without user intervention. Adversaries may delete these accounts to disrupt services or remove access, impacting business operations. The detection rule monitors audit logs for successful service account deletions, identifying potential malicious activity by correlating specific actions and outcomes.

### Possible investigation steps

- Review the alert details to confirm the presence of `event.dataset:gcp.audit`, `event.action:google.iam.admin.v*.DeleteServiceAccount`, and `event.outcome:success` to ensure the alert is valid and corresponds to a successful service account deletion.
- Identify the specific service account that was deleted by examining the relevant fields in the audit log, such as `serviceAccountId` or `serviceAccountName`.
- Determine the timestamp of the deletion event to establish a timeline and correlate it with other activities in the environment.
- Investigate the user or service that initiated the deletion by reviewing the `actor` field in the audit log to understand if it was an expected or authorized action.
- Check for any recent changes in IAM policies or permissions related to the deleted service account to identify potential misconfigurations or unauthorized access.
- Analyze other audit logs around the same timeframe for any unusual or suspicious activities, such as failed login attempts or changes to other critical resources.
- Use Osquery to gather additional context on the affected systems or applications. For example, run a query to list all service accounts and their current status: `SELECT * FROM gcp_service_accounts WHERE status = 'ACTIVE';` to verify if other accounts are impacted.
- Investigate any recent deployments or changes in the environment that might have triggered the deletion, such as automated scripts or CI/CD pipeline activities.
- Review communication channels and change management records to verify if the deletion was part of a planned maintenance or update.
- Collaborate with the application or system owners to understand the potential impact of the service account deletion and gather insights into any ongoing issues or disruptions.

### False positive analysis

- Routine maintenance or administrative tasks may lead to legitimate service account deletions, such as when accounts are no longer needed or are being rotated for security purposes.
- Automated scripts or tools used for infrastructure management might delete service accounts as part of their normal operation, especially in environments with dynamic resource provisioning.
- Service account deletions during organizational restructuring or project decommissioning can trigger alerts, even though these actions are planned and authorized.
- To manage these false positives, users can create exceptions for known maintenance windows or specific projects where frequent deletions are expected.
- Implementing a whitelist of service accounts that are regularly deleted as part of automated processes can help reduce noise in the detection system.
- Users should regularly review and update the list of exceptions to ensure that only non-threatening behaviors are excluded, maintaining the effectiveness of the detection rule.

### Response and remediation

- Immediately contain the incident by revoking any remaining access that the deleted service account had to critical resources.
- Investigate the audit logs to identify the source of the deletion request, including the user or system that initiated the action and the IP address used.
- Verify if the deletion was authorized by checking with the relevant team or personnel responsible for managing service accounts.
- Restore the deleted service account from a backup or recreate it with the same permissions to ensure continuity of operations.
- Escalate the incident to the security operations team if unauthorized deletion is confirmed, and involve legal or compliance teams if necessary.
- Implement additional logging policies to capture detailed actions related to service account management, including creation, modification, and deletion events.
- Integrate with a Security Information and Event Management (SIEM) system to correlate service account activities with other security events for enhanced monitoring.
- Conduct a review of current IAM policies and permissions to ensure the principle of least privilege is enforced for service account management.
- Educate and train staff on the importance of service account security and the potential impact of unauthorized deletions.
- Consider implementing automated alerts for critical service account changes to enable rapid response to potential security incidents.

## Setup

The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = ["https://cloud.google.com/iam/docs/service-accounts"]
risk_score = 47
rule_id = "8fb75dda-c47a-4e34-8ecd-34facf7aad13"
severity = "medium"
tags = [
    "Domain: Cloud",
    "Data Source: GCP",
    "Data Source: Google Cloud Platform",
    "Use Case: Identity and Access Audit",
    "Tactic: Impact",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:gcp.audit and event.action:google.iam.admin.v*.DeleteServiceAccount and event.outcome:success
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1531"
name = "Account Access Removal"
reference = "https://attack.mitre.org/techniques/T1531/"


[rule.threat.tactic]
id = "TA0040"
name = "Impact"
reference = "https://attack.mitre.org/tactics/TA0040/"

