[metadata]
creation_date = "2020/09/22"
integration = ["gcp"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies when a service account is disabled in Google Cloud Platform (GCP). A service account is a special type of
account used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to
make authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users
through domain-wide delegation. An adversary may disable a service account in order to disrupt to disrupt their target's
business operations.
"""
false_positives = [
    """
    Service accounts may be disabled by system administrators. Verify that the behavior was expected. Exceptions can be
    added to this rule to filter expected behavior.
    """,
]
index = ["filebeat-*", "logs-gcp*"]
language = "kuery"
license = "Elastic License v2"
name = "GCP Service Account Disabled"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating GCP Service Account Disabled

In GCP, service accounts facilitate secure application interactions by authorizing API calls. Disabling these accounts can disrupt services, a tactic adversaries might use to impair operations. The detection rule monitors audit logs for successful disablement actions, signaling potential malicious interference by identifying when a service account is intentionally deactivated.

### Possible investigation steps

- Review the audit logs to confirm the event details, focusing on `event.dataset:gcp.audit` to ensure the event source is accurate.
- Verify the `event.action:google.iam.admin.v*.DisableServiceAccount` to confirm that the action taken was indeed a service account disablement.
- Check the `event.outcome:success` field to ensure the disablement action was successful, indicating the account is currently disabled.
- Identify the service account that was disabled by examining the specific service account ID or name in the audit logs.
- Investigate the user or process that initiated the disablement by reviewing the actor's identity in the audit logs.
- Correlate the timestamp of the disablement event with other logs to identify any preceding or subsequent suspicious activities.
- Use Osquery to gather additional context on the affected service account by running a query such as: `SELECT * FROM gcp_service_accounts WHERE account_id = '<service_account_id>';` to retrieve details about the service account.
- Assess the impact of the disabled service account by identifying the applications or services that rely on it for API calls.
- Review IAM policies and permissions associated with the disabled service account to understand its access scope and potential impact.
- Investigate any recent changes to IAM roles or permissions that might have facilitated the disablement action, looking for anomalies or unauthorized modifications.

### False positive analysis

- Routine maintenance activities: Service accounts may be disabled during scheduled maintenance or updates by administrators. To manage this, users can create exceptions for known maintenance periods or specific accounts frequently involved in such activities.
- Decommissioning of services: When services or applications are retired, associated service accounts might be intentionally disabled. Users should document and exclude these decommissioning events from alerts to avoid false positives.
- Security policy enforcement: Organizations may have policies that require periodic disabling of service accounts for security audits or compliance checks. Users can handle these by maintaining a list of accounts subject to such policies and excluding them from the detection rule.
- Automated scripts or tools: Some automated processes might disable service accounts as part of their operation. Users should identify these scripts or tools and configure exceptions for their actions to prevent unnecessary alerts.

### Response and remediation

- Immediately verify the legitimacy of the service account disablement by checking with the account owner or relevant team.
- Contain the potential threat by temporarily restricting access to critical resources that the disabled service account was associated with.
- Investigate audit logs to identify any unauthorized access or suspicious activities leading up to the disablement event.
- If malicious activity is confirmed, escalate the incident to the security operations team for further analysis and response.
- Restore the disabled service account by re-enabling it and ensuring that its permissions are correctly configured to prevent unauthorized access.
- Implement additional logging policies to capture detailed information on service account activities and access patterns.
- Integrate with a Security Information and Event Management (SIEM) system to enhance real-time monitoring and alerting capabilities.
- Conduct a review of all service accounts to ensure they follow the principle of least privilege and are necessary for current operations.
- Educate relevant personnel on the importance of monitoring service account activities and recognizing signs of potential compromise.
- Apply hardening measures such as enabling multi-factor authentication (MFA) for administrative actions and regularly rotating service account keys.

## Setup

The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = ["https://cloud.google.com/iam/docs/service-accounts"]
risk_score = 47
rule_id = "bca7d28e-4a48-47b1-adb7-5074310e9a61"
severity = "medium"
tags = [
    "Domain: Cloud",
    "Data Source: GCP",
    "Data Source: Google Cloud Platform",
    "Use Case: Identity and Access Audit",
    "Tactic: Impact",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:gcp.audit and event.action:google.iam.admin.v*.DisableServiceAccount and event.outcome:success
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1531"
name = "Account Access Removal"
reference = "https://attack.mitre.org/techniques/T1531/"


[rule.threat.tactic]
id = "TA0040"
name = "Impact"
reference = "https://attack.mitre.org/tactics/TA0040/"

