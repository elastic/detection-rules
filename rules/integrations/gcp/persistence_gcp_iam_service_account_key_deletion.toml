[metadata]
creation_date = "2020/09/21"
integration = ["gcp"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies the deletion of an Identity and Access Management (IAM) service account key in Google Cloud Platform (GCP).
Each service account is associated with two sets of public/private RSA key pairs that are used to authenticate. If a key
is deleted, the application will no longer be able to access Google Cloud resources using that key. A security best
practice is to rotate your service account keys regularly.
"""
false_positives = [
    """
    Service account key deletions may be done by a system or network administrator. Verify whether the user email,
    resource name, and/or hostname should be making changes in your environment. Key deletions by unfamiliar users or
    hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule.
    """,
]
index = ["filebeat-*", "logs-gcp*"]
language = "kuery"
license = "Elastic License v2"
name = "GCP IAM Service Account Key Deletion"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating GCP IAM Service Account Key Deletion

In GCP, service account keys authenticate applications to access resources. Regular key rotation is crucial for security. Adversaries may delete keys to disrupt services or cover tracks after unauthorized access. The detection rule monitors audit logs for successful key deletions, flagging potential misuse or policy violations, aligning with MITRE ATT&CK's account manipulation techniques.

### Possible investigation steps

- Review the audit log entry details for the event.dataset:gcp.audit to confirm the deletion event and gather additional context such as timestamp, user identity, and source IP address.
- Examine the event.action field to ensure it matches google.iam.admin.v*.DeleteServiceAccountKey, confirming the specific action of key deletion.
- Check the event.outcome field to verify the success of the key deletion, ensuring the alert is not a false positive due to a failed attempt.
- Identify the service account associated with the deleted key and determine its role and permissions within the GCP environment to assess potential impact.
- Investigate the user or service account responsible for the deletion by reviewing the actor identity in the audit logs, focusing on any anomalies or unauthorized access patterns.
- Cross-reference the timestamp of the key deletion with other security events or logs to identify any correlated suspicious activities or access attempts.
- Utilize Osquery to query the GCP environment for recent changes to IAM policies or roles that might indicate broader account manipulation. Example query: `SELECT * FROM gcp_iam_policies WHERE action = 'DeleteServiceAccountKey' AND outcome = 'success';`
- Analyze historical audit logs for patterns of key deletions or other IAM changes that could suggest a recurring issue or targeted attack.
- Review the service account's usage history to determine if the deleted key was actively in use and identify any services or applications that may be affected.
- Consult with relevant stakeholders or application owners to verify if the key deletion was authorized and part of a scheduled key rotation or if it was unexpected.

### False positive analysis

- Routine key rotation: Regularly scheduled key rotations by administrators or automated processes can trigger this detection rule. To manage this, users can create exceptions for known maintenance windows or specific service accounts involved in routine rotations.
- Testing and development activities: In development environments, service account keys may be frequently created and deleted as part of testing processes. Users can exclude these environments from the detection rule or set up alerts with lower priority.
- Decommissioning of services: When services are intentionally decommissioned, associated service account keys may be deleted. Users should document and verify these activities to differentiate them from malicious actions.
- Automated security tools: Some security tools may automatically delete and recreate service account keys as part of their operations. Users should identify these tools and configure the detection rule to recognize and exclude their legitimate actions.

### Response and remediation

- Immediately contain the incident by revoking access for the compromised service account and disabling any associated applications to prevent further unauthorized access.
- Investigate the audit logs to identify the source of the key deletion, including the user or service account responsible, and any associated IP addresses or locations.
- Verify if any unauthorized changes or access occurred using the deleted key and assess the impact on the affected services and data.
- Restore the service by creating a new service account key, updating the application configuration with the new key, and ensuring the application regains access to necessary resources.
- Escalate the incident to the security operations team for further analysis and to determine if additional accounts or systems have been compromised.
- Implement enhanced logging policies to capture detailed audit logs for all IAM activities, ensuring that key deletions and other critical actions are monitored in real-time.
- Integrate with a Security Information and Event Management (SIEM) system to automate the detection and alerting of suspicious IAM activities, including key deletions.
- Conduct a post-incident review to identify gaps in the current security posture and update incident response plans accordingly.
- Apply hardening measures by enforcing strict IAM policies, such as least privilege access, regular key rotation, and multi-factor authentication for sensitive operations.
- Educate and train staff on security best practices and the importance of monitoring and responding to IAM-related alerts to prevent future incidents.

## Setup

The GCP Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://cloud.google.com/iam/docs/service-accounts",
    "https://cloud.google.com/iam/docs/creating-managing-service-account-keys",
]
risk_score = 21
rule_id = "9890ee61-d061-403d-9bf6-64934c51f638"
severity = "low"
tags = [
    "Domain: Cloud",
    "Data Source: GCP",
    "Data Source: Google Cloud Platform",
    "Use Case: Identity and Access Audit",
    "Tactic: Persistence",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:gcp.audit and event.action:google.iam.admin.v*.DeleteServiceAccountKey and event.outcome:success
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1098"
name = "Account Manipulation"
reference = "https://attack.mitre.org/techniques/T1098/"


[rule.threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"

