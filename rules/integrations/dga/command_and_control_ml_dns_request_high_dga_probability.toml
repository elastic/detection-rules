[metadata]
creation_date = "2023/09/14"
integration = ["dga", "endpoint", "network_traffic"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
A supervised machine learning model has identified a DNS question name with a high probability of sourcing from a Domain
Generation Algorithm (DGA), which could indicate command and control network activity.
"""
from = "now-10m"
index = ["logs-endpoint.events.*", "logs-network_traffic.*"]
language = "kuery"
license = "Elastic License v2"
name = "Machine Learning Detected a DNS Request With a High DGA Probability Score"
references = [
    "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
    "https://docs.elastic.co/en/integrations/dga",
    "https://www.elastic.co/security-labs/detect-domain-generation-algorithm-activity-with-new-kibana-integration",
]
risk_score = 21
rule_id = "da7f5803-1cd4-42fd-a890-0173ae80ac69"
setup = """## Setup

The rule requires the Domain Generation Algorithm (DGA) Detection integration assets to be installed, as well as DNS events collected by integrations such as Elastic Defend, Network Packet Capture, or Packetbeat.  

### DGA Detection Setup
The DGA Detection integration consists of an ML-based framework to detect DGA activity in DNS events.

#### Prerequisite Requirements:
- Fleet is required for DGA Detection.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).
- DNS events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint), [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration, or [Packetbeat](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-overview.html).
- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.
- To set up and run Packetbeat, follow [this](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html) guide.

#### The following steps should be executed to install assets associated with the DGA Detection integration:
- Go to the Kibana homepage. Under Management, click Integrations.
- In the query bar, search for Domain Generation Algorithm Detection and select the integration to see more details about it.
- Follow the instructions under the **Installation** section.
- For this rule to work, complete the instructions through **Configure the ingest pipeline**.
"""
severity = "low"
tags = [
    "Domain: Network",
    "Domain: Endpoint",
    "Data Source: Elastic Defend",
    "Use Case: Domain Generation Algorithm Detection",
    "Rule Type: ML",
    "Rule Type: Machine Learning",
    "Tactic: Command and Control",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
ml_is_dga.malicious_probability > 0.98
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Machine Learning Detected a DNS Request With a High DGA Probability Score

Machine learning models can identify DNS requests likely generated by Domain Generation Algorithms (DGAs), which adversaries use to dynamically change domain names for command and control servers, evading detection. This detection rule flags DNS queries with a high DGA probability, indicating potential malicious activity by correlating with known threat tactics and techniques.

### Possible investigation steps

- Review the DNS query logs to identify the specific domain name associated with the high DGA probability score and note the timestamp of the query.
- Cross-reference the identified domain name with threat intelligence databases to check for any known associations with malicious activity or threat actors.
- Analyze the source IP address of the DNS request to determine the originating device within the network and assess its role and importance.
- Use Osquery to gather additional context on the originating device by running a query such as: `SELECT * FROM processes WHERE pid IN (SELECT pid FROM dns_resolvers WHERE domain = '<suspicious_domain>');` to identify processes that may have initiated the DNS request.
- Investigate the network traffic logs for the source IP address around the time of the DNS request to identify any unusual or suspicious outbound connections.
- Check for any other DNS requests from the same source IP address that have high DGA probability scores to determine if there is a pattern of suspicious behavior.
- Examine endpoint security logs for the originating device to identify any recent alerts or anomalies that could correlate with the suspicious DNS activity.
- Review user activity logs for the user associated with the originating device to identify any unusual behavior or access patterns.
- Consult with the network team to verify if there have been any recent changes or anomalies in network configurations that could explain the DNS request.
- Document all findings and correlations in a centralized investigation report to facilitate further analysis and decision-making.

### False positive analysis

- Known false positives for the Machine Learning Detected a DNS Request With a High DGA Probability Score rule can include legitimate services that frequently change domain names, such as content delivery networks (CDNs) or cloud service providers, which may use dynamic DNS techniques similar to DGAs.
- Users can manage these false positives by creating exceptions for known benign domains or IP addresses that are frequently flagged. This can be done by maintaining a whitelist of trusted domains that are known to use dynamic resolution but are not associated with malicious activity.
- Regularly updating the whitelist and reviewing flagged domains against threat intelligence feeds can help ensure that legitimate services are not mistakenly blocked, while still maintaining robust security against actual threats.
- Implementing a feedback loop where security analysts can mark certain detections as false positives can help refine the machine learning model over time, reducing the likelihood of similar false positives in the future.

### Response and remediation

- Isolate the affected system from the network to prevent further communication with potential command and control servers.
- Conduct a thorough investigation of the DNS logs to identify all domains queried by the affected system and cross-reference with known malicious DGA patterns.
- Utilize endpoint detection and response (EDR) tools to perform a deep scan of the affected system for any signs of malware or unauthorized software.
- Review and update firewall and intrusion detection/prevention system (IDS/IPS) rules to block identified malicious domains and IP addresses.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if other systems are affected.
- Implement enhanced DNS logging and monitoring to capture detailed query data for future analysis and threat hunting.
- Integrate threat intelligence feeds with security information and event management (SIEM) systems to improve detection of DGA-related activities.
- Restore the affected system from a known good backup to ensure it is free from compromise and verify the integrity of critical files and configurations.
- Apply security patches and updates to the operating system and all installed software to mitigate vulnerabilities that could be exploited by attackers.
- Conduct a post-incident review to identify gaps in the current security posture and implement hardening measures such as network segmentation and least privilege access controls."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1568"
name = "Dynamic Resolution"
reference = "https://attack.mitre.org/techniques/T1568/"
[[rule.threat.technique.subtechnique]]
id = "T1568.002"
name = "Domain Generation Algorithms"
reference = "https://attack.mitre.org/techniques/T1568/002/"



[rule.threat.tactic]
id = "TA0011"
name = "Command and Control"
reference = "https://attack.mitre.org/tactics/TA0011/"

