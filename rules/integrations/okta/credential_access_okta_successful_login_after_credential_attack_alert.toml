[metadata]
creation_date = "2026/02/12"
integration = ["okta"]
maturity = "production"
updated_date = "2026/02/12"

[rule]
author = ["Elastic"]
description = """
Correlates Okta credential attack detection alerts with subsequent successful authentication events for the same user
account. This higher-order rule identifies when a brute force, password spray, or credential stuffing attack may have
successfully compromised an account. The rule captures IP rotation scenarios where attackers spray from one IP but
login from a different IP after obtaining valid credentials.
"""
false_positives = [
    "A user experiencing legitimate login issues (forgotten password, typos) may trigger credential attack alerts before successfully authenticating.",
    "Automated password reset flows where a user fails multiple times then succeeds after resetting their password.",
]
from = "now-8h"
interval = "30m"
language = "esql"
license = "Elastic License v2"
name = "Okta Successful Authentication After Credential Attack Alert"
note = """## Triage and analysis

### Investigating Okta Successful Authentication After Credential Attack Alert

This rule correlates three lower-order Okta credential attack detection rules with subsequent successful authentication for the same user account, enforcing that the attack occurred BEFORE the successful login. The correlation is user-centric, which captures IP rotation scenarios where attackers spray credentials from one IP but login from a different IP after compromising credentials. The alert includes attack/login timestamps and source IPs for investigation.

#### Correlated Rules:
- **Potential Okta Credential Stuffing Attack** (94e734c0-2cda-11ef-84e1-f661ea17fbce): Detects single IP attempting many users with few attempts each
- **Potential Okta Password Spraying Attack** (42bf698b-4738-445b-8231-c834ddefd8a0): Detects single IP attempting multiple users with repeated password guesses
- **Okta Single User Brute Force via Excessive Device Token Generation** (23f18264-2d6d-11ef-9413-f661ea17fbce): Detects automated brute force against a single user

#### Possible investigation steps:
- Identify the user account by examining the `okta.actor.alternate_id` field in the alert.
- Review the timeline: `Esql.earliest_attack` â†’ `Esql.latest_login` shows the attack-to-compromise window.
- Compare `Esql.attack_source_ips` vs `Esql.login_source_ips` - if they differ, the attacker likely rotated IPs after obtaining credentials.
- Review the original credential attack alert(s) to understand the scope and nature of the attack.
- Check the authentication method used - was MFA required and satisfied, or was it password-only?
- Review the session activity following the successful authentication for signs of account takeover:
  - Unusual application access
  - Configuration changes (MFA reset, password change, new device enrollment)
  - Data access or exfiltration attempts
- Verify with the user if the login was legitimate.
- Check if the source IP has any other suspicious activity or threat intelligence hits.

### False positive analysis:
- This rule correlates on user identity only (not IP), so it will fire when a user is targeted by an attack AND later successfully logs in - even if from a different IP.
- If the original credential attack alert was a false positive (e.g., user with forgotten password failing multiple times), the subsequent successful login may be the user resolving their issue.
- Automated password reset flows where a user fails multiple times then succeeds after resetting could trigger this rule.
- Users who trigger attack alerts due to legitimate login issues (typos, expired passwords) and then succeed will generate alerts.

### Response and remediation:
- If compromise is suspected, immediately:
  - Reset the user's password
  - Revoke all active sessions
  - Reset MFA if the attacker may have enrolled their own device
- Place the source IP on a blocklist or increase authentication requirements from that IP.
- Review the user's recent activity for signs of lateral movement or data access.
- Check for any persistence mechanisms the attacker may have established (new OAuth apps, API tokens, etc.).
- If multiple users successfully authenticated from the attack IP, treat all as potentially compromised.
- Document the incident and update detection thresholds based on findings.
"""
references = [
    "https://developer.okta.com/docs/reference/api/system-log/",
    "https://developer.okta.com/docs/reference/api/event-types/",
    "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
    "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
    "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
]
risk_score = 73
rule_id = "50742e15-c5ef-49c8-9a2d-31221d45af58"
setup = """## Setup

This rule requires the following:
1. The Okta Fleet integration, Filebeat module, or similarly structured data for Okta System Logs.
2. The three correlated credential attack detection rules must be enabled:
   - Potential Okta Credential Stuffing Attack (94e734c0-2cda-11ef-84e1-f661ea17fbce)
   - Potential Okta Password Spraying Attack (42bf698b-4738-445b-8231-c834ddefd8a0)
   - Okta Single User Brute Force via Excessive Device Token Generation (23f18264-2d6d-11ef-9413-f661ea17fbce)
3. Alerts from these rules must be written to the `.alerts-security.*` indices.

The rule queries both alert indices and Okta log indices to correlate attack alerts with successful logins."""
severity = "high"
tags = [
    "Use Case: Identity and Access Audit",
    "Use Case: Threat Detection",
    "Data Source: Okta",
    "Data Source: Okta System Logs",
    "Tactic: Credential Access",
    "Tactic: Initial Access",
    "Resources: Investigation Guide",
    "Rule Type: Higher-Order Rule",
]
timestamp_override = "event.ingested"
type = "esql"

query = '''
FROM .alerts-security.*, logs-okta.system-* METADATA _id, _version, _index
// Filter for credential attack alerts OR successful Okta authentications
| WHERE
    (
        // Credential attack alerts from the three correlated rules
        kibana.alert.rule.rule_id IN (
            "94e734c0-2cda-11ef-84e1-f661ea17fbce",  // Credential Stuffing
            "42bf698b-4738-445b-8231-c834ddefd8a0",  // Password Spraying
            "23f18264-2d6d-11ef-9413-f661ea17fbce"   // DT Brute Force
        )
    )
    OR (
        // Successful Okta authentication events
        event.dataset == "okta.system"
        AND (event.action LIKE "user.authentication.*" OR event.action == "user.session.start")
        AND okta.outcome.result == "SUCCESS"
        AND okta.actor.alternate_id IS NOT NULL
    )
// Ensure we have user identity to correlate on
| WHERE okta.actor.alternate_id IS NOT NULL
// Classify each event and capture IPs + timestamps separately for attack vs login
| EVAL
    Esql.is_credential_attack_alert = CASE(
        kibana.alert.rule.rule_id IN (
            "94e734c0-2cda-11ef-84e1-f661ea17fbce",
            "42bf698b-4738-445b-8231-c834ddefd8a0",
            "23f18264-2d6d-11ef-9413-f661ea17fbce"
        ), 1, 0
    ),
    Esql.is_successful_login = CASE(
        event.dataset == "okta.system"
        AND okta.outcome.result == "SUCCESS"
        AND okta.actor.alternate_id IS NOT NULL, 1, 0
    ),
    // Capture IPs separately for attack events vs successful logins
    Esql.attack_source_ip = CASE(
        kibana.alert.rule.rule_id IN (
            "94e734c0-2cda-11ef-84e1-f661ea17fbce",
            "42bf698b-4738-445b-8231-c834ddefd8a0",
            "23f18264-2d6d-11ef-9413-f661ea17fbce"
        ), okta.client.ip, null
    ),
    Esql.login_source_ip = CASE(
        event.dataset == "okta.system"
        AND okta.outcome.result == "SUCCESS", okta.client.ip, null
    ),
    // Capture timestamps separately for temporal ordering
    Esql.attack_timestamp = CASE(
        kibana.alert.rule.rule_id IN (
            "94e734c0-2cda-11ef-84e1-f661ea17fbce",
            "42bf698b-4738-445b-8231-c834ddefd8a0",
            "23f18264-2d6d-11ef-9413-f661ea17fbce"
        ), @timestamp, null
    ),
    Esql.login_timestamp = CASE(
        event.dataset == "okta.system"
        AND okta.outcome.result == "SUCCESS", @timestamp, null
    )
// Aggregate by USER only - catches IP rotation where attacker sprays from IP A, logs in from IP B
| STATS
    Esql.attack_alert_count = SUM(Esql.is_credential_attack_alert),
    Esql.successful_login_count = SUM(Esql.is_successful_login),
    Esql.earliest_attack = MIN(Esql.attack_timestamp),
    Esql.latest_attack = MAX(Esql.attack_timestamp),
    Esql.earliest_login = MIN(Esql.login_timestamp),
    Esql.latest_login = MAX(Esql.login_timestamp),
    Esql.attack_source_ips = VALUES(Esql.attack_source_ip),
    Esql.login_source_ips = VALUES(Esql.login_source_ip),
    Esql.all_source_ips = VALUES(okta.client.ip),
    Esql.alert_rule_ids = VALUES(kibana.alert.rule.rule_id),
    Esql.alert_rule_names = VALUES(kibana.alert.rule.name),
    Esql.event_action_values = VALUES(event.action),
    Esql.geo_country_values = VALUES(client.geo.country_name),
    Esql.geo_city_values = VALUES(client.geo.city_name),
    Esql.source_asn_values = VALUES(source.as.number),
    Esql.source_asn_org_values = VALUES(source.as.organization.name),
    Esql.user_agent_values = VALUES(okta.client.user_agent.raw_user_agent),
    Esql.device_values = VALUES(okta.client.device),
    Esql.is_proxy_values = VALUES(okta.security_context.is_proxy)
  BY okta.actor.alternate_id
// Correlation condition: User has attack alert(s) BEFORE successful login(s)
| WHERE
    Esql.attack_alert_count > 0
    AND Esql.successful_login_count > 0
    // At least one attack before at least one login
    // Safe to assume brute-forcing was a validation step prior to official login
    AND Esql.earliest_attack < Esql.latest_login
| SORT Esql.successful_login_count DESC
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1110"
name = "Brute Force"
reference = "https://attack.mitre.org/techniques/T1110/"
[[rule.threat.technique.subtechnique]]
id = "T1110.001"
name = "Password Guessing"
reference = "https://attack.mitre.org/techniques/T1110/001/"

[[rule.threat.technique.subtechnique]]
id = "T1110.003"
name = "Password Spraying"
reference = "https://attack.mitre.org/techniques/T1110/003/"

[[rule.threat.technique.subtechnique]]
id = "T1110.004"
name = "Credential Stuffing"
reference = "https://attack.mitre.org/techniques/T1110/004/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"
[[rule.threat.technique.subtechnique]]
id = "T1078.004"
name = "Cloud Accounts"
reference = "https://attack.mitre.org/techniques/T1078/004/"



[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"
