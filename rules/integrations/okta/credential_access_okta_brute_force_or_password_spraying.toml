[metadata]
creation_date = "2020/07/16"
integration = ["okta"]
maturity = "production"
updated_date = "2026/02/11"

[rule]
author = ["Elastic"]
description = """
Detects potential password spraying attacks where a single client IP attempts authentication against multiple user
accounts with a higher number of attempts per user over time. Password spraying involves trying common passwords
against many accounts, typically spread over a longer period to avoid lockouts.
"""
false_positives = [
    "Corporate proxy or VPN exit nodes may aggregate traffic from multiple legitimate users with login issues.",
    "Automated processes or misconfigured applications retrying authentication may trigger this rule.",
]
from = "now-1h"
language = "esql"
license = "Elastic License v2"
name = "Potential Okta Password Spraying Attack"
note = """## Triage and analysis

### Investigating Potential Okta Password Spraying Attack

This rule detects when a single client IP attempts authentication against multiple user accounts (10+) with a higher number of attempts per user (3+) over a 1-hour window. Password spraying involves trying common passwords (e.g., "Summer2024!", "CompanyName123") against many accounts, often spread over time to avoid triggering lockout policies.

#### Possible investigation steps:

- Review the `source.ip` field to identify the IP address from which the high volume of failed login attempts originated.
- Look into the `event.outcome` field to verify that these are indeed failed authentication attempts.
- Determine the `user.name` or `user.email` related to these failed login attempts. If the attempts are spread across multiple accounts, it might indicate a password spraying attack.
- Check the timeline of the events. Are the failed attempts spread out evenly, or are there burst periods, which might indicate an automated tool?
- Determine the geographical location of the source IP. Is this location consistent with the user's typical login location?
- Analyze any previous successful logins from this IP. Was this IP previously associated with successful logins?

### False positive analysis:

- A single user or automated process that attempts to authenticate using expired or wrong credentials multiple times may trigger a false positive.
- Analyze the behavior of the source IP. If the IP is associated with legitimate users or services, it may be a false positive.

### Response and remediation:

- If you identify unauthorized access attempts, consider blocking the source IP at the firewall level.
- Notify the users who are targeted by the attack. Ask them to change their passwords and ensure they use unique, complex passwords.
- Enhance monitoring on the affected user accounts for any suspicious activity.
- If the attack is persistent, consider implementing CAPTCHA or account lockouts after a certain number of failed login attempts.
- If the attack is persistent, consider implementing multi-factor authentication (MFA) for the affected user accounts.
- Review and update your security policies based on the findings from the incident.

## Setup

The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://developer.okta.com/docs/reference/api/system-log/",
    "https://developer.okta.com/docs/reference/api/event-types/",
    "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
    "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
    "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
]
risk_score = 47
rule_id = "42bf698b-4738-445b-8231-c834ddefd8a0"
severity = "medium"
tags = [
    "Domain: Identity",
    "Use Case: Identity and Access Audit",
    "Tactic: Credential Access",
    "Data Source: Okta",
    "Data Source: Okta System Logs",
    "Resources: Investigation Guide",
]
timestamp_override = "event.ingested"
type = "esql"

query = '''
FROM logs-okta* METADATA _id, _version, _index
| WHERE
    event.dataset == "okta.system"
    AND (event.action LIKE "user.authentication.*" OR event.action == "user.session.start")
    AND okta.outcome.reason IN ("INVALID_CREDENTIALS", "LOCKED_OUT")
    AND okta.actor.alternate_id IS NOT NULL
// Build user-device context for enrichment
| EVAL Esql.user_device_info = CONCAT(
    okta.actor.alternate_id, " | ",
    COALESCE(okta.client.device, "unknown"), " | ",
    COALESCE(okta.client.user_agent.raw_user_agent, "unknown")
  )
// Aggregate by source IP to detect password spray pattern
| STATS
    Esql.unique_users = COUNT_DISTINCT(okta.actor.alternate_id),
    Esql.total_attempts = COUNT(*),
    Esql.unique_user_agents = COUNT_DISTINCT(okta.client.user_agent.raw_user_agent),
    Esql.unique_devices = COUNT_DISTINCT(okta.client.device),
    Esql.first_seen = MIN(@timestamp),
    Esql.last_seen = MAX(@timestamp),
    Esql.target_users = VALUES(okta.actor.alternate_id),
    Esql.user_device_mapping = VALUES(Esql.user_device_info),
    Esql.event_action_values = VALUES(event.action),
    Esql.user_agent_values = VALUES(okta.client.user_agent.raw_user_agent),
    Esql.device_values = VALUES(okta.client.device),
    Esql.is_proxy_values = VALUES(okta.security_context.is_proxy),
    Esql.geo_country_values = VALUES(client.geo.country_name),
    Esql.geo_city_values = VALUES(client.geo.city_name),
    Esql.source_asn_values = VALUES(source.as.number),
    Esql.source_asn_org_values = VALUES(source.as.organization.name),
    Esql.threat_suspected_values = VALUES(okta.debug_context.debug_data.threat_suspected),
    Esql.risk_level_values = VALUES(okta.debug_context.debug_data.risk_level),
    Esql.risk_reasons_values = VALUES(okta.debug_context.debug_data.risk_reasons)
  BY okta.client.ip
// Calculate spray signature metrics (float-safe division)
| EVAL Esql.attempts_per_user = Esql.total_attempts * 1.0 / Esql.unique_users
// Password spraying: multiple users, moderate attempts per user
// Upper bound avoids drifting into pure brute-force/retry-storm behavior
| WHERE
    Esql.unique_users >= 8
    AND Esql.attempts_per_user >= 2.0
    AND Esql.attempts_per_user <= 15.0
    AND Esql.total_attempts >= 20
| SORT Esql.total_attempts DESC
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1110"
name = "Brute Force"
reference = "https://attack.mitre.org/techniques/T1110/"
[[rule.threat.technique.subtechnique]]
id = "T1110.003"
name = "Password Spraying"
reference = "https://attack.mitre.org/techniques/T1110/003/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

