[metadata]
creation_date = "2020/05/21"
integration = ["okta"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.15.0"
min_stack_comments = "Breaking change at 8.15.0 for the Okta Integration."

[rule]
author = ["Elastic"]
description = """
Detects when a user reports suspicious activity for their Okta account. These events should be investigated, as they can
help security teams identify when an adversary is attempting to gain access to their network.
"""
false_positives = ["A user may report suspicious activity on their Okta account in error."]
index = ["filebeat-*", "logs-okta*"]
language = "kuery"
license = "Elastic License v2"
name = "Suspicious Activity Reported by Okta User"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Suspicious Activity Reported by Okta User

Okta is an identity management service that enables secure user authentication and access control. Adversaries may exploit valid user accounts to gain unauthorized access, bypassing security measures. The detection rule monitors for user-reported suspicious activity, signaling potential account compromise. By analyzing these alerts, security teams can identify and mitigate unauthorized access attempts, aligning with MITRE ATT&CK's Initial Access tactics.

### Possible investigation steps

- Review the alert details to confirm the event dataset is `okta.system` and the event action is `user.account.report_suspicious_activity_by_enduser`.
- Verify the identity of the user who reported the suspicious activity by checking their user profile and recent login history in Okta.
- Analyze the user's login history for any unusual patterns, such as logins from unfamiliar IP addresses or locations.
- Check for any recent changes to the user's account settings, such as password changes or multi-factor authentication (MFA) modifications.
- Investigate any other alerts or logs related to the same user account within the same timeframe to identify potential correlations.
- Use Osquery to gather additional context on the user's device. For example, run the following query to check for recent login attempts on the user's machine:
  ```sql
  SELECT * FROM last WHERE username = '<username>';
  ```
- Examine network logs for any suspicious activity originating from the IP addresses associated with the reported suspicious activity.
- Cross-reference the reported suspicious activity with known threat intelligence sources to identify any indicators of compromise (IOCs).
- Review any recent changes in user permissions or access levels that could indicate unauthorized privilege escalation.
- Document all findings and observations in a centralized investigation report to facilitate further analysis and decision-making.

### False positive analysis

- Known false positives for the Suspicious Activity Reported by Okta User rule may include legitimate users mistakenly reporting their own activity as suspicious, such as logging in from a new device or location that they forgot to whitelist.
- Users may also report suspicious activity when they receive unexpected but legitimate security alerts or notifications from Okta, leading to unnecessary investigations.
- To manage these false positives, security teams can implement exception lists for users who frequently report non-threatening activities, ensuring that their reports are reviewed with context.
- Establishing a baseline of normal user behavior can help differentiate between genuine threats and benign activities, reducing the number of false positives.
- Educating users on recognizing legitimate security alerts and understanding their own activity patterns can minimize incorrect reports and improve the accuracy of threat detection.

### Response and remediation

- Immediately isolate the affected user account to prevent further unauthorized access and limit potential damage.
- Conduct a thorough investigation of the reported suspicious activity, reviewing logs and user actions to determine the scope and impact of the incident.
- Reset the compromised user's password and enforce multi-factor authentication (MFA) to enhance account security.
- Notify the affected user and relevant stakeholders about the incident, providing guidance on recognizing phishing attempts and securing their accounts.
- Escalate the incident to the security operations center (SOC) or incident response team if the investigation reveals a broader threat or multiple compromised accounts.
- Implement enhanced logging and monitoring for Okta and related systems to detect similar activities in the future, ensuring logs are retained for an appropriate period.
- Integrate Okta with a security information and event management (SIEM) system to correlate events and improve threat detection capabilities.
- Review and update access control policies to ensure the principle of least privilege is enforced across the organization.
- Conduct a post-incident review to identify gaps in the current security posture and develop an action plan to address them.
- Educate users on security best practices and the importance of reporting suspicious activities promptly to prevent future incidents.

## Setup

The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule."""
references = [
    "https://developer.okta.com/docs/reference/api/system-log/",
    "https://developer.okta.com/docs/reference/api/event-types/",
    "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
    "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
    "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
]
risk_score = 47
rule_id = "f994964f-6fce-4d75-8e79-e16ccc412588"
severity = "medium"
tags = ["Use Case: Identity and Access Audit", "Data Source: Okta", "Tactic: Initial Access"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:okta.system and event.action:user.account.report_suspicious_activity_by_enduser
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"


[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"


[rule.threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"


[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"


[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

