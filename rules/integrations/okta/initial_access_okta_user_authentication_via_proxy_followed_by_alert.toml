[metadata]
creation_date = "2026/02/20"
integration = ["okta"]
maturity = "production"
updated_date = "2026/02/20"

[rule]
author = ["Elastic"]
description = """
Correlates Okta user authentication from an anonymizing proxy with subsequent security alerts for the same user.
This may indicate an attacker using proxy infrastructure to authenticate, followed by malicious activity that
triggered detection rules.
"""
false_positives = [
    "Legitimate users who routinely use VPN or proxy services for privacy may trigger this if they also trigger unrelated security alerts.",
    "Security testing or red team exercises using proxy infrastructure.",
]
from = "now-60m"
interval = "59m"
language = "esql"
license = "Elastic License v2"
name = "Okta User Authentication via Proxy Followed by Security Alert"
note = """## Triage and analysis

### Investigating Okta User Authentication via Proxy Followed by Security Alert

This rule correlates Okta authentication events from anonymizing proxies with subsequent security alerts for the same user. Attackers frequently use proxy infrastructure (VPNs, Tor, residential proxies) to mask their origin when using stolen credentials, and their post-authentication activity often triggers additional detection rules.

This rule uses ES|QL aggregations and thus has dynamically generated fields. Correlation of the values in the alert document may need to be performed against the original Okta and alert events for further context.

#### Possible investigation steps
- Identify the affected user and review the correlated security alerts to understand what suspicious activity was detected after the proxy authentication.
- Examine the proxy source IP addresses and cross-reference with threat intelligence feeds for known malicious infrastructure.
- Review the time gap between the proxy authentication and subsequent alert generation.
- Review the user's recent Okta activity for signs of account takeover (MFA changes, new devices, unusual app access).
- Verify with the user whether they intentionally used a proxy or VPN during this session.

### False positive analysis
- Users who legitimately use VPN services for privacy or remote work may trigger this rule if they also trigger unrelated alerts.
- Security testing or red team exercises using proxy infrastructure combined with testing that triggers alerts.
- Corporate VPN egress points that Okta classifies as proxy infrastructure.

### Response and remediation
- If account compromise is suspected, immediately revoke all active sessions for the user.
- Reset the user's password and MFA factors.
- Review and revoke any OAuth tokens or API keys associated with the account.
- Block the source proxy IP at the network perimeter if confirmed malicious.
- Review the user's access to sensitive applications and data during the suspicious session.

## Setup

This rule requires:
1. The Okta Fleet integration, Filebeat module, or similarly structured data for Okta System Logs.
2. Okta SIEM rules turned on to generate security alerts based on Okta events, which are written to the `.alerts-security.*` indices.
2. Security alerts written to the `.alerts-security.*` indices.
"""
references = [
    "https://developer.okta.com/docs/reference/api/system-log/",
    "https://developer.okta.com/docs/reference/api/event-types/",
    "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
    "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
    "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
    "https://cloud.google.com/blog/topics/threat-intelligence/expansion-shinyhunters-saas-data-theft",
]
risk_score = 73
rule_id = "af2d8e4c-3b7c-4e91-8f5a-6c9d0e1f2a3b"
severity = "high"
tags = [
    "Domain: Identity",
    "Domain: Cloud",
    "Use Case: Identity and Access Audit",
    "Use Case: Threat Detection",
    "Data Source: Okta",
    "Data Source: Okta System Logs",
    "Tactic: Initial Access",
    "Tactic: Defense Evasion",
    "Rule Type: Higher-Order Rule",
    "Resources: Investigation Guide",
]
timestamp_override = "event.ingested"
type = "esql"

query = '''
FROM logs-okta.system-*, .alerts-security.* METADATA _id, _version, _index
| WHERE
    (
        // Okta proxy authentication events
        event.dataset == "okta.system"
        AND okta.security_context.is_proxy == true
        AND okta.actor.type == "User"
        AND okta.event_type IN ("user.session.start", "user.authentication.sso", "user.authentication.auth_via_mfa")
    )
    OR (
        // Security alerts excluding the first-proxy-occurrence rule
        _index LIKE "*.alerts-security.*"
        AND event.dataset == "okta.system"
        AND kibana.alert.rule.rule_id IS NOT NULL
        AND kibana.alert.rule.rule_id != "6f1bb4b2-7dc8-11ee-92b2-f661ea17fbcd"
    )

// Classify events and capture timestamps
| EVAL
    Esql.event_type = CASE(
        event.dataset == "okta.system" AND okta.security_context.is_proxy == true, "proxy_auth",
        _index LIKE "*.alerts-security.*", "alert",
        "other"
    ),
    Esql.proxy_auth_ts = CASE(
        event.dataset == "okta.system" AND okta.security_context.is_proxy == true, @timestamp, NULL
    ),
    Esql.alert_ts = CASE(
        _index LIKE "*.alerts-security.*", @timestamp, NULL
    ),
    Esql.proxy_source_ip = CASE(
        event.dataset == "okta.system" AND okta.security_context.is_proxy == true, source.ip, NULL
    )

// Must have user identity to correlate
| WHERE user.name IS NOT NULL

// Aggregate by user to correlate proxy auth with subsequent alerts
| STATS
    Esql.proxy_auth_count = SUM(CASE(Esql.event_type == "proxy_auth", 1, 0)),
    Esql.alert_count = SUM(CASE(Esql.event_type == "alert", 1, 0)),
    Esql.earliest_proxy_auth = MIN(Esql.proxy_auth_ts),
    Esql.latest_proxy_auth = MAX(Esql.proxy_auth_ts),
    Esql.earliest_alert = MIN(Esql.alert_ts),
    Esql.latest_alert = MAX(Esql.alert_ts),
    Esql.proxy_source_ips = VALUES(Esql.proxy_source_ip),
    Esql.alert_rule_ids = VALUES(kibana.alert.rule.rule_id),
    Esql.alert_rule_names = VALUES(kibana.alert.rule.name),
    Esql.okta_event_types = VALUES(okta.event_type),
    Esql.geo_country_values = VALUES(client.geo.country_name),
    Esql.geo_city_values = VALUES(client.geo.city_name),
    Esql.source_asn_values = VALUES(source.as.number),
    Esql.source_asn_org_values = VALUES(source.as.organization.name),
    Esql.user_agent_values = VALUES(okta.client.user_agent.raw_user_agent),
    Esql.device_values = VALUES(okta.client.device)
  BY user.name

// Calculate time between proxy auth and first alert
| EVAL
    Esql.proxy_to_alert_delay_minutes = DATE_DIFF("minutes", Esql.latest_proxy_auth, Esql.earliest_alert)

// Correlation: proxy auth BEFORE alert + alert within 1 hour window
| WHERE
    Esql.proxy_auth_count > 0
    AND Esql.alert_count > 0
    AND Esql.latest_proxy_auth < Esql.earliest_alert
    AND Esql.proxy_to_alert_delay_minutes >= 0
    AND Esql.proxy_to_alert_delay_minutes <= 60

| SORT Esql.alert_count DESC
| KEEP user.name, Esql.*
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1090"
name = "Proxy"
reference = "https://attack.mitre.org/techniques/T1090/"

[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"
[[rule.threat.technique.subtechnique]]
id = "T1078.004"
name = "Cloud Accounts"
reference = "https://attack.mitre.org/techniques/T1078/004/"

[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"
