[metadata]
creation_date = "2023/09/22"
integration = ["ded", "endpoint", "network_traffic"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
anomaly_threshold = 75
author = ["Elastic"]
description = """
A machine learning job has detected data exfiltration to a particular geo-location (by IP address). Data transfers to
geo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command
and control channels.
"""
from = "now-6h"
interval = "15m"
license = "Elastic License v2"
machine_learning_job_id = "ded_high_sent_bytes_destination_ip"
name = "Potential Data Exfiltration Activity to an Unusual IP Address"
references = [
    "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
    "https://docs.elastic.co/en/integrations/ded",
    "https://www.elastic.co/blog/detect-data-exfiltration-activity-with-kibanas-new-integration",
]
risk_score = 21
rule_id = "cc653d77-ddd2-45b1-9197-c75ad19df66c"
setup = """## Setup

The rule requires the Data Exfiltration Detection integration assets to be installed, as well as network and file events collected by integrations such as Elastic Defend and Network Packet Capture (for network events only).  

### Data Exfiltration Detection Setup
The Data Exfiltration Detection integration detects data exfiltration activity by identifying abnormalities in network and file events. Anomalies are detected using Elastic's Anomaly Detection feature. 

#### Prerequisite Requirements:
- Fleet is required for Data Exfiltration Detection.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).
- Network events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) or [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration.
- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.

#### The following steps should be executed to install assets associated with the Data Exfiltration Detection integration:
- Go to the Kibana homepage. Under Management, click Integrations.
- In the query bar, search for Data Exfiltration Detection and select the integration to see more details about it.
- Follow the instructions under the **Installation** section.
- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.
"""
severity = "low"
tags = [
    "Use Case: Data Exfiltration Detection",
    "Rule Type: ML",
    "Rule Type: Machine Learning",
    "Tactic: Exfiltration",
]
type = "machine_learning"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Data Exfiltration Activity to an Unusual IP Address

Machine learning models analyze network traffic patterns to identify anomalies, such as data transfers to atypical geo-locations. Adversaries exploit command and control (C2) channels to exfiltrate data to these unusual IP addresses. The detection rule leverages this analysis to flag potential exfiltration activities, aligning with MITRE ATT&CK's exfiltration tactics and techniques.

### Possible investigation steps

- Review the alert details to identify the unusual IP address and geo-location involved in the potential exfiltration activity.
- Cross-reference the unusual IP address with threat intelligence databases to determine if it is associated with known malicious activities or threat actors.
- Analyze historical network traffic logs to identify any previous communications with the unusual IP address, noting the frequency and volume of data transferred.
- Examine the specific machine or endpoint involved in the alert to gather information on recent activities, user logins, and running processes.
- Use Osquery to investigate the endpoint further. For example, run the following query to list recent network connections: `SELECT * FROM process_open_sockets WHERE remote_address = '<unusual_ip_address>';`
- Check for any recent changes or anomalies in the system configurations or installed software on the affected endpoint.
- Investigate user activity logs to determine if any unauthorized access or unusual user behavior occurred around the time of the alert.
- Correlate the alert with other security events or alerts to identify potential patterns or related incidents.
- Review data transfer logs to assess the type and sensitivity of the data that may have been exfiltrated to the unusual IP address.
- Consult with relevant stakeholders or departments to verify if the data transfer to the unusual IP address was authorized or part of legitimate business operations.

### False positive analysis

- Legitimate business operations may involve data transfers to geo-locations that are atypical but necessary, such as international offices or third-party service providers. These should be reviewed and, if verified as non-threatening, added to an exception list.
- Automated system updates or cloud service interactions might trigger alerts if they involve IP addresses outside the usual geographic range. Users can manage these by identifying and excluding known update servers or cloud service IPs.
- Remote work scenarios where employees connect from various global locations can result in false positives. Organizations should maintain an updated list of employee travel plans or remote work locations to adjust the detection parameters accordingly.
- Partner or vendor integrations that require data exchange with external IPs might be flagged. Establishing a whitelist of trusted partner IP addresses can help mitigate these false positives.
- Temporary projects or collaborations with international teams may necessitate data transfers to unusual IP addresses. Users should document these activities and adjust the detection rules to accommodate such temporary changes.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further data exfiltration.
- Conduct a thorough investigation to identify the scope of the exfiltration, including the data types and volumes transferred.
- Analyze network logs and endpoint data to trace the source of the command and control channel and identify any other potentially compromised systems.
- Escalate the incident to the security operations center (SOC) and relevant stakeholders, providing them with detailed findings and potential impacts.
- Implement enhanced logging policies to capture detailed network traffic and endpoint activities for future investigations.
- Integrate threat intelligence feeds and anomaly detection tools to improve the detection of unusual network patterns and potential C2 channels.
- Restore the affected system by removing any malicious software, applying security patches, and verifying the integrity of critical files.
- Conduct a post-incident review to identify gaps in the current security posture and update incident response plans accordingly.
- Implement network segmentation and access controls to limit the potential impact of future exfiltration attempts.
- Educate employees on recognizing phishing attempts and other social engineering tactics that adversaries might use to establish C2 channels."""
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1041"
name = "Exfiltration Over C2 Channel"
reference = "https://attack.mitre.org/techniques/T1041/"


[rule.threat.tactic]
id = "TA0010"
name = "Exfiltration"
reference = "https://attack.mitre.org/tactics/TA0010/"

