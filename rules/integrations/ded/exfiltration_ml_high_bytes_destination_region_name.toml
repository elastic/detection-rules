[metadata]
creation_date = "2023/09/22"
integration = ["ded", "endpoint", "network_traffic"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
anomaly_threshold = 75
author = ["Elastic"]
description = """
A machine learning job has detected data exfiltration to a particular geo-location (by region name). Data transfers to
geo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command
and control channels.
"""
from = "now-6h"
interval = "15m"
license = "Elastic License v2"
machine_learning_job_id = "ded_high_sent_bytes_destination_region_name"
name = "Potential Data Exfiltration Activity to an Unusual Region"
references = [
    "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
    "https://docs.elastic.co/en/integrations/ded",
    "https://www.elastic.co/blog/detect-data-exfiltration-activity-with-kibanas-new-integration",
]
risk_score = 21
rule_id = "bfba5158-1fd6-4937-a205-77d96213b341"
setup = """## Setup

The rule requires the Data Exfiltration Detection integration assets to be installed, as well as network and file events collected by integrations such as Elastic Defend and Network Packet Capture (for network events only).  

### Data Exfiltration Detection Setup
The Data Exfiltration Detection integration detects data exfiltration activity by identifying abnormalities in network and file events. Anomalies are detected using Elastic's Anomaly Detection feature. 

#### Prerequisite Requirements:
- Fleet is required for Data Exfiltration Detection.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).
- Network events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) or [Network Packet Capture](https://docs.elastic.co/integrations/network_traffic) integration.
- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
- To add the Network Packet Capture integration to an Elastic Agent policy, refer to [this](https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html) guide.

#### The following steps should be executed to install assets associated with the Data Exfiltration Detection integration:
- Go to the Kibana homepage. Under Management, click Integrations.
- In the query bar, search for Data Exfiltration Detection and select the integration to see more details about it.
- Follow the instructions under the **Installation** section.
- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.
"""
severity = "low"
tags = [
    "Use Case: Data Exfiltration Detection",
    "Rule Type: ML",
    "Rule Type: Machine Learning",
    "Tactic: Exfiltration",
]
type = "machine_learning"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Data Exfiltration Activity to an Unusual Region

Machine learning models analyze network traffic patterns to identify anomalies, such as data transfers to atypical regions. Adversaries exploit command and control (C2) channels to exfiltrate data to these unusual locations, bypassing traditional security measures. The detection rule leverages these models to flag suspicious geo-location activities, aligning with MITRE ATT&CK's exfiltration tactics, thus aiding in early threat identification.

### Possible investigation steps

- Review the alert details to understand the specific geo-location flagged as unusual and the volume of data transferred.
- Cross-reference the geo-location with the organization's known business operations to determine if the location is indeed atypical.
- Analyze historical network traffic logs to identify patterns and determine if similar data transfers have occurred in the past.
- Examine the source IP address and destination IP address involved in the data transfer to identify any known malicious activity or anomalies.
- Utilize Osquery to gather additional context on the involved endpoints. For example, run the following query to list recent network connections: `SELECT * FROM process_open_sockets WHERE remote_address = '<destination_ip>';`
- Investigate the user accounts associated with the data transfer to check for any signs of compromise or unusual activity.
- Check for any recent changes in firewall or proxy configurations that might have allowed the data transfer to bypass security controls.
- Correlate the alert with other security events or alerts to identify potential patterns or coordinated attacks.
- Review endpoint logs for any signs of malware or unauthorized software that could facilitate data exfiltration.
- Consult threat intelligence sources to determine if the destination IP or geo-location is associated with known threat actors or campaigns.

### False positive analysis

- Legitimate business operations involving international data transfers can trigger false positives. Organizations with global operations may frequently transfer data to regions that are atypical for other businesses but normal for them.
- Cloud service providers often have data centers in various regions. Routine data synchronization or backup activities to these locations might be misidentified as exfiltration attempts.
- Remote work scenarios where employees connect from different geographical locations can lead to false positives, especially if employees are traveling or using VPNs that exit in unusual regions.
- To manage these false positives, users can create exceptions for known and verified data transfer activities that align with business operations. This involves maintaining an updated list of trusted geo-locations and regularly reviewing and adjusting the detection rule's sensitivity to accommodate legitimate traffic patterns.

### Response and remediation

- Immediately isolate the affected systems from the network to prevent further data exfiltration.
- Conduct a thorough investigation to identify the scope of the exfiltration, including the data types and volumes transferred.
- Analyze network logs and endpoint data to trace the source of the command and control (C2) channel used for exfiltration.
- Escalate the incident to the security operations center (SOC) and relevant stakeholders for awareness and further action.
- Implement enhanced logging policies to capture detailed network traffic and endpoint activities for future investigations.
- Integrate threat intelligence feeds to update detection rules and improve anomaly detection capabilities.
- Restore affected systems from clean backups to ensure no malicious code remains.
- Apply security patches and updates to all systems to mitigate vulnerabilities exploited during the attack.
- Conduct a post-incident review to identify gaps in security controls and update incident response plans accordingly.
- Implement network segmentation and data loss prevention (DLP) measures to harden the environment against future exfiltration attempts."""
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1041"
name = "Exfiltration Over C2 Channel"
reference = "https://attack.mitre.org/techniques/T1041/"


[rule.threat.tactic]
id = "TA0010"
name = "Exfiltration"
reference = "https://attack.mitre.org/tactics/TA0010/"

