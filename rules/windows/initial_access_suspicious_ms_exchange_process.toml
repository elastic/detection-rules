[metadata]
creation_date = "2021/03/04"
integration = ["endpoint", "windows", "system", "m365_defender", "sentinel_one_cloud_funnel", "crowdstrike"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic", "Austin Songer"]
description = """
Identifies suspicious processes being spawned by the Microsoft Exchange Server Unified Messaging (UM) service. This
activity has been observed exploiting CVE-2021-26857.
"""
false_positives = [
    """
    Legitimate processes may be spawned from the Microsoft Exchange Server Unified Messaging (UM) service. If known
    processes are causing false positives, they can be exempted from the rule.
    """,
]
from = "now-9m"
index = [
    "logs-endpoint.events.process-*",
    "winlogbeat-*",
    "logs-windows.forwarded*",
    "logs-windows.sysmon_operational-*",
    "endgame-*",
    "logs-system.security*",
    "logs-m365_defender.event-*",
    "logs-sentinel_one_cloud_funnel.*",
    "logs-crowdstrike.fdr*",
]
language = "eql"
license = "Elastic License v2"
name = "Microsoft Exchange Server UM Spawning Suspicious Processes"
references = [
    "https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers",
    "https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities",
]
risk_score = 47
rule_id = "483c4daf-b0c6-49e0-adf3-0bfa93231d6b"
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Initial Access",
    "Tactic: Lateral Movement",
    "Data Source: Elastic Endgame",
    "Use Case: Vulnerability",
    "Data Source: Elastic Defend",
    "Data Source: System",
    "Data Source: Microsoft Defender for Endpoint",
    "Data Source: Sysmon",
    "Data Source: SentinelOne",
    "Data Source: Crowdstrike",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "windows" and event.type == "start" and
  process.parent.name : ("UMService.exe", "UMWorkerProcess.exe") and
    not process.executable : (
          "?:\\Windows\\System32\\werfault.exe",
          "?:\\Windows\\System32\\wermgr.exe",
          "?:\\Program Files\\Microsoft\\Exchange Server\\V??\\Bin\\UMWorkerProcess.exe",
          "?:\\Program Files\\Microsoft\\Exchange Server\\Bin\\UMWorkerProcess.exe",
          "D:\\Exchange 2016\\Bin\\UMWorkerProcess.exe",
          "E:\\ExchangeServer\\Bin\\UMWorkerProcess.exe",
          "D:\\Exchange\\Bin\\UMWorkerProcess.exe",
          "D:\\Exchange Server\\Bin\\UMWorkerProcess.exe",
          "E:\\Exchange Server\\V15\\Bin\\UMWorkerProcess.exe",
          "\\Device\\HarddiskVolume?\\Windows\\System32\\werfault.exe",
          "\\Device\\HarddiskVolume?\\Windows\\System32\\wermgr.exe",
          "\\Device\\HarddiskVolume?\\Program Files\\Microsoft\\Exchange Server\\V??\\Bin\\UMWorkerProcess.exe",
          "\\Device\\HarddiskVolume?\\Program Files\\Microsoft\\Exchange Server\\Bin\\UMWorkerProcess.exe",
          "\\Device\\HarddiskVolume?\\Exchange 2016\\Bin\\UMWorkerProcess.exe",
          "\\Device\\HarddiskVolume?\\ExchangeServer\\Bin\\UMWorkerProcess.exe",
          "\\Device\\HarddiskVolume?\\Exchange\\Bin\\UMWorkerProcess.exe",
          "\\Device\\HarddiskVolume?\\Exchange Server\\Bin\\UMWorkerProcess.exe",
          "\\Device\\HarddiskVolume?\\Exchange Server\\V15\\Bin\\UMWorkerProcess.exe"
    )
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Microsoft Exchange Server UM Spawning Suspicious Processes

Microsoft Exchange Server's Unified Messaging (UM) integrates voicemail and email, enhancing communication efficiency. However, adversaries can exploit vulnerabilities, such as CVE-2021-26857, to execute unauthorized processes. The detection rule identifies unusual processes initiated by UM services, excluding known legitimate executables, to flag potential exploitation attempts.

### Possible investigation steps

- Review the alert details to confirm the process name and executable path that triggered the alert, focusing on the `process.parent.name` and `process.executable` fields.
- Verify the legitimacy of the process by checking the parent process `UMService.exe` or `UMWorkerProcess.exe` against known legitimate executables listed in the detection rule.
- Cross-reference the process executable path with known Exchange Server installation paths to identify any anomalies or deviations.
- Use Osquery to list all processes spawned by `UMService.exe` or `UMWorkerProcess.exe` to identify any unexpected or suspicious processes:
  ```sql
  SELECT pid, name, path, cmdline FROM processes WHERE parent = (SELECT pid FROM processes WHERE name IN ('UMService.exe', 'UMWorkerProcess.exe'));
  ```
- Investigate the command line arguments (`cmdline`) of the suspicious process to gather more context about its execution.
- Check the process creation time and correlate it with any known suspicious activity or anomalies in the system logs.
- Examine the user account context under which the suspicious process was executed to determine if it aligns with expected behavior.
- Review recent security patches and updates applied to the Exchange Server to ensure CVE-2021-26857 and other vulnerabilities are addressed.
- Analyze network traffic logs for any unusual outbound connections initiated by the suspicious process to external IP addresses.
- Consult threat intelligence sources to determine if the identified process or behavior is associated with known threat actors or campaigns exploiting Exchange Server vulnerabilities.

### False positive analysis

- Known false positives may occur when legitimate administrative tools or scripts are executed by the UM services, which are not included in the predefined list of known executables. 
- Scheduled maintenance tasks or updates that involve UM services might trigger alerts if they spawn processes not recognized by the detection rule.
- Custom scripts or third-party applications integrated with Exchange Server for enhanced functionality could also be flagged if they initiate processes through UM services.
- To manage these false positives, users can create exceptions by adding the specific executable paths of these legitimate processes to the exclusion list within the detection rule.
- Regularly review and update the exclusion list to accommodate any new legitimate processes that are part of routine operations or maintenance activities.
- Collaborate with IT and security teams to identify and document any custom or third-party applications that interact with UM services to ensure they are accounted for in the detection rule.

### Response and remediation

- Isolate the affected Microsoft Exchange Server from the network to prevent further unauthorized access or lateral movement.
- Conduct a thorough investigation to identify any unauthorized processes or changes made by exploiting CVE-2021-26857, using forensic tools to analyze logs and system changes.
- Terminate any suspicious processes spawned by the UM service that are not part of the known legitimate executables list.
- Apply the latest security patches and updates from Microsoft to address CVE-2021-26857 and other known vulnerabilities.
- Restore the system from a clean backup taken before the compromise, ensuring that the backup is free from any malicious alterations.
- Implement enhanced logging policies to capture detailed process creation events and network activity for future investigations.
- Integrate security solutions such as Endpoint Detection and Response (EDR) and Intrusion Detection Systems (IDS) to monitor for similar threats.
- Escalate the incident to the security operations center (SOC) or relevant cybersecurity team for further analysis and to determine if additional systems are affected.
- Review and update firewall and access control policies to restrict unnecessary exposure of the Exchange Server to the internet.
- Conduct a post-incident review to identify gaps in security controls and update incident response plans to improve future response efforts."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1190"
name = "Exploit Public-Facing Application"
reference = "https://attack.mitre.org/techniques/T1190/"


[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1210"
name = "Exploitation of Remote Services"
reference = "https://attack.mitre.org/techniques/T1210/"


[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"

