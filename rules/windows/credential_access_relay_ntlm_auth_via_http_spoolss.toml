[metadata]
creation_date = "2022/04/30"
integration = ["endpoint", "windows", "system", "m365_defender", "sentinel_one_cloud_funnel", "crowdstrike"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
description = """
Identifies attempt to coerce a local NTLM authentication via HTTP using the Windows Printer Spooler service as a target.
An adversary may use this primitive in combination with other techniques to elevate privileges on a compromised system.
"""
from = "now-9m"
index = [
    "winlogbeat-*",
    "logs-endpoint.events.process-*",
    "logs-windows.forwarded*",
    "logs-windows.sysmon_operational-*",
    "endgame-*",
    "logs-system.security*",
    "logs-m365_defender.event-*",
    "logs-sentinel_one_cloud_funnel.*",
    "logs-crowdstrike.fdr*",
]
language = "eql"
license = "Elastic License v2"
name = "Potential Local NTLM Relay via HTTP"
references = [
    "https://github.com/med0x2e/NTLMRelay2Self",
    "https://github.com/topotam/PetitPotam",
    "https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py",
]
risk_score = 73
rule_id = "4682fd2c-cfae-47ed-a543-9bed37657aa6"
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Tactic: Defense Evasion",
    "Data Source: Elastic Endgame",
    "Data Source: Elastic Defend",
    "Data Source: System",
    "Data Source: Microsoft Defender for Endpoint",
    "Data Source: Sysmon",
    "Data Source: SentinelOne",
    "Data Source: Crowdstrike",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "windows" and event.type == "start" and
  process.name : "rundll32.exe" and

  /* Rundll32 WbeDav Client  */
  process.args : ("?:\\Windows\\System32\\davclnt.dll,DavSetCookie", "?:\\Windows\\SysWOW64\\davclnt.dll,DavSetCookie") and

  /* Access to named pipe via http */
  process.args : ("http*/print/pipe/*", "http*/pipe/spoolss", "http*/pipe/srvsvc")
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Local NTLM Relay via HTTP

NTLM, a suite of Microsoft security protocols, is often targeted by adversaries for credential theft. Attackers may exploit the Windows Printer Spooler service to coerce NTLM authentication over HTTP, potentially elevating privileges. The detection rule identifies suspicious rundll32.exe executions invoking WebDAV client DLLs with specific arguments, indicating attempts to access named pipes via HTTP, a hallmark of NTLM relay attacks.

### Possible investigation steps

- Review the alert details to confirm the presence of suspicious `rundll32.exe` executions with arguments pointing to `davclnt.dll` and HTTP access patterns, as specified in the detection rule.
- Verify the process start event to ensure it matches the criteria: `process.name` as "rundll32.exe" and `process.args` containing paths to `davclnt.dll` and HTTP named pipe access.
- Check the parent process of `rundll32.exe` to determine if it was spawned by a legitimate process or if it indicates malicious activity.
- Investigate the user account associated with the process execution to determine if it is a privileged account or if there are signs of compromise.
- Use Osquery to list all processes related to `rundll32.exe` and their network connections to identify any unusual or unauthorized network activity:
  ```sql
  SELECT pid, name, path, cmdline, parent, uid, gid FROM processes WHERE name = 'rundll32.exe';
  ```
- Examine the system's event logs for any related authentication events or anomalies around the time of the alert to gather additional context.
- Analyze network traffic logs to identify any external connections made by the system that could indicate data exfiltration or communication with a command and control server.
- Cross-reference the alert with any recent changes or updates to the system that might explain the behavior, such as software installations or configuration changes.
- Investigate other systems within the network for similar alerts or suspicious activity to determine if this is an isolated incident or part of a broader attack.
- Consult threat intelligence sources to check for any known campaigns or threat actors that utilize similar techniques, which could provide additional context for the investigation.

### False positive analysis

- Legitimate software or system processes may invoke `rundll32.exe` with WebDAV client DLLs for valid operations, such as network file access or synchronization tasks, which can trigger the detection rule.
- System administrators or automated scripts might use similar command patterns for maintenance or configuration purposes, leading to false positives.
- To manage these false positives, users can create exceptions for known benign processes or scripts by whitelisting specific command-line arguments or process hashes that are verified as non-threatening.
- Regularly review and update the exception list to ensure it reflects the current environment and does not inadvertently exclude new or modified malicious activities.
- Consider implementing additional context checks, such as verifying the source and destination of the HTTP requests, to differentiate between legitimate and suspicious activities.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or lateral movement.
- Conduct a thorough investigation to confirm the NTLM relay attack by reviewing logs and identifying any unauthorized access or changes.
- Terminate any suspicious rundll32.exe processes that match the detection criteria to stop ongoing malicious activities.
- Reset credentials for any accounts that may have been compromised during the attack to prevent further unauthorized access.
- Escalate the incident to the security operations center (SOC) or incident response team for a comprehensive analysis and response.
- Implement enhanced logging policies to capture detailed process execution and network activity, focusing on rundll32.exe and NTLM authentication events.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to improve detection and correlation of similar threats in the future.
- Restore the system to its operational state by applying the latest security patches and updates, particularly for the Windows Printer Spooler service.
- Conduct a security audit of the network to identify and remediate any other potential vulnerabilities that could be exploited in similar attacks.
- Implement hardening measures such as disabling unnecessary services, enforcing strong authentication mechanisms, and applying the principle of least privilege to reduce the attack surface."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1212"
name = "Exploitation for Credential Access"
reference = "https://attack.mitre.org/techniques/T1212/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1218"
name = "System Binary Proxy Execution"
reference = "https://attack.mitre.org/techniques/T1218/"
[[rule.threat.technique.subtechnique]]
id = "T1218.011"
name = "Rundll32"
reference = "https://attack.mitre.org/techniques/T1218/011/"



[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

