[metadata]
creation_date = "2020/11/25"
integration = ["endpoint", "windows", "sentinel_one_cloud_funnel", "m365_defender"]
maturity = "production"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."
min_stack_version = "8.14.0"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies registry write modifications to hide an encoded portable executable. This could be indicative of adversary
defense evasion by avoiding the storing of malicious content directly on disk.
"""
from = "now-9m"
index = ["logs-endpoint.events.registry-*", "endgame-*", "logs-windows.sysmon_operational-*", "logs-sentinel_one_cloud_funnel.*", "winlogbeat-*", "logs-m365_defender.event-*"]
language = "eql"
license = "Elastic License v2"
name = "Encoded Executable Stored in the Registry"
risk_score = 47
rule_id = "93c1ce76-494c-4f01-8167-35edfb52f7b1"
severity = "medium"
tags = ["Domain: Endpoint", "OS: Windows", "Use Case: Threat Detection", "Tactic: Defense Evasion", "Data Source: Elastic Endgame", "Data Source: Elastic Defend", "Data Source: Sysmon", "Data Source: SentinelOne", "Data Source: Microsoft Defender for Endpoint"]
timestamp_override = "event.ingested"
type = "eql"

query = '''
registry where host.os.type == "windows" and
/* update here with encoding combinations */
 registry.data.strings : "TVqQAAMAAAAEAAAA*"
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Encoded Executable Stored in the Registry

Windows Registry is a critical system database that stores configuration settings and options. Adversaries may exploit it to hide encoded executables, evading detection by avoiding direct disk storage. The detection rule identifies suspicious registry modifications by searching for specific encoded patterns, indicating potential defense evasion tactics. This helps analysts pinpoint and investigate hidden threats effectively.

### Possible investigation steps

- Review the alert details to identify the specific registry path and key where the encoded executable was detected. This information is crucial for understanding the scope and potential impact.
- Use the registry path and key information to perform a manual inspection of the registry entry. Verify the presence of the encoded data and assess its legitimacy.
- Decode the identified encoded string to determine if it corresponds to a known malicious executable or if it appears suspicious. Utilize tools or scripts capable of decoding base64 or other encoding schemes.
- Cross-reference the decoded executable with known malware signatures or hashes using threat intelligence databases to identify any matches with known threats.
- Investigate the process that made the registry modification by correlating the timestamp of the registry change with process creation logs. This can help identify the responsible process or user.
- Utilize Osquery to gather additional context about the system. For example, run the following query to list recent registry modifications: `SELECT * FROM registry WHERE path LIKE 'HKEY_LOCAL_MACHINE\\\\%\\\\%';`
- Check for any associated network activity around the time of the registry modification. Look for unusual outbound connections that might indicate data exfiltration or command and control communication.
- Examine the system for other indicators of compromise, such as unusual scheduled tasks, startup items, or services that could be related to the encoded executable.
- Review user activity logs to determine if the registry modification aligns with legitimate user actions or if it appears to be unauthorized or suspicious.
- Consult with other security tools and logs, such as endpoint detection and response (EDR) solutions, to gather additional insights and corroborate findings from the registry investigation.

### False positive analysis

- Legitimate software installations or updates may modify the registry with encoded data, which could trigger the detection rule. Users should verify the source and purpose of such modifications to determine if they are benign.
- Some security tools or system management software might store encoded executables in the registry as part of their normal operation. Users can create exceptions for these known applications to prevent unnecessary alerts.
- Custom scripts or administrative tools developed in-house may use encoded registry entries for configuration or deployment purposes. It is advisable to document these practices and exclude them from the detection rule if they are verified as non-threatening.
- Regularly review and update the list of exceptions to ensure that only verified and trusted software is excluded, maintaining a balance between security and operational efficiency.

### Response and remediation

- Isolate the affected system from the network to prevent further spread of the potential threat.
- Conduct a thorough investigation of the registry modifications to confirm the presence of encoded executables and identify the scope of the compromise.
- Utilize endpoint detection and response (EDR) tools to scan for additional indicators of compromise (IOCs) related to the identified threat.
- Remove or revert unauthorized registry changes to eliminate the persistence mechanism used by the adversary.
- Restore affected systems from known good backups to ensure the removal of any hidden malicious executables.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and threat intelligence correlation.
- Implement enhanced logging policies to capture detailed registry activity and monitor for similar suspicious patterns in the future.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to improve detection capabilities for registry-based threats.
- Apply security patches and updates to the operating system and applications to mitigate vulnerabilities that could be exploited by similar threats.
- Educate users on recognizing and reporting suspicious activities to reduce the risk of future incidents involving registry modifications."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1112"
name = "Modify Registry"
reference = "https://attack.mitre.org/techniques/T1112/"

[[rule.threat.technique]]
id = "T1140"
name = "Deobfuscate/Decode Files or Information"
reference = "https://attack.mitre.org/techniques/T1140/"


[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

