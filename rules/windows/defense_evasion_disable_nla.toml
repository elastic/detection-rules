[metadata]
creation_date = "2023/08/25"
integration = ["endpoint", "m365_defender", "sentinel_one_cloud_funnel", "windows"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
description = """
Identifies the attempt to disable Network-Level Authentication (NLA) via registry modification. Network Level
Authentication (NLA) is a feature on Windows that provides an extra layer of security for Remote Desktop (RDP)
connections, as it requires users to authenticate before allowing a full RDP session. Attackers can disable NLA to
enable persistence methods that require access to the Windows sign-in screen without authenticating, such as
Accessibility Features persistence methods, like Sticky Keys.
"""
from = "now-9m"
index = ["logs-endpoint.events.registry-*", "endgame-*", "logs-m365_defender.event-*", "logs-sentinel_one_cloud_funnel.*", "logs-windows.sysmon_operational-*"]
language = "eql"
license = "Elastic License v2"
name = "Network-Level Authentication (NLA) Disabled"
references = [
    "https://www.microsoft.com/en-us/security/blog/2023/08/24/flax-typhoon-using-legitimate-software-to-quietly-access-taiwanese-organizations/",
]
risk_score = 21
rule_id = "db65f5ba-d1ef-4944-b9e8-7e51060c2b42"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Defense Evasion",
    "Data Source: Elastic Defend",
    "Data Source: Elastic Endgame",
    "Data Source: Microsoft Defender for Endpoint",
    "Data Source: SentinelOne",
    "Data Source: Sysmon",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
registry where host.os.type == "windows" and event.action != "deletion" and registry.value : "UserAuthentication" and
  registry.path : (
    "HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\UserAuthentication",
    "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\UserAuthentication",
    "MACHINE\\SYSTEM\\*ControlSet*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\UserAuthentication"
  ) and registry.data.strings :  ("0", "0x00000000")
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Network-Level Authentication (NLA) Disabled

Network-Level Authentication (NLA) enhances security for Remote Desktop Protocol (RDP) by requiring user authentication before establishing a session. Disabling NLA can allow attackers to exploit the Windows sign-in screen for persistence, bypassing authentication. The detection rule identifies registry changes that disable NLA, flagging potential unauthorized modifications indicative of malicious activity.

### Possible investigation steps

- Review the alert details to confirm the registry path and value changes, specifically checking for modifications to `HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\UserAuthentication` with values set to "0" or "0x00000000".
- Verify the timestamp of the registry change to determine when the modification occurred and correlate it with other events in the system logs around the same time.
- Identify the user account and process responsible for the registry modification by examining the event logs for the `event.action` field, ensuring it is not a deletion, and cross-referencing with the `host.os.type` to confirm it is a Windows system.
- Check for any recent logins or RDP sessions around the time of the registry change to identify potential unauthorized access attempts.
- Use Osquery to gather additional context on the system by running a query to list all recent registry changes: `SELECT * FROM registry WHERE path LIKE 'HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet%\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\UserAuthentication';`
- Investigate any other registry changes made by the same user or process to identify if there are additional unauthorized modifications.
- Examine the system's security and application logs for any suspicious activities or errors that might indicate an attempt to exploit the disabled NLA.
- Review network logs for unusual RDP connection attempts or traffic patterns that could suggest an attacker is attempting to exploit the disabled NLA.
- Check for the presence of known persistence mechanisms, such as modified Accessibility Features, that could be leveraged by an attacker after disabling NLA.
- Consult threat intelligence sources to determine if there are any known campaigns or malware that specifically target NLA settings for persistence or defense evasion.

### False positive analysis

- Legitimate administrative actions: System administrators may intentionally disable NLA for troubleshooting or compatibility reasons. To manage this, create exceptions for known administrative accounts or scheduled maintenance periods.
- Software updates or installations: Certain software updates or installations might modify registry settings, including NLA, as part of their process. Users can handle these by monitoring update schedules and excluding known software processes from triggering alerts.
- Group policy changes: Changes in group policies might inadvertently disable NLA across multiple systems. To address this, ensure that group policy changes are documented and approved, and exclude these changes from detection rules.
- Virtual machine templates: Cloning or deploying virtual machines from templates where NLA is disabled can trigger false positives. Users should verify template configurations and exclude these specific registry changes during deployment processes.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or lateral movement.
- Verify the registry change by checking the specified registry path to confirm if NLA has been disabled.
- Conduct a thorough investigation to identify any unauthorized access or persistence mechanisms, such as checking for unusual user accounts or scheduled tasks.
- Restore the registry setting to enable NLA by setting the "UserAuthentication" value to "1" or "0x00000001".
- Review system and security logs to identify any suspicious activities or patterns that may indicate a broader compromise.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging policies to capture detailed RDP connection attempts and registry changes for future investigations.
- Integrate threat intelligence feeds and endpoint detection and response (EDR) solutions to improve detection capabilities for similar threats.
- Conduct a security audit of RDP configurations across the network to ensure compliance with security best practices, such as enforcing strong authentication and using VPNs for remote access.
- Educate users and administrators on the importance of NLA and other security measures to prevent similar incidents in the future."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1112"
name = "Modify Registry"
reference = "https://attack.mitre.org/techniques/T1112/"

[[rule.threat.technique]]
id = "T1562"
name = "Impair Defenses"
reference = "https://attack.mitre.org/techniques/T1562/"


[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

