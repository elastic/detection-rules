[metadata]
creation_date = "2024/06/03"
integration = ["system", "windows"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
description = """
Identifies the creation of a DNS record that is potentially meant to enable WPAD spoofing. Attackers can disable the
Global Query Block List (GQBL) and create a "wpad" record to exploit hosts running WPAD with default settings for
privilege escalation and lateral movement.
"""
from = "now-9m"
index = ["winlogbeat-*", "logs-system.*", "logs-windows.*"]
language = "eql"
license = "Elastic License v2"
name = "Potential WPAD Spoofing via DNS Record Creation"
references = [
    "https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/wpad-spoofing#through-adidns-spoofing",
    "https://cube0x0.github.io/Pocing-Beyond-DA/",
]
risk_score = 47
rule_id = "894326d2-56c0-4342-b553-4abfaf421b5b"
setup = """## Setup

The 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).
Steps to implement the logging policy with Advanced Audit Configuration:

```
Computer Configuration >
Policies >
Windows Settings >
Security Settings >
Advanced Audit Policies Configuration >
Audit Policies >
DS Access >
Audit Directory Service Changes (Success,Failure)
```

The above policy does not cover the target object by default (we still need it to be configured to generate events), so we need to set up an AuditRule using https://github.com/OTRF/Set-AuditRule.

```
Set-AuditRule -AdObjectPath 'AD:\\CN=MicrosoftDNS,DC=DomainDNSZones,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights CreateChild -InheritanceFlags Descendents -AttributeGUID e0fa1e8c-9b45-11d0-afdd-00c04fd930c9 -AuditFlags Success
```
"""
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Data Source: Active Directory",
    "Use Case: Active Directory Monitoring",
    "Data Source: System",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
any where host.os.type == "windows" and event.action in ("Directory Service Changes", "directory-service-object-modified") and
    event.code == "5137" and winlog.event_data.ObjectDN : "DC=wpad,*"
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential WPAD Spoofing via DNS Record Creation

Web Proxy Auto-Discovery (WPAD) helps devices automatically locate proxy configuration files, streamlining network management. However, attackers can exploit WPAD by creating malicious DNS records, tricking systems into using rogue proxies for data interception. The detection rule monitors Windows environments for suspicious DNS record changes, specifically targeting modifications that suggest WPAD spoofing attempts, thereby identifying potential security threats.

### Possible investigation steps

- Review the alert details to confirm the presence of the event code "5137" and the modification of the "DC=wpad,*" object in the event data, which indicates a DNS record change related to WPAD.
- Verify the identity of the user or process that initiated the DNS record change by examining the associated user account details in the event logs.
- Check the timestamp of the event to determine when the DNS record change occurred and correlate it with other suspicious activities in the network around the same time.
- Investigate the source IP address and hostname of the system where the DNS record change was initiated to assess if it is a known and trusted device within the network.
- Utilize Osquery to gather additional context on the system involved. For example, run the following Osquery query to list recent DNS changes: `SELECT * FROM dns_resolvers WHERE domain = 'wpad';`
- Examine the system's network configuration and proxy settings to identify any unauthorized or unexpected changes that could indicate WPAD exploitation.
- Cross-reference the event with other security logs, such as firewall or intrusion detection system logs, to identify any related network traffic anomalies or potential lateral movement attempts.
- Investigate any recent changes to the Global Query Block List (GQBL) settings on the affected system to determine if it was disabled or altered to facilitate WPAD spoofing.
- Review historical logs for similar DNS record changes or patterns that might suggest a broader or ongoing attack campaign targeting WPAD.
- Consult threat intelligence sources to determine if there are any known campaigns or threat actors currently exploiting WPAD vulnerabilities, and assess if the observed activity aligns with these threats.

### False positive analysis

- Legitimate network changes: Organizations may intentionally create or modify DNS records for WPAD as part of legitimate network configuration or updates. These changes can trigger the detection rule, leading to false positives. To manage this, users can maintain a list of authorized changes and compare them against detected events.
- Testing and development environments: In environments where network configurations are frequently tested or modified, such as development or testing labs, DNS record changes related to WPAD might be common and benign. Users can create exceptions for these environments to reduce noise.
- Third-party software: Some network management or security tools might automatically modify DNS records, including WPAD, as part of their operations. Identifying these tools and excluding their actions from the detection rule can help minimize false positives.
- Temporary network setups: During events like conferences or temporary setups, network administrators might create WPAD records to facilitate proxy configurations. Users should document these temporary changes and exclude them from triggering alerts.
- Regular audits and reviews: Conducting regular audits of DNS records and reviewing the detection rule's alerts can help distinguish between legitimate changes and potential threats, allowing users to refine exceptions over time.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further exploitation and data interception.
- Verify the presence of unauthorized "wpad" DNS records and remove them to mitigate the spoofing attempt.
- Conduct a thorough investigation to identify the source of the DNS record change, focusing on recent administrative activities and user accounts with elevated privileges.
- Review and re-enable the Global Query Block List (GQBL) if it has been disabled, ensuring that "wpad" is included to prevent future exploitation.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if additional systems are affected.
- Implement enhanced logging and monitoring for DNS changes and directory service modifications to detect similar threats in the future.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to correlate events and improve detection capabilities.
- Restore the system to its operational state by applying security patches, updating configurations, and conducting a full system scan to ensure no malware remains.
- Educate users and administrators on the risks associated with WPAD and the importance of maintaining secure DNS configurations.
- Review and update security policies and procedures to include specific measures against WPAD spoofing and related adversary-in-the-middle tactics."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1557"
name = "Adversary-in-the-Middle"
reference = "https://attack.mitre.org/techniques/T1557/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

