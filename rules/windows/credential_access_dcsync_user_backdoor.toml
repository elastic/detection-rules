[metadata]
creation_date = "2024/07/10"
integration = ["system", "windows"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
description = """
Identifies the modification of the nTSecurityDescriptor attribute in a domain object with rights related to DCSync to a
user/computer account. Attackers can use this backdoor to re-obtain access to hashes of any user/computer.
"""
from = "now-9m"
index = ["winlogbeat-*", "logs-system.security*", "logs-windows.forwarded*"]
language = "kuery"
license = "Elastic License v2"
name = "Potential Active Directory Replication Account Backdoor"
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Active Directory Replication Account Backdoor

Active Directory (AD) is a critical component in many enterprise environments, managing user and computer accounts. Adversaries may exploit AD by modifying security descriptors to grant replication rights to unauthorized accounts, enabling them to extract sensitive credential data. The detection rule identifies suspicious changes to the nTSecurityDescriptor attribute, which could indicate an attempt to establish a backdoor for credential access. By monitoring specific event codes and attribute modifications, the rule helps detect unauthorized replication rights assignments, potentially thwarting credential dumping activities.

### Possible investigation steps

- Review the alert details to confirm the presence of event code 5136, which indicates a directory service object modification, and verify that the modification involves the nTSecurityDescriptor attribute.
- Examine the specific user or computer account mentioned in the alert to determine if it has been granted unauthorized replication rights, focusing on the presence of the GUIDs: 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2, 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2, and 89e95b76-444d-4c62-991a-0facbeda640c.
- Check the security logs for any recent logins or activities associated with the suspicious account to identify any unusual patterns or behaviors.
- Use Osquery to gather additional context about the suspicious account by running a query such as: `SELECT * FROM users WHERE uid = '<suspicious_account_uid>';` to retrieve detailed information about the account.
- Investigate the history of changes to the nTSecurityDescriptor attribute for the affected domain object to identify any other unauthorized modifications or patterns.
- Correlate the alert with other security events or alerts in the environment to determine if this is part of a larger attack campaign or isolated incident.
- Review the Active Directory audit logs to identify any other accounts that may have been granted similar unauthorized replication rights.
- Analyze network traffic logs to detect any unusual data exfiltration activities that may be associated with the compromised account.
- Consult with the Active Directory administrators to verify if the changes were authorized or part of a legitimate administrative task.
- Document all findings and gather evidence to support further investigation or escalation to the appropriate security team.

### False positive analysis

- Routine administrative tasks: Changes to the nTSecurityDescriptor attribute may occur during legitimate administrative activities, such as when IT personnel update permissions for maintenance or configuration purposes. Users can handle these by identifying and excluding known administrative accounts or activities from the detection rule.
- Software updates and installations: Certain software updates or installations might modify security descriptors as part of their setup process. Users should maintain a list of trusted software and exclude these events when they coincide with known update schedules.
- Automated scripts and tools: Organizations often use automated scripts or tools for managing AD environments, which might trigger the rule. Users can create exceptions for these scripts by verifying their legitimacy and ensuring they are executed by authorized accounts.
- Third-party applications: Some third-party applications with legitimate access to AD might modify security descriptors as part of their functionality. Users should review and whitelist these applications after confirming their necessity and security compliance.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
- Conduct a thorough investigation to confirm the unauthorized modification of the nTSecurityDescriptor attribute and identify the compromised account.
- Review recent changes in Active Directory, focusing on accounts with elevated privileges and any unusual modifications to security descriptors.
- Revoke any unauthorized replication rights and reset passwords for affected accounts, ensuring they are strong and unique.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine the scope of the breach.
- Implement enhanced logging and monitoring for Active Directory changes, specifically targeting event code 5136 and modifications to the nTSecurityDescriptor attribute.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to correlate and detect similar threats in the future.
- Restore the system to its operational state by applying security patches, updating antivirus definitions, and ensuring all security controls are functioning correctly.
- Conduct a post-incident review to identify gaps in security controls and processes, and update incident response plans accordingly.
- Implement hardening measures such as least privilege access, regular audits of privileged accounts, and continuous security awareness training for administrators.

## Setup

The 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).
Steps to implement the logging policy with Advanced Audit Configuration:

```
Computer Configuration >
Policies >
Windows Settings >
Security Settings >
Advanced Audit Policies Configuration >
Audit Policies >
DS Access >
Audit Directory Service Changes (Success,Failure)
```
"""
references = [
    "https://twitter.com/menasec1/status/1111556090137903104",
    "https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf",
    "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_security_account_backdoor_dcsync_rights.yml",
    "https://learn.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes-all",
    "https://learn.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes",
    "https://learn.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes-in-filtered-set"
]
risk_score = 47
rule_id = "f8822053-a5d2-46db-8c96-d460b12c36ac"
severity = "medium"
tags = ["Domain: Endpoint", "OS: Windows", "Use Case: Threat Detection", "Tactic: Credential Access", "Data Source: Active Directory", "Use Case: Active Directory Monitoring", "Data Source: System"]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.action:("Directory Service Changes" or "directory-service-object-modified") and event.code:"5136" and
  winlog.event_data.AttributeLDAPDisplayName:"nTSecurityDescriptor" and
  winlog.event_data.AttributeValue : (
    (
      *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and
      *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and
      *89e95b76-444d-4c62-991a-0facbeda640c;;S-1-5-21-*
    )
  )
'''

[[rule.threat]]
framework = "MITRE ATT&CK"

  [[rule.threat.technique]]
  id = "T1003"
  reference = "https://attack.mitre.org/techniques/T1003/"
  name = "OS Credential Dumping"

    [[rule.threat.technique.subtechnique]]
    id = "T1003.006"
    reference = "https://attack.mitre.org/techniques/T1003/006/"
    name = "DCSync"


[rule.threat.tactic]
id = "TA0006"
reference = "https://attack.mitre.org/tactics/TA0006/"
name = "Credential Access"

