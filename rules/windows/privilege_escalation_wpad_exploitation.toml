[metadata]
creation_date = "2020/09/02"
integration = ["endpoint"]
maturity = "development"
updated_date = "2025/01/15"

[rule]
author = ["Elastic"]
description = """
Identifies probable exploitation of the Web Proxy Auto-Discovery Protocol (WPAD) service. Attackers who have access to
the local network or upstream DNS traffic can inject malicious JavaScript to the WPAD service which can lead to a full
system compromise.
"""
from = "now-9m"
index = ["logs-endpoint.events.process-*", "logs-endpoint.events.network-*", "logs-endpoint.events.library-*"]
language = "eql"
license = "Elastic License v2"
name = "WPAD Service Exploit"
risk_score = 73
rule_id = "ec328da1-d5df-482b-866c-4a435692b1f3"
severity = "high"
tags = ["Domain: Endpoint", "OS: Windows", "Use Case: Threat Detection", "Tactic: Privilege Escalation", "Data Source: Elastic Defend", "Resources: Investigation Guide"]
type = "eql"

query = '''
/* preference would be to use user.sid rather than domain+name, once it is available in ECS + datasources */
/* didn't trigger successfully during testing */

sequence with maxspan=5s
  [process where host.os.type == "windows" and event.type == "start" and process.name : "svchost.exe" and
     user.domain : "NT AUTHORITY" and user.name : "LOCAL SERVICE"] by process.entity_id
  [network where host.os.type == "windows" and network.protocol : "dns" and process.name : "svchost.exe" and
     dns.question.name : "wpad" and process.name : "svchost.exe"] by process.entity_id
  [network where host.os.type == "windows" and process.name : "svchost.exe"
     and network.direction : ("outgoing", "egress") and destination.port == 80] by process.entity_id
  [library where host.os.type == "windows" and event.type : "start" and process.name : "svchost.exe" and
     dll.name : "jscript.dll" and process.name : "svchost.exe"] by process.entity_id
  [process where host.os.type == "windows" and event.type == "start" and
     process.parent.name : "svchost.exe"] by process.parent.entity_id
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating WPAD Service Exploit

The Web Proxy Auto-Discovery Protocol (WPAD) helps devices on a network automatically find a proxy server. Adversaries can exploit WPAD by injecting malicious scripts into the service, potentially compromising systems. The detection rule identifies suspicious WPAD activity by monitoring specific processes and network behaviors, such as DNS queries and unusual DLL loads, to flag potential privilege escalation attempts.

### Possible investigation steps

- Review the process tree for the svchost.exe instance identified in the alert to understand its parent and child processes, focusing on any unusual or unexpected behavior.
- Analyze DNS query logs for the domain "wpad" to identify any suspicious or unauthorized requests, and cross-reference with known malicious domains.
- Examine network traffic logs for outgoing connections on port 80 from the svchost.exe process to detect any unauthorized data exfiltration or communication with suspicious external IP addresses.
- Investigate the loading of jscript.dll by svchost.exe to determine if there are any anomalies or signs of script execution that could indicate malicious activity.
- Check for any recent changes or anomalies in the user account associated with the LOCAL SERVICE domain, as this could indicate privilege escalation attempts.

### False positive analysis

- Legitimate network services using WPAD may trigger alerts if they perform DNS queries for "wpad" or communicate over port 80. To manage this, identify and whitelist known benign services that frequently use WPAD.
- Routine system updates or software installations might cause svchost.exe to load jscript.dll, leading to false positives. Monitor and document regular update schedules and exclude these time frames from triggering alerts.
- Some enterprise environments use custom scripts or applications that interact with WPAD for legitimate purposes. Review and document these applications, then create exceptions for their known behaviors to prevent unnecessary alerts.
- In environments with frequent DNS changes or testing, legitimate DNS queries for WPAD might be flagged. Establish a baseline of normal DNS activity and adjust the detection rule to accommodate expected patterns.
- If svchost.exe is commonly used by other legitimate processes in your network, consider refining the rule to include additional context or attributes that distinguish malicious from benign activity.

### Response and remediation

- Isolate the affected system from the network immediately to prevent further exploitation or lateral movement by the attacker.
- Terminate any suspicious svchost.exe processes identified in the alert to stop the execution of potentially malicious scripts.
- Conduct a thorough scan of the affected system using updated antivirus and anti-malware tools to identify and remove any malicious payloads or scripts.
- Review and reset any potentially compromised credentials, especially those associated with the LOCAL SERVICE account, to prevent unauthorized access.
- Apply security patches and updates to the operating system and all software to mitigate known vulnerabilities that could be exploited by similar attacks.
- Monitor network traffic for any further suspicious DNS queries or unusual outbound connections, particularly those involving the WPAD service, to detect any ongoing or new threats.
- Escalate the incident to the security operations center (SOC) or relevant IT security team for further investigation and to ensure comprehensive remediation and recovery efforts."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1068"
name = "Exploitation for Privilege Escalation"
reference = "https://attack.mitre.org/techniques/T1068/"


[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"

