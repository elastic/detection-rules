[metadata]
creation_date = "2020/09/02"
integration = ["endpoint"]
maturity = "development"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies probable exploitation of the Web Proxy Auto-Discovery Protocol (WPAD) service. Attackers who have access to
the local network or upstream DNS traffic can inject malicious JavaScript to the WPAD service which can lead to a full
system compromise.
"""
from = "now-9m"
index = ["logs-endpoint.events.process-*", "logs-endpoint.events.network-*", "logs-endpoint.events.library-*"]
language = "eql"
license = "Elastic License v2"
name = "WPAD Service Exploit"
risk_score = 73
rule_id = "ec328da1-d5df-482b-866c-4a435692b1f3"
severity = "high"
tags = ["Domain: Endpoint", "OS: Windows", "Use Case: Threat Detection", "Tactic: Privilege Escalation", "Data Source: Elastic Defend"]
type = "eql"

query = '''
/* preference would be to use user.sid rather than domain+name, once it is available in ECS + datasources */
/* didn't trigger successfully during testing */

sequence with maxspan=5s
  [process where host.os.type == "windows" and event.type == "start" and process.name : "svchost.exe" and
     user.domain : "NT AUTHORITY" and user.name : "LOCAL SERVICE"] by process.entity_id
  [network where host.os.type == "windows" and network.protocol : "dns" and process.name : "svchost.exe" and
     dns.question.name : "wpad" and process.name : "svchost.exe"] by process.entity_id
  [network where host.os.type == "windows" and process.name : "svchost.exe"
     and network.direction : ("outgoing", "egress") and destination.port == 80] by process.entity_id
  [library where host.os.type == "windows" and event.type : "start" and process.name : "svchost.exe" and
     dll.name : "jscript.dll" and process.name : "svchost.exe"] by process.entity_id
  [process where host.os.type == "windows" and event.type == "start" and
     process.parent.name : "svchost.exe"] by process.parent.entity_id
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating WPAD Service Exploit

The Web Proxy Auto-Discovery Protocol (WPAD) helps devices on a network automatically find a proxy server. Adversaries can exploit WPAD by injecting malicious scripts into the service, potentially compromising systems. The detection rule identifies suspicious WPAD activity by monitoring specific processes and network behaviors, such as DNS queries and unauthorized script execution, to flag potential exploits.

### Possible investigation steps

- Review the alert details to confirm the presence of the WPAD Service Exploit by checking the sequence of events, particularly focusing on the `process.entity_id` and `process.parent.entity_id` fields to trace the process lineage.
- Examine the DNS queries for the "wpad" domain by analyzing the `dns.question.name` field to identify any unusual or unauthorized requests that could indicate malicious activity.
- Investigate the network activity associated with `svchost.exe` by reviewing the `network.direction` and `destination.port` fields to ensure that the outgoing traffic on port 80 is legitimate and expected.
- Check the execution of `jscript.dll` by `svchost.exe` using the `dll.name` field to determine if there is any unauthorized script execution that could be part of the exploit.
- Use Osquery to gather additional context on the `svchost.exe` process. Example query: `SELECT pid, name, path, cmdline FROM processes WHERE name = 'svchost.exe';` to verify the command line arguments and path for any anomalies.
- Correlate the `user.domain` and `user.name` fields to ensure that the process is running under the expected user context, specifically "NT AUTHORITY\\LOCAL SERVICE", and investigate any deviations.
- Analyze the parent-child process relationship using the `process.parent.name` field to identify any unusual process spawning from `svchost.exe` that could indicate exploitation.
- Review historical logs for similar patterns of activity involving `svchost.exe` and `jscript.dll` to determine if this is an isolated incident or part of a broader attack pattern.
- Investigate any other network connections initiated by `svchost.exe` around the time of the alert to identify potential command and control communication or data exfiltration attempts.
- Cross-reference the alert with other security tools and logs to gather additional context and corroborate findings, focusing on any indicators of compromise related to privilege escalation or exploitation attempts.

### False positive analysis

- Legitimate network configurations may trigger the WPAD Service Exploit rule, such as environments where WPAD is used for legitimate proxy configuration. In such cases, frequent DNS queries for "wpad" and subsequent network activity may be normal and not indicative of an exploit.
- Automated software updates or network management tools that utilize WPAD for configuration purposes can also generate similar patterns of activity, leading to false positives.
- To manage these false positives, users can create exceptions for known benign processes or network behaviors by whitelisting specific DNS queries or network traffic patterns associated with trusted applications.
- Monitoring and logging should be adjusted to differentiate between expected WPAD traffic and potentially malicious activity, ensuring that only suspicious deviations from the norm are flagged.
- Regularly review and update the exclusion list to accommodate changes in network infrastructure or software updates that may alter legitimate WPAD usage patterns.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further exploitation and lateral movement.
- Conduct a thorough investigation to confirm the exploitation by reviewing DNS logs, network traffic, and process execution details related to WPAD activity.
- Terminate any suspicious processes associated with svchost.exe that are not part of legitimate system operations.
- Remove any unauthorized scripts or injected code found within the WPAD service or related processes.
- Apply security patches and updates to the operating system and any vulnerable services to mitigate the exploitation risk.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine the scope of the compromise.
- Implement enhanced logging and monitoring for DNS queries, network traffic, and process execution to detect similar threats in the future.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to improve detection capabilities.
- Restore the system to its operational state by reinstalling affected services and verifying the integrity of system files.
- Harden the network by disabling WPAD if not needed, enforcing strict access controls, and educating users on the risks associated with automatic proxy discovery."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1068"
name = "Exploitation for Privilege Escalation"
reference = "https://attack.mitre.org/techniques/T1068/"


[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"

