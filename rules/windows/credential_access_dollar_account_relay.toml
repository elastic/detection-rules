[metadata]
creation_date = "2024/07/24"
integration = ["system", "windows"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
description = """
Identifies potential relay attacks against a domain controller (DC) by identifying authentication events using the
domain controller computer account coming from other hosts to the DC that owns the account. Attackers may relay the DC
hash after capturing it using forced authentication.
"""
from = "now-9m"
index = ["logs-system.security-*", "logs-windows.forwarded*", "winlogbeat-*"]
language = "eql"
license = "Elastic License v2"
name = "Potential Relay Attack against a Domain Controller"
references = [
    "https://github.com/p0dalirius/windows-coerced-authentication-methods",
    "https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications",
    "https://attack.mitre.org/techniques/T1187/",
]
risk_score = 21
rule_id = "263481c8-1e9b-492e-912d-d1760707f810"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Data Source: Elastic Defend",
    "Data Source: Active Directory",
    "Use Case: Active Directory Monitoring",
    "Data Source: System",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
authentication where host.os.type == "windows" and event.code in ("4624", "4625") and endswith~(user.name, "$") and
    winlog.event_data.AuthenticationPackageName : "NTLM" and winlog.logon.type : "network" and

    /* Filter for a machine account that matches the hostname */
    startswith~(host.name, substring(user.name, 0, -1)) and
    
    /* Verify if the Source IP belongs to the host */
    not endswith(string(source.ip), string(host.ip)) and
    source.ip != null and source.ip != "::1" and source.ip != "127.0.0.1"
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Relay Attack against a Domain Controller

Domain Controllers (DCs) are critical in managing authentication within Windows environments. Adversaries exploit this by capturing and relaying authentication hashes, particularly using NTLM, to gain unauthorized access. The detection rule identifies suspicious authentication attempts by checking for machine account logins from unexpected sources, indicating potential relay attacks. It focuses on network logon events and mismatched source IPs to flag anomalies.

### Possible investigation steps

- Review the alert details to confirm the event codes (4624 or 4625) and ensure they align with the suspicious authentication attempts.
- Verify the user.name field to confirm it ends with a "$", indicating a machine account, and check if it matches the host.name to ensure it is a legitimate account.
- Examine the winlog.event_data.AuthenticationPackageName field to confirm the use of NTLM, which is commonly exploited in relay attacks.
- Analyze the winlog.logon.type field to ensure the logon type is "network", as this is indicative of remote authentication attempts.
- Investigate the source.ip field to identify the origin of the authentication attempt and determine if it is unexpected or unauthorized.
- Cross-reference the source.ip with known IP addresses within the organization to identify any anomalies or unauthorized access points.
- Use Osquery to gather additional context on the source host by running a query such as: `SELECT * FROM logged_in_users WHERE host = '<source.ip>';` to identify any active sessions or unusual user activity.
- Check for any recent changes or anomalies in the domain controller's security logs that might correlate with the suspicious authentication attempt.
- Investigate any other recent alerts or incidents involving the same source.ip or user.name to identify potential patterns or repeated attack attempts.
- Collaborate with network and system administrators to gather additional network traffic logs or endpoint data that might provide further insights into the suspicious activity.

### False positive analysis

- Scheduled tasks or automated processes: Some environments may have scheduled tasks or automated processes that authenticate using machine accounts, which could trigger the rule. Users can handle these by identifying the specific tasks and excluding their source IPs from the detection rule.
- Backup or monitoring software: Certain backup or monitoring solutions may use machine accounts to authenticate with domain controllers, leading to false positives. Users should identify these software solutions and create exceptions for their known IP addresses.
- Load balancers or proxy servers: In environments where load balancers or proxy servers are used, the source IP may not match the expected host IP, causing false positives. Users can exclude the IPs of these devices from the rule to prevent unnecessary alerts.
- Legitimate cross-domain authentication: In some cases, legitimate cross-domain authentication might appear suspicious if machine accounts are used. Users should verify such activities and whitelist the involved IPs if they are deemed non-threatening.
- Testing or development environments: Activities in testing or development environments might mimic suspicious behavior. Users should consider excluding these environments from the rule or adjusting the rule parameters to reduce false positives.

### Response and remediation

- Immediately isolate the affected domain controller from the network to prevent further unauthorized access.
- Conduct a thorough investigation to identify the source of the relay attack, focusing on the mismatched source IPs and machine account logins.
- Reset the passwords for all potentially compromised accounts, especially those associated with the domain controller.
- Review and analyze logs from the domain controller and other relevant systems to trace the attack path and identify any additional compromised systems.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if the attack is part of a larger campaign.
- Implement enhanced logging policies to capture detailed authentication events and network traffic, ensuring that NTLM authentication attempts are closely monitored.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to correlate events and detect similar threats in the future.
- Restore the domain controller to its operational state by applying the latest security patches and updates, and verify the integrity of system files and configurations.
- Harden the domain controller by disabling NTLM where possible, enforcing strong password policies, and implementing multi-factor authentication (MFA) for administrative access.
- Conduct a post-incident review to identify gaps in the current security posture and update incident response plans to improve readiness for future attacks."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1187"
name = "Forced Authentication"
reference = "https://attack.mitre.org/techniques/T1187/"

[[rule.threat.technique]]
id = "T1557"
name = "Adversary-in-the-Middle"
reference = "https://attack.mitre.org/techniques/T1557/"
[[rule.threat.technique.subtechnique]]
id = "T1557.001"
name = "LLMNR/NBT-NS Poisoning and SMB Relay"
reference = "https://attack.mitre.org/techniques/T1557/001/"


[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

