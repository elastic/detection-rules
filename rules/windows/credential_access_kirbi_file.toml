[metadata]
creation_date = "2023/08/23"
integration = ["endpoint", "windows", "sentinel_one_cloud_funnel", "m365_defender", "crowdstrike"]
maturity = "production"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."
min_stack_version = "8.14.0"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies the creation of .kirbi files. The creation of this kind of file is an indicator of an attacker running
Kerberos ticket dump utilities, such as Mimikatz, and precedes attacks such as Pass-The-Ticket (PTT), which allows the
attacker to impersonate users using Kerberos tickets.
"""
from = "now-9m"
index = ["logs-endpoint.events.file-*", "logs-windows.sysmon_operational-*", "logs-sentinel_one_cloud_funnel.*", "logs-m365_defender.event-*", "winlogbeat-*", "endgame-*", "logs-crowdstrike.fdr*"]
language = "eql"
license = "Elastic License v2"
name = "Kirbi File Creation"
risk_score = 73
rule_id = "b8f8da2d-a9dc-48c0-90e4-955c0aa1259a"
severity = "high"
tags = ["Domain: Endpoint", "OS: Windows", "Use Case: Threat Detection", "Tactic: Credential Access", "Data Source: Elastic Defend", "Data Source: Sysmon", "Data Source: SentinelOne", "Data Source: Microsoft Defender for Endpoint", "Data Source: Elastic Endgame", "Data Source: Crowdstrike"]
timestamp_override = "event.ingested"
type = "eql"

query = '''
file where host.os.type == "windows" and event.type == "creation" and file.extension : "kirbi"
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Kirbi File Creation

Kirbi files are associated with Kerberos, a network authentication protocol used to verify user identities. Attackers exploit this by using tools like Mimikatz to extract Kerberos tickets, enabling unauthorized access through techniques like Pass-The-Ticket. The detection rule identifies the creation of these files on Windows systems, signaling potential credential dumping activities.

### Possible investigation steps

- Verify the alert by checking the file creation event details, focusing on the `host.os.type`, `event.type`, and `file.extension` fields to confirm the presence of a `.kirbi` file on a Windows system.
- Identify the user account associated with the file creation event to determine if it aligns with expected behavior or if it might be compromised.
- Review recent login activities for the identified user account to detect any unusual or unauthorized access patterns.
- Examine the process that created the `.kirbi` file by correlating with process creation logs to identify the parent process and command line arguments used.
- Use Osquery to gather more context about the system by running a query such as: `SELECT * FROM processes WHERE name = 'mimikatz.exe';` to check for the presence of known Kerberos ticket dumping tools.
- Investigate the timeline of events leading up to the file creation by reviewing other security logs and alerts from the same host for any signs of suspicious activity.
- Check for any network connections initiated by the host around the time of the file creation to identify potential lateral movement or data exfiltration attempts.
- Analyze the file path and directory where the `.kirbi` file was created to determine if it is a common location for legitimate Kerberos tickets or if it appears suspicious.
- Review any recent changes to user privileges or group memberships on the host to identify potential privilege escalation activities.
- Correlate the alert with other security incidents or alerts in the environment to assess if this is part of a broader attack campaign.

### False positive analysis

- Legitimate administrative tools or scripts that manage Kerberos tickets might create .kirbi files as part of their normal operations. These tools are often used by IT departments for troubleshooting or managing authentication processes.
- Scheduled tasks or automated processes that involve Kerberos ticket management could also result in the creation of .kirbi files. These tasks might be part of regular system maintenance or security monitoring activities.
- Security software or endpoint detection and response (EDR) solutions that simulate attacks for testing purposes might generate .kirbi files to evaluate system defenses.
- To manage these false positives, users can create exceptions for specific processes or directories known to generate .kirbi files as part of legitimate activities. This can be done by updating the detection rule to exclude certain file paths or process names associated with trusted applications.
- Regularly review and update the list of exceptions to ensure that only verified and non-threatening behaviors are excluded, maintaining a balance between security and operational efficiency.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access and lateral movement.
- Conduct a thorough investigation to identify the source of the .kirbi file creation, including reviewing recent user activity and system logs.
- Use forensic tools to analyze the system for additional signs of compromise, such as unauthorized user accounts or suspicious processes.
- Reset passwords for all potentially compromised accounts, focusing on those with elevated privileges.
- Remove any unauthorized Kerberos tickets and terminate any suspicious sessions or processes identified during the investigation.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine the scope of the breach.
- Implement enhanced logging policies to capture detailed authentication events and file creation activities, ensuring future incidents can be detected more effectively.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to correlate and analyze security events in real-time.
- Restore the system to its operational state by applying security patches, updating antivirus definitions, and ensuring all security configurations are in place.
- Harden the environment by implementing least privilege access controls, enabling multi-factor authentication, and conducting regular security awareness training for users."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1003"
name = "OS Credential Dumping"
reference = "https://attack.mitre.org/techniques/T1003/"

[[rule.threat.technique]]
id = "T1558"
name = "Steal or Forge Kerberos Tickets"
reference = "https://attack.mitre.org/techniques/T1558/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

