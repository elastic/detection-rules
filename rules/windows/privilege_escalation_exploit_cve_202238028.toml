[metadata]
creation_date = "2024/04/23"
integration = ["endpoint", "windows", "m365_defender", "sentinel_one_cloud_funnel"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
description = "Identifies a privilege escalation attempt via exploiting CVE-2022-38028 to hijack the print spooler service execution.\n"
from = "now-9m"
index = ["logs-endpoint.events.file-*", "logs-windows.sysmon_operational-*", "endgame-*", "winlogbeat-*", "logs-m365_defender.event-*", "logs-sentinel_one_cloud_funnel.*"]
language = "eql"
license = "Elastic License v2"
name = "Potential privilege escalation via CVE-2022-38028"
references = [
    "https://www.microsoft.com/en-us/security/blog/2024/04/22/analyzing-forest-blizzards-custom-post-compromise-tool-for-exploiting-cve-2022-38028-to-obtain-credentials/",
]
risk_score = 73
rule_id = "dffbd37c-d4c5-46f8-9181-5afdd9172b4c"
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Privilege Escalation",
    "Tactic: Defense Evasion",
    "Data Source: Elastic Endgame",
    "Data Source: Elastic Defend",
    "Data Source: Sysmon",
    "Data Source: Microsoft Defender for Endpoint",
    "Data Source: SentinelOne",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
file where host.os.type == "windows" and event.type != "deletion" and
    file.name : "MPDW-constraints.js" and
    file.path : (
        "?:\\*\\Windows\\system32\\DriVerStoRe\\FiLeRePoSiToRy\\*\\MPDW-constraints.js",
        "?:\\*\\Windows\\WinSxS\\amd64_microsoft-windows-printing-printtopdf_*\\MPDW-constraints.js"
    )
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential privilege escalation via CVE-2022-38028

CVE-2022-38028 targets the Windows Print Spooler service, a core component managing print jobs. Adversaries exploit this by manipulating specific JavaScript files within system directories to gain elevated privileges. The detection rule identifies unauthorized modifications to these files, signaling potential exploitation attempts, thus enabling timely intervention.

### Possible investigation steps

- Review the alert details to confirm the file name and path match those specified in the detection query: "MPDW-constraints.js" within the specified system directories.
- Verify the event type to ensure it is not a deletion event, as the query excludes such events.
- Check the file modification timestamps to determine when the unauthorized changes occurred and correlate with any known user activity or scheduled tasks.
- Investigate the user account associated with the file modification event to assess if it has the necessary permissions and if the activity aligns with their typical behavior.
- Use Osquery to gather additional context on the file by running a query such as: `SELECT * FROM file WHERE path LIKE 'C:\\\\Windows\\\\system32\\\\DriVerStoRe\\\\FiLeRePoSiToRy\\\\%\\\\MPDW-constraints.js' OR path LIKE 'C:\\\\Windows\\\\WinSxS\\\\amd64_microsoft-windows-printing-printtopdf_%\\\\MPDW-constraints.js';` to verify file attributes and metadata.
- Examine recent system logs for any unusual or suspicious activities around the time of the file modification, focusing on print spooler service logs and security logs.
- Cross-reference the event with any other alerts or incidents involving the same host to identify potential patterns or related activities.
- Investigate any network connections or external communications from the host around the time of the event to detect possible data exfiltration or command and control activities.
- Check for any recent software installations or updates on the host that might have inadvertently or maliciously modified the file.
- Consult threat intelligence sources to determine if there are any known campaigns or threat actors currently exploiting CVE-2022-38028, which could provide additional context or indicators of compromise.

### False positive analysis

- Routine system updates or legitimate software installations may modify the `MPDW-constraints.js` file, triggering the detection rule. Users should verify if these changes coincide with scheduled updates or trusted software installations.
- Security software or system maintenance tools might access or modify the `MPDW-constraints.js` file as part of their normal operations. Users can create exceptions for these known tools to prevent false alerts.
- Custom scripts or administrative tasks that interact with the print spooler service or related files could inadvertently trigger the rule. Users should document and exclude these scripts if they are verified as non-threatening.
- To manage false positives, users can implement a whitelist of known, legitimate processes or applications that are allowed to modify the `MPDW-constraints.js` file, ensuring that only unauthorized changes are flagged.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further exploitation and lateral movement.
- Conduct a thorough investigation to confirm unauthorized modifications to the specified JavaScript files and identify any other compromised files or services.
- Utilize endpoint detection and response (EDR) tools to scan for additional indicators of compromise (IOCs) related to CVE-2022-38028.
- Revert any unauthorized changes to the JavaScript files by restoring them from a known good backup or reinstalling the affected components.
- Apply the latest security patches and updates from Microsoft to address CVE-2022-38028 and other known vulnerabilities.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if other systems are affected.
- Implement enhanced logging and monitoring policies to capture detailed file access and modification events, focusing on critical system directories.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to improve detection capabilities for similar threats.
- Conduct a post-incident review to identify gaps in security controls and update incident response plans accordingly.
- Strengthen system hardening measures by disabling unnecessary services, enforcing least privilege access, and regularly auditing system configurations."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1068"
name = "Exploitation for Privilege Escalation"
reference = "https://attack.mitre.org/techniques/T1068/"


[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1036"
name = "Masquerading"
reference = "https://attack.mitre.org/techniques/T1036/"


[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

