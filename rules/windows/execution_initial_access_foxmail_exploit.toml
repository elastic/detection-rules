[metadata]
creation_date = "2024/08/29"
integration = ["endpoint", "windows", "system", "sentinel_one_cloud_funnel", "m365_defender", "crowdstrike"]
maturity = "production"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."
min_stack_version = "8.14.0"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies the Foxmail client spawning a child process with argument pointing to the Foxmail temp directory. 
This may indicate the successful exploitation of a Foxmail vulnerability for initial access and execution via 
a malicious email.
"""
from = "now-9m"
index = [
    "winlogbeat-*",
    "logs-windows.*",
    "endgame-*",
    "logs-system.security*",
    "logs-windows.sysmon_operational-*",
    "logs-sentinel_one_cloud_funnel.*",
    "logs-m365_defender.event-*", 
    "logs-endpoint.events.process-*", 
    "logs-crowdstrike.fdr*"
]
language = "eql"
license = "Elastic License v2"
name = "Potential Foxmail Exploitation"
references = ["https://mp.weixin.qq.com/s/F8hNyESBdKhwXkQPgtGpew"]
risk_score = 73
rule_id = "2c6a6acf-0dcb-404d-89fb-6b0327294cfa"
severity = "high"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Initial Access",
    "Tactic: Execution",
    "Data Source: Elastic Defend",
    "Data Source: Sysmon", 
    "Data Source: System", 
    "Data Source: Elastic Endgame",
    "Data Source: SentinelOne",
    "Data Source: Microsoft Defender for Endpoint",
    "Data Source: Crowdstrike"
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "windows" and event.type == "start" and 
 process.parent.name : "Foxmail.exe" and process.args : ("?:\\Users\\*\\AppData\\*", "\\\\*")
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Foxmail Exploitation

Foxmail, a popular email client, manages emails and attachments, storing temporary files in specific directories. Adversaries may exploit vulnerabilities in Foxmail to execute malicious payloads by manipulating these temp files. The detection rule identifies suspicious child processes initiated by Foxmail, focusing on those accessing temp directories, which may indicate exploitation attempts for unauthorized execution.

### Possible investigation steps

- Review the alert details to confirm the presence of a child process spawned by Foxmail.exe, focusing on the process arguments that point to the temp directories (e.g., `?:\\Users\\*\\AppData\\*`).
- Verify the legitimacy of the parent process by checking the hash and signature of Foxmail.exe to ensure it hasn't been tampered with.
- Use Osquery to list all processes spawned by Foxmail.exe to identify any unusual or unexpected child processes. Example query: `SELECT pid, name, path, cmdline FROM processes WHERE parent = (SELECT pid FROM processes WHERE name = 'Foxmail.exe');`
- Investigate the specific child process identified in the alert by examining its command line arguments and execution path for any anomalies or suspicious patterns.
- Check the file creation and modification times in the temp directories accessed by the suspicious process to identify any recent changes that coincide with the alert.
- Analyze the network activity of the suspicious process to detect any unusual outbound connections that could indicate data exfiltration or command and control communication.
- Correlate the alert with other security events or logs, such as email gateway logs, to determine if a malicious email was received around the time of the alert.
- Review the user account associated with the Foxmail process to determine if there are any signs of compromise or unauthorized access.
- Examine the system for any additional indicators of compromise, such as registry changes, scheduled tasks, or persistence mechanisms that may have been established by the malicious process.
- Consult threat intelligence sources to identify if the observed behavior matches any known exploitation techniques or campaigns targeting Foxmail vulnerabilities.

### False positive analysis

- Routine software updates or legitimate plugins for Foxmail may trigger the detection rule by spawning child processes that access temporary directories. These updates or plugins often require temporary file storage and execution, which can mimic the behavior of exploitation attempts.
- Automated backup or synchronization tools that interact with Foxmail's temporary files might also be flagged as suspicious. These tools often access and modify files in the temp directories as part of their normal operation.
- Users can manage these false positives by creating exceptions for known legitimate processes or tools that frequently interact with Foxmail's temp directories. This can be done by identifying the specific process names or paths and excluding them from the detection rule.
- Monitoring the frequency and context of the alerts can help distinguish between benign and potentially malicious activities. If a process consistently triggers alerts but is verified as safe, it can be added to an allowlist to prevent future false positives.

### Response and remediation

- Isolate the affected system from the network to prevent further spread of the potential exploitation.
- Conduct a thorough investigation of the affected system to identify any malicious processes or files, focusing on the Foxmail temp directories.
- Terminate any suspicious child processes spawned by Foxmail and delete any malicious files identified during the investigation.
- Review email logs and quarantine any suspicious emails that may have been the source of the exploitation attempt.
- Apply the latest security patches and updates to Foxmail and the operating system to mitigate known vulnerabilities.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if other systems are affected.
- Implement enhanced logging policies to capture detailed process execution and file access events, particularly for email clients and temp directories.
- Integrate threat intelligence feeds to improve detection capabilities and stay informed about emerging threats related to email client vulnerabilities.
- Restore the system to its operational state by reinstalling Foxmail and restoring any affected files from clean backups.
- Conduct a security awareness training session for users to recognize and report suspicious emails, reducing the risk of future exploitation attempts."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1203"
name = "Exploitation for Client Execution"
reference = "https://attack.mitre.org/techniques/T1203/"


[rule.threat.tactic]
id = "TA0002"
name = "Execution"
reference = "https://attack.mitre.org/tactics/TA0002/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1189"
name = "Drive-by Compromise"
reference = "https://attack.mitre.org/techniques/T1189/"


[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"
