[metadata]
creation_date = "2022/11/09"
integration = ["system", "windows"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
description = """
Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as
unixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens.
"""
from = "now-9m"
index = ["winlogbeat-*", "logs-system.*", "logs-windows.*"]
language = "eql"
license = "Elastic License v2"
name = "Access to a Sensitive LDAP Attribute"
references = [
    "https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming",
    "https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx",
    "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662",
]
risk_score = 47
rule_id = "764c9fcd-4c4c-41e6-a0c7-d6c46c2eff66"
setup = """## Setup

The 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).
Steps to implement the logging policy with Advanced Audit Configuration:

```
Computer Configuration >
Policies >
Windows Settings >
Security Settings >
Advanced Audit Policies Configuration >
Audit Policies >
DS Access >
Audit Directory Service Access (Success,Failure)
```
"""
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Tactic: Privilege Escalation",
    "Use Case: Active Directory Monitoring",
    "Data Source: Active Directory",
    "Data Source: System",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
any where event.action in ("Directory Service Access", "object-operation-performed") and event.code == "4662" and

  not winlog.event_data.SubjectUserSid : "S-1-5-18" and

  winlog.event_data.Properties : (
   /* unixUserPassword */
  "*612cb747-c0e8-4f92-9221-fdd5f15b550d*",

  /* ms-PKI-AccountCredentials */
  "*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*",

  /*  ms-PKI-DPAPIMasterKeys */
  "*b3f93023-9239-4f7c-b99c-6745d87adbc2*",

  /* msPKI-CredentialRoamingTokens */
  "*b7ff5a38-0818-42b0-8110-d3d154c97f24*"
  ) and

  /*
   Excluding noisy AccessMasks
   0x0 undefined and 0x100 Control Access
   https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662
   */
  not winlog.event_data.AccessMask in ("0x0", "0x100")
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Access to a Sensitive LDAP Attribute

LDAP (Lightweight Directory Access Protocol) is crucial for managing and accessing directory services in Active Directory environments. Adversaries may exploit LDAP to access sensitive attributes like passwords and decryption keys, potentially leading to credential theft. The detection rule identifies suspicious access attempts by monitoring specific event codes and attribute identifiers, excluding benign activities to reduce false positives.

### Possible investigation steps

- Review the alert details to confirm the event code is "4662" and the event action is either "Directory Service Access" or "object-operation-performed" to ensure it matches the detection criteria.
- Verify the SubjectUserSid to ensure it is not "S-1-5-18", which is the SID for the Local System account, to rule out false positives from system processes.
- Examine the winlog.event_data.Properties field to identify which specific sensitive attribute was accessed, such as unixUserPassword, ms-PKI-AccountCredentials, ms-PKI-DPAPIMasterKeys, or msPKI-CredentialRoamingTokens.
- Check the winlog.event_data.AccessMask to ensure it is not "0x0" or "0x100", which are considered noisy and less indicative of malicious activity.
- Investigate the user account associated with the access attempt to determine if it has a legitimate reason to access the sensitive attribute.
- Use Osquery to gather additional context about the system from which the access attempt originated. For example, run the following query to list recent processes executed by the user:
  ```sql
  SELECT * FROM processes WHERE user = '<username>';
  ```
- Analyze the network traffic logs to identify any unusual connections or data transfers associated with the system or user involved in the alert.
- Review recent changes in the Active Directory environment to identify any modifications that could have facilitated unauthorized access to sensitive attributes.
- Correlate the alert with other security events or logs to identify patterns or additional indicators of compromise that may suggest a broader attack.
- Consult with relevant stakeholders or system owners to verify if the access attempt was part of a legitimate administrative task or if further investigation is warranted.

### False positive analysis

- Access by legitimate administrative accounts: Routine operations by system administrators may trigger the rule due to their need to access sensitive attributes. Users can handle this by creating exceptions for known administrative accounts or service accounts that regularly perform these actions.
- Scheduled tasks or automated scripts: Automated processes that require access to sensitive attributes for maintenance or updates might be flagged. To manage this, users should identify and exclude these tasks or scripts from the detection rule.
- Backup and recovery operations: Backup solutions that interact with directory services to secure sensitive data may cause false positives. Users should whitelist these operations by excluding the associated service accounts or processes.
- Security audits and compliance checks: Regular security assessments that involve accessing sensitive attributes can be mistaken for malicious activity. Users can mitigate this by excluding the accounts or tools used for these audits from the detection rule.
- Third-party applications: Some third-party applications may require access to sensitive LDAP attributes for functionality. Users should verify the legitimacy of these applications and exclude them if they are deemed non-threatening.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
- Conduct a thorough investigation to identify the source and scope of the breach, focusing on logs related to event code 4662 and the specific LDAP attributes accessed.
- Change passwords and revoke any potentially compromised credentials associated with the affected accounts, especially those with elevated privileges.
- Review and update access controls and permissions for sensitive LDAP attributes to ensure they are restricted to only necessary personnel.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and to determine if additional systems are affected.
- Implement enhanced logging and monitoring for LDAP access, focusing on sensitive attributes and unusual access patterns, to improve detection of future attempts.
- Integrate threat intelligence feeds and security information and event management (SIEM) systems to correlate events and identify potential indicators of compromise.
- Restore the affected system to its operational state by applying necessary patches, updates, and security configurations to prevent similar incidents.
- Conduct a post-incident review to identify gaps in security controls and processes, and update incident response plans accordingly.
- Educate and train staff on security best practices and the importance of safeguarding sensitive information to reduce the risk of future incidents."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1003"
name = "OS Credential Dumping"
reference = "https://attack.mitre.org/techniques/T1003/"

[[rule.threat.technique]]
id = "T1552"
name = "Unsecured Credentials"
reference = "https://attack.mitre.org/techniques/T1552/"
[[rule.threat.technique.subtechnique]]
id = "T1552.004"
name = "Private Keys"
reference = "https://attack.mitre.org/techniques/T1552/004/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"
[[rule.threat.technique.subtechnique]]
id = "T1078.002"
name = "Domain Accounts"
reference = "https://attack.mitre.org/techniques/T1078/002/"



[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"

