[metadata]
creation_date = "2020/11/03"
integration = ["endpoint", "sentinel_one_cloud_funnel"]
maturity = "production"
min_stack_comments = "Breaking change at 8.13.0 for SentinelOne Integration."
min_stack_version = "8.13.0"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies the deletion of sensitive Linux system logs. This may indicate an attempt to evade detection or destroy
forensic evidence on a system.
"""
from = "now-9m"
index = ["auditbeat-*", "logs-endpoint.events.*", "endgame-*", "logs-sentinel_one_cloud_funnel.*"]
language = "eql"
license = "Elastic License v2"
name = "System Log File Deletion"
references = [
    "https://www.fireeye.com/blog/threat-research/2020/11/live-off-the-land-an-overview-of-unc1945.html",
    "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security",
]
risk_score = 47
rule_id = "aa895aea-b69c-4411-b110-8d7599634b30"
setup = """## Setup

This rule requires data coming in from one of the following integrations:
- Elastic Defend
- Auditbeat

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).

### Auditbeat Setup
Auditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.

#### The following steps should be executed in order to add the Auditbeat on a Linux System:
- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.
- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).
- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).
- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).
- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).

#### Custom Ingest Pipeline
For versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).
"""
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Tactic: Defense Evasion",
    "Data Source: Elastic Endgame",
    "Data Source: Elastic Defend",
    "Data Source: SentinelOne",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
file where host.os.type == "linux" and event.type == "deletion" and
  file.path :
    (
    "/var/run/utmp",
    "/var/log/wtmp",
    "/var/log/btmp",
    "/var/log/lastlog",
    "/var/log/faillog",
    "/var/log/syslog",
    "/var/log/messages",
    "/var/log/secure",
    "/var/log/auth.log",
    "/var/log/boot.log",
    "/var/log/kern.log",
    "/var/log/dmesg"
    ) and
    not process.name in ("gzip", "executor", "dockerd")
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating System Log File Deletion

System logs in Linux environments are crucial for monitoring and forensic analysis, capturing events like user logins and system errors. Adversaries may delete these logs to hide their tracks and evade detection. The detection rule identifies such deletions by monitoring specific log file paths and filtering out benign processes, thus alerting analysts to potential malicious activity.

### Possible investigation steps

- Review the alert details to confirm the specific log file path that was deleted and the timestamp of the event.
- Check the process information associated with the deletion event, including the process ID, name, and user context, to identify any suspicious activity.
- Use Osquery to list recent processes executed on the system that could be related to the deletion event. Example query: `SELECT pid, name, path, cmdline FROM processes WHERE start_time > (SELECT datetime('now', '-1 hour'));`
- Investigate the user account associated with the deletion event to determine if it has a history of suspicious activity or if it was compromised.
- Examine other system logs for unusual activity around the time of the deletion, such as failed login attempts or unauthorized access.
- Correlate the deletion event with any recent changes in system configuration or software installations that could explain the log file removal.
- Check for any other alerts or indicators of compromise on the system that might suggest a broader attack or compromise.
- Investigate network activity from the host around the time of the log deletion to identify any potential data exfiltration or command-and-control communication.
- Review file integrity monitoring logs to determine if any other critical files were modified or deleted around the same time.
- Consult threat intelligence sources to see if the observed behavior matches any known attack patterns or threat actor tactics.

### False positive analysis

- Routine system maintenance tasks or log rotation processes may trigger false positives, as these operations can involve the deletion of log files to manage disk space and ensure system performance.
- Automated backup solutions might delete logs after archiving them, which could be misinterpreted as malicious activity.
- Certain system updates or administrative scripts may also delete or rotate logs as part of their normal operation, leading to false alerts.
- To manage these false positives, users can create exceptions for known benign processes involved in log management, such as logrotate or backup scripts, by adding them to the exclusion list in the detection rule.
- Regularly review and update the exclusion list to include any new legitimate processes that are identified as part of routine system operations, ensuring that only genuine threats trigger alerts.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further malicious activity and data exfiltration.
- Conduct a thorough investigation to determine the scope of the log deletion, identifying any other compromised systems or accounts.
- Review user activity and process execution logs to identify unauthorized access or suspicious behavior leading up to the log deletion.
- Restore deleted log files from backups if available, to aid in the forensic investigation and maintain historical data integrity.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging policies to ensure critical logs are backed up regularly and stored securely, reducing the risk of future deletions.
- Integrate additional security tools such as file integrity monitoring and endpoint detection and response (EDR) solutions to detect and alert on unauthorized file deletions.
- Apply system hardening measures, including disabling unnecessary services, applying security patches, and enforcing least privilege access controls.
- Conduct a post-incident review to identify gaps in security controls and update incident response plans accordingly.
- Educate users and administrators on the importance of system logs and the potential impact of their deletion, promoting a culture of security awareness."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1070"
name = "Indicator Removal"
reference = "https://attack.mitre.org/techniques/T1070/"
[[rule.threat.technique.subtechnique]]
id = "T1070.002"
name = "Clear Linux or Mac System Logs"
reference = "https://attack.mitre.org/techniques/T1070/002/"



[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

