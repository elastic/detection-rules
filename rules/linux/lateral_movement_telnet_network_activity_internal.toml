[metadata]
creation_date = "2020/04/23"
integration = ["endpoint", "sentinel_one_cloud_funnel"]
maturity = "production"
min_stack_version = "8.13.0"
min_stack_comments = "Breaking change at 8.13.0 for SentinelOne Integration."
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Telnet provides a command line interface for communication with a remote device or server. This rule identifies Telnet
network connections to non-publicly routable IP addresses.
"""
false_positives = [
    """
    Telnet can be used for both benign or malicious purposes. Telnet is included by default in some Linux distributions,
    so its presence is not inherently suspicious. The use of Telnet to manage devices remotely has declined in recent
    years in favor of more secure protocols such as SSH. Telnet usage by non-automated tools or frameworks may be
    suspicious.
    """,
]
from = "now-9m"
index = ["logs-endpoint.events.*", "logs-sentinel_one_cloud_funnel.*"]
language = "eql"
license = "Elastic License v2"
name = "Connection to Internal Network via Telnet"
references = ["https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"]
risk_score = 47
rule_id = "1b21abcc-4d9f-4b08-a7f5-316f5f94b973"
setup = """## Setup

This rule requires data coming in from one of the following integrations:
- Elastic Defend
- Auditbeat

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).

### Auditbeat Setup
Auditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.

#### The following steps should be executed in order to add the Auditbeat on a Linux System:
- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.
- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).
- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).
- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).
- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).
"""
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Tactic: Lateral Movement",
    "Data Source: Elastic Defend",
    "Data Source: SentinelOne",
]
type = "eql"

query = '''
sequence by process.entity_id
  [process where host.os.type == "linux" and process.name == "telnet" and event.type == "start"]
  [network where host.os.type == "linux" and process.name == "telnet" and cidrmatch(
     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
     "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10",
     "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
     "FF00::/8"
    )
  ]
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Connection to Internal Network via Telnet

Telnet is a protocol offering command-line access to remote systems, often used for network device management. However, its lack of encryption makes it vulnerable to interception and misuse by adversaries for lateral movement within a network. The detection rule identifies Telnet connections to private IP ranges, signaling potential unauthorized access attempts, aligning with MITRE ATT&CK's lateral movement tactics.

### Possible investigation steps

- Review the alert details to confirm the presence of a Telnet connection to a private IP address, focusing on the `process.entity_id`, `destination.ip`, and `event.type` fields.
- Verify the legitimacy of the Telnet process by checking the `process.name` and `host.os.type` fields to ensure it matches expected behavior for the system.
- Use Osquery to gather additional context about the Telnet process by running a query such as: `SELECT * FROM processes WHERE name = 'telnet';` to retrieve details like the process ID, user, and command line arguments.
- Investigate the source and destination IP addresses involved in the connection to determine if they belong to known or trusted devices within the network.
- Check historical logs for previous Telnet connections from the same source IP to identify patterns or repeated unauthorized access attempts.
- Analyze user activity associated with the Telnet process by reviewing login records and user sessions to identify any anomalies or unauthorized access.
- Correlate the Telnet activity with other network traffic logs to identify any concurrent suspicious activities or lateral movement attempts.
- Examine the system's security configuration and patch levels to assess if vulnerabilities could have been exploited to initiate the Telnet connection.
- Review firewall and network access control logs to determine if there were any changes or anomalies that could have facilitated the Telnet connection.
- Consult with system administrators or network engineers to verify if the Telnet connection was part of any scheduled maintenance or legitimate administrative task.

### False positive analysis

- Telnet connections initiated by network administrators for legitimate device management tasks can trigger false positives. Users can handle these by creating exceptions for known administrator IP addresses or specific devices frequently accessed for maintenance.
- Automated scripts or monitoring tools that use Telnet for routine checks on network devices may also be flagged. To manage this, users can whitelist the IP addresses or process names associated with these scripts.
- Internal testing environments that simulate network conditions using Telnet might be mistakenly identified as threats. Users should consider excluding IP ranges or hostnames associated with these testing environments.
- Legacy systems that rely on Telnet for communication within a secure network segment could generate false positives. Users can mitigate this by defining exceptions for these systems, ensuring they are monitored through other security measures.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or lateral movement.
- Conduct a thorough investigation to identify the source and scope of the Telnet connection, including reviewing logs and network traffic for any suspicious activity.
- Terminate any unauthorized Telnet sessions and disable Telnet services on the affected system to prevent future misuse.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement network segmentation to limit access to critical systems and reduce the risk of lateral movement.
- Enhance logging and monitoring by enabling detailed logging for Telnet and other remote access protocols, and integrate with a security information and event management (SIEM) system for real-time analysis.
- Apply security patches and updates to the affected system and any other vulnerable systems to mitigate known vulnerabilities.
- Conduct a security audit of the affected system to identify and remediate any additional security weaknesses.
- Restore the system to its operational state by verifying the integrity of system files and configurations, and ensure that all security measures are in place.
- Implement hardening measures such as disabling unused services, enforcing strong authentication mechanisms, and using encrypted protocols for remote access to prevent future incidents."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1021"
name = "Remote Services"
reference = "https://attack.mitre.org/techniques/T1021/"


[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"

