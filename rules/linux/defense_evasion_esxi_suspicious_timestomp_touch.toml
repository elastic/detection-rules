[metadata]
creation_date = "2023/04/11"
integration = ["endpoint", "auditd_manager"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies instances where the 'touch' command is executed on a Linux system with the "-r" flag, which is used to modify
the timestamp of a file based on another file's timestamp. The rule targets specific VM-related paths, such as
"/etc/vmware/", "/usr/lib/vmware/", or "/vmfs/*". These paths are associated with VMware virtualization software, and
their presence in the touch command arguments may indicate that a threat actor is attempting to tamper with timestamps
of VM-related files and configurations on the system.
"""
from = "now-9m"
index = ["logs-endpoint.events.*", "endgame-*", "auditbeat-*", "logs-auditd_manager.auditd-*"]
language = "eql"
license = "Elastic License v2"
name = "ESXI Timestomping using Touch Command"
references = [
    "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/",
]
risk_score = 47
rule_id = "30bfddd7-2954-4c9d-bbc6-19a99ca47e23"
setup = """## Setup

This rule requires data coming in from Elastic Defend.

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
"""
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Tactic: Defense Evasion",
    "Data Source: Elastic Endgame",
    "Data Source: Elastic Defend",
    "Data Source: Auditd Manager",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "linux" and event.type == "start" and event.action in ("exec", "exec_event", "executed", "process_started")
 and process.name == "touch" and process.args == "-r" and
process.args : ("/etc/vmware/*", "/usr/lib/vmware/*", "/vmfs/*")
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating ESXI Timestomping using Touch Command

VMware ESXi is a hypervisor used to manage virtual machines. Adversaries may exploit the 'touch' command with the "-r" flag to alter file timestamps, masking unauthorized changes in VM-related directories. The detection rule identifies such activities by monitoring for the 'touch' command targeting specific VMware paths, signaling potential timestamp tampering for evasion.

### Possible investigation steps

- Review the alert details to confirm the presence of the 'touch' command with the "-r" flag in the process arguments, specifically targeting paths like "/etc/vmware/*", "/usr/lib/vmware/*", or "/vmfs/*".
- Verify the user account associated with the process execution to determine if it aligns with expected administrative activity or if it might be indicative of unauthorized access.
- Check the process execution timeline to identify any preceding or subsequent suspicious activities that might correlate with the timestamp modification attempt.
- Investigate the parent process of the 'touch' command to understand the context of its execution and identify any potential script or application that might have triggered it.
- Utilize Osquery to list recent file modifications in the targeted directories to identify any unauthorized changes. Example query: `SELECT path, mtime FROM file WHERE path LIKE '/etc/vmware/%' OR path LIKE '/usr/lib/vmware/%' OR path LIKE '/vmfs/%' ORDER BY mtime DESC LIMIT 10;`
- Examine system logs for any login attempts or access patterns around the time of the alert to identify potential unauthorized access.
- Cross-reference the alert with any other security events or alerts from the same host to identify patterns or correlations that might indicate a broader attack.
- Review network logs for any unusual outbound connections from the host that might suggest data exfiltration or communication with a command and control server.
- Check for any recent changes in user privileges or group memberships that might have facilitated the execution of the 'touch' command with elevated permissions.
- Document all findings and maintain a timeline of events to assist in understanding the scope and impact of the potential security incident.

### False positive analysis

- Routine administrative tasks: System administrators may use the 'touch' command with the "-r" flag during legitimate maintenance activities, such as synchronizing timestamps across files for backup or archival purposes. To manage these, users can create exceptions for known administrative scripts or processes that regularly perform these actions.
- Automated scripts: Some automated scripts or system management tools might use the 'touch' command with the "-r" flag as part of their normal operations. Users should identify these scripts and exclude them from the detection rule by specifying their process names or paths.
- Software updates: During software updates or installations, legitimate processes might modify timestamps in VMware-related directories. Users can handle these by temporarily disabling the rule during scheduled updates or by creating exceptions for update processes.
- Backup operations: Backup software might use the 'touch' command to ensure file metadata consistency. Users should identify and exclude these backup processes from the rule to prevent false positives.

### Response and remediation

- Immediately isolate the affected host from the network to prevent further unauthorized access or changes.
- Conduct a thorough investigation to identify any unauthorized changes or access, focusing on the specific VMware paths mentioned in the alert.
- Review system logs and command history to determine the extent of the compromise and identify any additional malicious activities.
- Restore any altered files from known good backups to ensure the integrity of the VMware environment.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging policies to capture detailed command execution and file access events, particularly for critical directories like VMware paths.
- Integrate with a security information and event management (SIEM) system to correlate events and detect similar activities across the network.
- Apply security patches and updates to the ESXi host and associated systems to mitigate known vulnerabilities.
- Conduct a post-incident review to identify gaps in security controls and update incident response plans accordingly.
- Implement hardening measures such as restricting access to critical directories, enforcing least privilege, and using file integrity monitoring tools."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1070"
name = "Indicator Removal"
reference = "https://attack.mitre.org/techniques/T1070/"
[[rule.threat.technique.subtechnique]]
id = "T1070.006"
name = "Timestomp"
reference = "https://attack.mitre.org/techniques/T1070/006/"



[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

