[metadata]
creation_date = "2023/02/27"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
description = """
Identifies the execution of the unshadow utility which is part of John the Ripper, a password-cracking tool on the host
machine. Malicious actors can use the utility to retrieve the combined contents of the '/etc/shadow' and '/etc/password'
files. Using the combined file generated from the utility, the malicious threat actors can use them as input for
password-cracking utilities or prepare themselves for future operations by gathering credential information of the
victim.
"""
from = "now-9m"
index = ["logs-endpoint.events.*", "endgame-*"]
language = "eql"
license = "Elastic License v2"
name = "Potential Linux Credential Dumping via Unshadow"
references = ["https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/"]
risk_score = 47
rule_id = "e7cb3cfd-aaa3-4d7b-af18-23b89955062c"
setup = """## Setup

This rule requires data coming in from Elastic Defend.

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
"""
severity = "medium"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Data Source: Elastic Defend",
    "Data Source: Elastic Endgame",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "linux" and event.type == "start" and event.action in ("exec", "exec_event") and
process.name == "unshadow" and process.args_count >= 3
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Linux Credential Dumping via Unshadow

Unshadow is a utility within the John the Ripper suite, used to merge '/etc/shadow' and '/etc/passwd' files, creating a format suitable for password cracking. Adversaries exploit this to extract and crack user credentials, gaining unauthorized access. The detection rule identifies suspicious execution of 'unshadow' by monitoring process initiation events with specific arguments, flagging potential credential dumping activities.

### Possible investigation steps

- Review the alert details to confirm the process name is "unshadow" and verify the process arguments count is greater than or equal to 3, as these are key indicators of the rule trigger.
- Check the user account associated with the process execution to determine if it is a privileged account or if the account has a history of suspicious activity.
- Investigate the parent process of "unshadow" to understand how it was initiated and whether it was executed by a legitimate process or script.
- Examine the command line arguments used with "unshadow" to identify the specific files targeted, such as '/etc/shadow' and '/etc/passwd', and assess if they align with typical usage patterns.
- Utilize Osquery to gather additional context about the process execution. For example, run the following query to list recent processes executed by the same user: `SELECT pid, name, path, cmdline, start_time FROM processes WHERE uid = (SELECT uid FROM processes WHERE name = 'unshadow' LIMIT 1);`
- Analyze system logs for any other suspicious activities or anomalies around the time of the "unshadow" execution, such as unauthorized access attempts or changes to user accounts.
- Check for any recent file modifications or access to '/etc/shadow' and '/etc/passwd' using file integrity monitoring tools or logs to identify unauthorized access.
- Investigate network activity from the host to detect any potential exfiltration of the combined credential files or communication with known malicious IP addresses.
- Review historical data to determine if there have been previous instances of "unshadow" execution on the host, which could indicate a recurring threat or misconfiguration.
- Correlate the findings with threat intelligence sources to identify if the activity matches known attack patterns or threat actor behaviors associated with credential dumping.

### False positive analysis

- System administrators or security teams may use the unshadow utility legitimately during security audits or password recovery operations. These activities can trigger the detection rule, leading to false positives.
- Automated scripts or maintenance tasks that involve password management or system integrity checks might execute unshadow as part of their routine operations, causing benign alerts.
- To manage these false positives, users can create exceptions for known administrative accounts or specific scripts that are authorized to use unshadow. This can be done by whitelisting certain process execution contexts or by excluding specific user accounts from triggering the alert.
- Regularly review and update the list of exceptions to ensure that only legitimate and necessary uses of unshadow are excluded, maintaining a balance between security and operational efficiency.

### Response and remediation

- Immediately isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
- Conduct a thorough investigation to confirm the use of the unshadow utility and identify any unauthorized access or data extraction.
- Review system logs and process execution history to determine the scope of the compromise and identify any additional affected systems.
- Change all user passwords on the affected system and any other systems where the same credentials might have been used.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging and monitoring for critical files such as '/etc/shadow' and '/etc/passwd' to detect future unauthorized access attempts.
- Integrate threat intelligence feeds to identify known indicators of compromise (IOCs) related to credential dumping and similar tactics.
- Restore the system from a known good backup to ensure the integrity of the operating environment.
- Apply security patches and updates to the operating system and applications to mitigate known vulnerabilities.
- Conduct a security awareness training session for users to educate them on the importance of strong passwords and recognizing phishing attempts."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1003"
name = "OS Credential Dumping"
reference = "https://attack.mitre.org/techniques/T1003/"
[[rule.threat.technique.subtechnique]]
id = "T1003.008"
name = "/etc/passwd and /etc/shadow"
reference = "https://attack.mitre.org/techniques/T1003/008/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

