[metadata]
bypass_bbr_timing = true
creation_date = "2023/08/24"
integration = ["endpoint", "windows"]
maturity = "production"
updated_date = "2025/01/10"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
Identifies the suspicious creation of SettingContents-ms files, which have been used in attacks to achieve code
execution while evading defenses.
"""
from = "now-9m"
index = ["logs-endpoint.events.file-*", "logs-windows.sysmon_operational-*", "endgame-*", "winlogbeat-*"]
language = "eql"
license = "Elastic License v2"
name = "Creation of SettingContent-ms Files"
references = ["https://posts.specterops.io/the-tale-of-settingcontent-ms-files-f1ea253e4d39"]
risk_score = 21
rule_id = "1e6363a6-3af5-41d4-b7ea-d475389c0ceb"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Execution",
    "Data Source: Elastic Defend",
    "Rule Type: BBR",
    "Data Source: Sysmon",
    "Data Source: Elastic Endgame"
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
file where host.os.type == "windows" and event.type == "creation" and
  file.extension : "settingcontent-ms" and
  not file.path : (
    "?:\\*\\AppData\\Local\\Packages\\windows.immersivecontrolpanel_*\\LocalState\\Indexed\\Settings\\*",
    "\\Device\\HarddiskVolume*\\Windows\\WinSxS\\amd64_microsoft-windows-s..*\\*.settingcontent-ms"
  )
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Creation of SettingContent-ms Files

SettingContent-ms files are XML-based shortcuts used in Windows to link to specific settings pages. Adversaries exploit these files to execute malicious code by embedding harmful scripts, bypassing traditional security measures. The detection rule identifies unusual creation of these files outside typical directories, flagging potential threats by monitoring file creation events and filtering out known legitimate paths.

### Possible investigation steps

- Review the file creation event details to identify the specific path where the SettingContent-ms file was created, ensuring it is outside the known legitimate directories.
- Investigate the user account associated with the file creation event to determine if the activity aligns with their typical behavior or if it appears suspicious.
- Examine recent processes executed on the host around the time of the file creation to identify any potentially malicious activity or scripts that may have triggered the event.
- Check for any network connections or external communications from the host that could indicate data exfiltration or command and control activity.
- Look for other related alerts or events on the same host or user account to identify patterns or additional indicators of compromise.
- Assess the risk and impact of the event by considering the host's role within the organization and any sensitive data it may access.

### False positive analysis

- Legitimate software installations or updates may create SettingContent-ms files in non-standard directories. Monitor software installation logs to correlate these events and consider excluding these paths if they are consistently benign.
- Custom scripts or administrative tools used by IT departments might generate these files during configuration tasks. Verify the source of these scripts and, if deemed safe, add exceptions for these specific operations.
- User-initiated actions, such as creating shortcuts to settings for convenience, can trigger false positives. Educate users on the implications and review these actions to determine if they should be excluded.
- Automated system maintenance tasks or third-party management tools might create these files as part of their operations. Identify these tools and assess their behavior to decide on necessary exclusions.

### Response and remediation

- Isolate the affected system from the network to prevent further execution of potentially malicious code and lateral movement.
- Terminate any suspicious processes associated with the SettingContent-ms file creation to halt any ongoing malicious activity.
- Conduct a thorough scan of the affected system using updated antivirus or endpoint detection and response (EDR) tools to identify and remove any malicious files or scripts.
- Review and restore any altered system settings or configurations to their default or secure state to ensure system integrity.
- Collect and preserve relevant logs and artifacts for further analysis and to support potential forensic investigations.
- Escalate the incident to the security operations center (SOC) or incident response team for a deeper investigation and to determine the scope and impact of the threat.
- Implement additional monitoring and alerting for unusual SettingContent-ms file creation activities to enhance detection and prevent recurrence of similar threats."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1204"
name = "User Execution"
reference = "https://attack.mitre.org/techniques/T1204/"
[[rule.threat.technique.subtechnique]]
id = "T1204.002"
name = "Malicious File"
reference = "https://attack.mitre.org/techniques/T1204/002/"



[rule.threat.tactic]
id = "TA0002"
name = "Execution"
reference = "https://attack.mitre.org/tactics/TA0002/"
[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1566"
name = "Phishing"
reference = "https://attack.mitre.org/techniques/T1566/"
[[rule.threat.technique.subtechnique]]
id = "T1566.001"
name = "Spearphishing Attachment"
reference = "https://attack.mitre.org/techniques/T1566/001/"



[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

