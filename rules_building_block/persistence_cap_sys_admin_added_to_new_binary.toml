[metadata]
bypass_bbr_timing = true
creation_date = "2024/01/10"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/10"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
Identifies instances where a binary is granted the CAP_SYS_ADMIN capability. In Linux, the CAP_SYS_ADMIN capability is a
powerful and broad capability that allows a process to perform a range of system administration operations, such as
mounting and unmounting filesystems, configuring network interfaces, and accessing hardware devices. Attackers may
leverage a misconfiguration for exploitation in order to escalate their privileges to root. The rule identifies
previously unknown processes executing with CAP_SYS_ADMIN capabilities through the use of the new terms rule type.
"""
from = "now-9m"
index = ["logs-endpoint.events.*"]
language = "kuery"
license = "Elastic License v2"
name = "CAP_SYS_ADMIN Assigned to Binary"
risk_score = 21
rule_id = "a577e524-c2ee-47bd-9c5b-e917d01d3276"
setup = """## Setup


This rule requires data coming in from Elastic Defend.

### Elastic Defend Integration Setup
Elastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.

#### Prerequisite Requirements:
- Fleet is required for Elastic Defend.
- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).

#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:
- Go to the Kibana home page and click "Add integrations".
- In the query bar, search for "Elastic Defend" and select the integration to see more details about it.
- Click "Add Elastic Defend".
- Configure the integration name and optionally add a description.
- Select the type of environment you want to protect, either "Traditional Endpoints" or "Cloud Workloads".
- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).
- We suggest selecting "Complete EDR (Endpoint Detection and Response)" as a configuration setting, that provides "All events; all preventions"
- Enter a name for the agent policy in "New agent policy name". If other agent policies already exist, you can click the "Existing hosts" tab and select an existing policy instead.
For more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).
- Click "Save and Continue".
- To complete the integration, select "Add Elastic Agent to your hosts" and continue to the next section to install the Elastic Agent on your hosts.
For more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).
"""
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Tactic: Persistence",
    "Data Source: Elastic Defend",
    "Rule Type: BBR",
]
timestamp_override = "event.ingested"
type = "new_terms"

query = '''
event.category:"process" and host.os.type:"linux" and event.type:"start" and event.action:"exec" and process.name:* and
(process.thread.capabilities.effective:"CAP_SYS_ADMIN" or process.thread.capabilities.permitted:"CAP_SYS_ADMIN") and
not user.id:"0"
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating CAP_SYS_ADMIN Assigned to Binary

In Linux, the CAP_SYS_ADMIN capability grants extensive system administration privileges, enabling processes to perform critical operations like mounting filesystems and configuring networks. Adversaries may exploit binaries with this capability to escalate privileges. The detection rule identifies non-root processes with CAP_SYS_ADMIN, flagging potential misuse by monitoring process execution events.

### Possible investigation steps

- Review the process name and path to determine if it is a known or expected binary that should have CAP_SYS_ADMIN capabilities.
- Check the user ID associated with the process to understand which non-root user is executing the binary and assess if this is expected behavior.
- Investigate the parent process to understand how the binary was executed and if it was initiated by a legitimate process or user.
- Examine recent system changes or configurations that might have inadvertently granted CAP_SYS_ADMIN capabilities to the binary.
- Look for any related alerts or logs that might indicate suspicious activity or attempts to exploit the CAP_SYS_ADMIN capability.
- Assess the system for any signs of compromise or unauthorized access, focusing on persistence mechanisms and privilege escalation attempts.

### False positive analysis

- System maintenance scripts may trigger alerts if they are scheduled to run with elevated capabilities. Review and whitelist these scripts if they are verified as safe and necessary for system operations.
- Backup software often requires CAP_SYS_ADMIN to access and manage filesystems. Confirm the legitimacy of the backup process and exclude it from the rule if it is a trusted application.
- Monitoring tools that need to gather extensive system metrics might use CAP_SYS_ADMIN. Validate these tools and create exceptions for them to prevent unnecessary alerts.
- Virtualization software may use CAP_SYS_ADMIN to manage virtual machines. Ensure that the software is from a trusted source and exclude it if it is a regular part of your infrastructure.
- Custom applications developed in-house might require CAP_SYS_ADMIN for specific functionalities. Conduct a security review of these applications and exclude them if they are deemed safe and essential.

### Response and remediation

- Immediately isolate the affected system from the network to prevent potential lateral movement by the adversary.
- Terminate any non-root processes identified with CAP_SYS_ADMIN capabilities to halt any unauthorized actions.
- Conduct a thorough review of the system's capabilities and permissions to identify and remove any unnecessary CAP_SYS_ADMIN assignments from binaries.
- Analyze the process execution logs to determine the origin and intent of the unauthorized process, focusing on identifying any potential entry points or vulnerabilities exploited.
- Restore the system from a known good backup if any unauthorized changes or configurations are detected.
- Implement stricter access controls and monitoring on systems with CAP_SYS_ADMIN capabilities to prevent future unauthorized access.
- Escalate the incident to the security operations team for further investigation and to assess the need for broader organizational response measures."""


[[rule.threat]]
framework = "MITRE ATT&CK"

[rule.threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"

[rule.new_terms]
field = "new_terms_fields"
value = ["host.id", "user.id", "process.executable"]
[[rule.new_terms.history_window_start]]
field = "history_window_start"
value = "now-14d"


