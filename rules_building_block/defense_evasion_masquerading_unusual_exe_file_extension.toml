[metadata]
creation_date = "2023/09/25"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
Identifies the creation or modification of an executable file with an unexpected file extension. Attackers may attempt
to evade detection by masquerading files using the file extension values used by image, audio, or document file types.
"""
from = "now-119m"
index = ["logs-endpoint.events.file-*"]
interval = "60m"
language = "eql"
license = "Elastic License v2"
name = "Executable File with Unusual Extension"
risk_score = 21
rule_id = "ecd4857b-5bac-455e-a7c9-a88b66e56a9e"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Defense Evasion",
    "Rule Type: BBR",
    "Data Source: Elastic Defend",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
file where host.os.type == "windows" and event.action != "deletion" and

 /* MZ header or its common base64 equivalent TVqQ */
 file.Ext.header_bytes : ("4d5a*", "54567151*") and

 (
   /* common image file extensions */
   file.extension : ("jpg", "jpeg", "emf", "tiff", "gif", "png", "bmp", "fpx", "eps", "svg", "inf") or

   /* common audio and video file extensions */
   file.extension : ("mp3", "wav", "avi", "mpeg", "flv", "wma", "wmv", "mov", "mp4", "3gp") or

   /* common document file extensions */
   file.extension : ("txt", "pdf", "doc", "docx", "rtf", "ppt", "pptx", "xls", "xlsx", "hwp", "html")
  ) and
  not process.pid == 4 and
  not process.executable : "?:\\Program Files (x86)\\Trend Micro\\Client Server Security Agent\\Ntrtscan.exe"
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Executable File with Unusual Extension

Executable files are typically identified by specific extensions, but attackers may disguise them using extensions associated with benign file types like images or documents to evade detection. This detection rule identifies such anomalies by checking for executable headers in files with unexpected extensions, excluding known safe processes, thus highlighting potential masquerading attempts for further investigation.

### Possible investigation steps

- Review the alert details to confirm the file's extension and header bytes, ensuring they match the criteria specified in the detection rule (e.g., MZ header with unexpected extensions like jpg, mp3, etc.).
- Check the file creation or modification timestamp to determine when the suspicious activity occurred and correlate it with other events on the system.
- Identify the user account associated with the file creation or modification event to assess if the activity aligns with their typical behavior or role.
- Investigate the parent process that created or modified the file by examining the process ID and executable path, ensuring it is not a known safe process like Ntrtscan.exe.
- Use Osquery to gather additional context about the file and its associated process. For example, run the following query to list processes with the suspicious file as an argument: `SELECT * FROM processes WHERE path LIKE '%<suspicious_file_name>%'`.
- Examine the file's metadata and properties, such as its size, hash, and digital signature, to determine if it matches known malicious files or legitimate software.
- Search for any network connections or communications initiated by the process that created or modified the file to identify potential command and control activity.
- Review system logs and security events around the time of the alert to identify any other suspicious activities or anomalies that may be related.
- Check for any recent changes in system configurations or installed software that could explain the presence of the executable file with an unusual extension.
- Consult threat intelligence sources to determine if the file or its characteristics are associated with known malware campaigns or threat actors.

### False positive analysis

- Files with executable headers but benign extensions may be generated by legitimate software installations or updates, which often use temporary files with non-standard extensions during the process.
- Some software development tools may create or modify files with executable headers and unexpected extensions as part of their normal operation, especially during compilation or packaging processes.
- Security or system management tools might scan or modify files, resulting in temporary files with executable headers and non-standard extensions, which are not malicious.
- Users can manage these false positives by creating exceptions for known safe processes or directories where such legitimate activities occur frequently.
- Regularly review and update the list of excluded processes or directories to ensure that only non-threatening behaviors are excluded, maintaining a balance between security and operational efficiency.

### Response and remediation

- Isolate the affected system from the network to prevent further spread of potential malware or unauthorized access.
- Conduct a thorough investigation to identify the source and scope of the incident, focusing on the file's origin, associated processes, and any network connections.
- Use endpoint detection and response (EDR) tools to analyze the behavior of the suspicious file and any related processes.
- Remove or quarantine the suspicious file and any associated malicious software identified during the investigation.
- Review and update antivirus and anti-malware signatures to ensure they can detect similar threats in the future.
- Escalate the incident to the security operations center (SOC) or incident response team if the threat is part of a larger attack campaign or if additional expertise is required.
- Implement enhanced logging policies to capture detailed file creation and modification events, focusing on unusual file extensions and executable headers.
- Integrate threat intelligence feeds to improve detection capabilities and provide context on known masquerading techniques and associated threat actors.
- Restore the system to its operational state by applying clean backups and verifying the integrity of critical system files and applications.
- Harden the system by applying security patches, disabling unnecessary services, and enforcing strict access controls to reduce the attack surface."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1036"
name = "Masquerading"
reference = "https://attack.mitre.org/techniques/T1036/"
[[rule.threat.technique.subtechnique]]
id = "T1036.008"
name = "Masquerade File Type"
reference = "https://attack.mitre.org/techniques/T1036/008/"



[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

