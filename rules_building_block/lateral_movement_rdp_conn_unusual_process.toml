[metadata]
creation_date = "2023/08/29"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/10"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
Adversaries may attempt to connect to a remote system over Windows Remote Desktop Protocol (RDP) to achieve lateral
movement. Adversaries may avoid using the Microsoft Terminal Services Client (mstsc.exe) binary to establish an RDP
connection to evade detection.
"""
from = "now-119m"
index = ["logs-endpoint.events.network-*"]
interval = "60m"
language = "eql"
license = "Elastic License v2"
name = "Potential Outgoing RDP Connection by Unusual Process"
risk_score = 21
rule_id = "8e39f54e-910b-4adb-a87e-494fbba5fb65"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Lateral Movement",
    "Data Source: Elastic Defend",
    "Rule Type: BBR"
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
network where host.os.type == "windows" and
  event.action == "connection_attempted" and destination.port == 3389 and
  destination.ip != "::1" and destination.ip != "127.0.0.1" and
  not (
    process.executable : (
      "?:\\Windows\\System32\\mstsc.exe",
      "?:\\Program Files (x86)\\mRemoteNG\\mRemoteNG.exe",
      "?:\\Program Files (x86)\\PRTG Network Monitor\\PRTG Probe.exe",
      "?:\\Program Files\\Azure Advanced Threat Protection Sensor\\*\\Microsoft.Tri.Sensor.exe",
      "?:\\Program Files (x86)\\Microsoft\\Remote Desktop Connection Manager\\RDCMan.exe",
      "?:\\Program Files\\SentinelOne\\Sentinel Agent*\\Ranger\\SentinelRanger.exe",
      "?:\\Program Files\\Devolutions\\Remote Desktop Manager\\RemoteDesktopManager.exe",
      "?:\\Program Files (x86)\\Devolutions\\Remote Desktop Manager\\RemoteDesktopManager.exe"
    ) and process.code_signature.trusted == true
  )
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Outgoing RDP Connection by Unusual Process

Remote Desktop Protocol (RDP) enables users to connect to other systems over a network, facilitating remote management and troubleshooting. However, adversaries can exploit RDP for lateral movement within a network, bypassing traditional security measures by using non-standard processes. The detection rule identifies unusual processes attempting RDP connections, excluding known legitimate applications, to flag potential malicious activity.

### Possible investigation steps

- Review the process executable path to determine if it is a known legitimate application or a potentially malicious one, focusing on paths not listed in the exclusion criteria.
- Check the process code signature to verify if it is trusted or if there are any anomalies that might indicate tampering or a lack of a valid signature.
- Investigate the source IP address and user account associated with the connection attempt to identify if they are known and authorized within the network.
- Analyze historical network activity from the source host to identify any patterns or previous unusual behavior that might correlate with the current alert.
- Examine any recent changes or installations on the source host that could explain the presence of an unusual process attempting an RDP connection.

### False positive analysis

- Legitimate third-party remote management tools may trigger false positives if they are not included in the exclusion list. Users should identify and add these tools to the exclusion list if they are verified as trusted and necessary for business operations.
- Custom scripts or automation tools that initiate RDP connections for administrative purposes might be flagged. Ensure these scripts are signed and add them to the exclusion list if they are part of routine operations.
- Internal security tools that perform network scans or health checks using RDP could be mistakenly identified as unusual processes. Verify these tools' signatures and include them in the exclusion list to prevent unnecessary alerts.
- Development or testing environments where non-standard processes are used for RDP connections may generate alerts. Regularly review and update the exclusion list to accommodate these environments while ensuring they do not pose a security risk.

### Response and remediation

- Immediately isolate the affected host from the network to prevent further lateral movement by the adversary.
- Terminate any suspicious processes identified as attempting the RDP connection that are not part of the known legitimate applications.
- Conduct a thorough review of the affected host for any signs of compromise, including unauthorized user accounts, changes to system configurations, or presence of malware.
- Reset credentials for any accounts that were accessed or potentially compromised during the incident to prevent unauthorized access.
- Apply patches and updates to the affected system and any other vulnerable systems to mitigate known vulnerabilities that could be exploited for similar attacks.
- Enhance monitoring and logging for RDP connections across the network to detect and respond to unusual activity promptly.
- Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine if additional systems are affected."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1021"
name = "Remote Services"
reference = "https://attack.mitre.org/techniques/T1021/"
[[rule.threat.technique.subtechnique]]
id = "T1021.001"
name = "Remote Desktop Protocol"
reference = "https://attack.mitre.org/techniques/T1021/001/"



[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"

