[metadata]
creation_date = "2023/08/29"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/08"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
Adversaries may attempt to connect to a remote system over Windows Remote Desktop Protocol (RDP) to achieve lateral
movement. Adversaries may avoid using the Microsoft Terminal Services Client (mstsc.exe) binary to establish an RDP
connection to evade detection.
"""
from = "now-119m"
index = ["logs-endpoint.events.network-*"]
interval = "60m"
language = "eql"
license = "Elastic License v2"
name = "Potential Outgoing RDP Connection by Unusual Process"
risk_score = 21
rule_id = "8e39f54e-910b-4adb-a87e-494fbba5fb65"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Lateral Movement",
    "Data Source: Elastic Defend",
    "Rule Type: BBR"
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
network where host.os.type == "windows" and
  event.action == "connection_attempted" and destination.port == 3389 and
  destination.ip != "::1" and destination.ip != "127.0.0.1" and
  not (
    process.executable : (
      "?:\\Windows\\System32\\mstsc.exe",
      "?:\\Program Files (x86)\\mRemoteNG\\mRemoteNG.exe",
      "?:\\Program Files (x86)\\PRTG Network Monitor\\PRTG Probe.exe",
      "?:\\Program Files\\Azure Advanced Threat Protection Sensor\\*\\Microsoft.Tri.Sensor.exe",
      "?:\\Program Files (x86)\\Microsoft\\Remote Desktop Connection Manager\\RDCMan.exe",
      "?:\\Program Files\\SentinelOne\\Sentinel Agent*\\Ranger\\SentinelRanger.exe",
      "?:\\Program Files\\Devolutions\\Remote Desktop Manager\\RemoteDesktopManager.exe",
      "?:\\Program Files (x86)\\Devolutions\\Remote Desktop Manager\\RemoteDesktopManager.exe"
    ) and process.code_signature.trusted == true
  )
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Potential Outgoing RDP Connection by Unusual Process

Remote Desktop Protocol (RDP) enables users to connect to other systems over a network, facilitating remote management and troubleshooting. However, adversaries can exploit RDP for lateral movement within a network, often bypassing detection by using non-standard processes. The detection rule identifies unusual processes attempting RDP connections, excluding known legitimate applications, to flag potential malicious activity.

### Possible investigation steps

- Review the alert details to identify the unusual process attempting the RDP connection, focusing on the `process.executable` field to determine the exact path and name of the executable.
- Verify the `process.code_signature.trusted` field to check if the process is signed and trusted, which might indicate a false positive if the signature is valid.
- Examine the `destination.ip` field to identify the target of the RDP connection and determine if it is an internal or external IP address, which can provide context on the potential risk.
- Investigate the `host.os.type` field to confirm the operating system is Windows, as the rule is specifically designed for Windows environments.
- Use Osquery to gather additional context about the process by running a query such as: `SELECT * FROM processes WHERE path = '<path_to_unusual_process>';` to retrieve details like process ID, parent process, and command line arguments.
- Check the process's parent process to understand the process hierarchy and determine if the parent process is legitimate or potentially malicious.
- Analyze network logs to identify any other unusual network activity originating from the same host, focusing on other connection attempts or data transfers.
- Review recent system logs and security events on the host to identify any other suspicious activities or anomalies that coincide with the RDP connection attempt.
- Investigate the user account associated with the process to determine if it is a legitimate user or if there are signs of account compromise.
- Correlate the findings with threat intelligence sources to check if the unusual process or IP address is associated with known malicious activity or campaigns.

### False positive analysis

- Known false positives may include legitimate applications or scripts that are not part of the predefined exclusion list but are used for remote management or monitoring purposes. These could be custom IT management tools or scripts developed in-house.
- Users can handle these false positives by identifying and documenting any legitimate processes that frequently trigger the rule. Once identified, these processes can be added to the exclusion list, ensuring they are signed and trusted.
- Another potential false positive source is automated tasks or scheduled jobs that use RDP for legitimate purposes. Users should review scheduled tasks and automation scripts to determine if they are causing alerts and consider excluding them if they are verified as non-threatening.
- It's important to regularly review and update the exclusion list to accommodate changes in the organization's software landscape, ensuring that new legitimate tools are not mistakenly flagged.
- Users should also consider the context of the network environment, such as known IP addresses or subnets that are part of regular operations, and adjust the rule to exclude these from triggering alerts.

### Response and remediation

- Isolate the affected system from the network to prevent further lateral movement by the adversary.
- Verify the legitimacy of the process attempting the RDP connection by checking its executable path and code signature.
- Conduct a thorough investigation of the system to identify any additional signs of compromise, such as unauthorized user accounts or scheduled tasks.
- Review recent RDP connection logs to identify any other unusual or unauthorized access attempts.
- If malicious activity is confirmed, remove any identified malware or unauthorized software from the system.
- Reset credentials for any accounts that may have been compromised during the incident.
- Escalate the incident to the security operations center (SOC) or incident response team for further analysis and response.
- Implement enhanced logging policies to capture detailed process execution and network connection events for future investigations.
- Integrate threat intelligence feeds and endpoint detection and response (EDR) solutions to improve detection capabilities.
- Apply system hardening measures, such as disabling RDP if not needed, enforcing strong password policies, and ensuring all systems are up to date with security patches."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1021"
name = "Remote Services"
reference = "https://attack.mitre.org/techniques/T1021/"
[[rule.threat.technique.subtechnique]]
id = "T1021.001"
name = "Remote Desktop Protocol"
reference = "https://attack.mitre.org/techniques/T1021/001/"



[rule.threat.tactic]
id = "TA0008"
name = "Lateral Movement"
reference = "https://attack.mitre.org/tactics/TA0008/"

