[metadata]
creation_date = "2023/08/21"
integration = ["endpoint", "windows", "system"]
maturity = "production"
updated_date = "2025/01/10"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
building_block_type = "default"
description = "Attackers may try to access private keys, e.g. ssh, in order to gain further authenticated access to the environment.\n"
from = "now-119m"
index = ["logs-endpoint.events.process-*", "logs-windows.sysmon_operational-*", "endgame-*", "logs-system.security*", "winlogbeat-*"]
interval = "60m"
language = "eql"
license = "Elastic License v2"
name = "Attempted Private Key Access"
risk_score = 21
rule_id = "c55badd3-3e61-4292-836f-56209dc8a601"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Data Source: Elastic Defend",
    "Rule Type: BBR",
    "Data Source: Sysmon",
    "Data Source: Elastic Endgame",
    "Data Source: System",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "windows" and event.type == "start" and
  process.command_line : ("*.pem *", "*.pem", "*.id_rsa*") and
  not process.args : (
        "--rootcert",
        "--cert",
        "--crlfile"
  ) and
  not process.command_line : (
        "*--cacert*",
        "*--ssl-cert*",
        "*--tls-cert*",
        "*--tls_server_certs*"
  ) and
  not process.executable : (
    "?:\\ProgramData\\Logishrd\\LogiOptions\\Software\\*\\LogiLuUpdater.exe",
    "?:\\Program Files\\Elastic\\Agent\\data\\*\\osqueryd.exe",
    "?:\\Program Files\\Git\\cmd\\git.exe",
    "?:\\Program Files\\Git\\mingw64\\bin\\git.exe",
    "?:\\Program Files\\Guardicore\\gc-controller.exe",
    "?:\\Program Files\\Guardicore\\gc-deception-agent.exe",
    "?:\\Program Files\\Guardicore\\gc-detection-agent.exe",
    "?:\\Program Files\\Guardicore\\gc-enforcement-agent.exe",
    "?:\\Program Files\\Guardicore\\gc-guest-agent.exe",
    "?:\\Program Files\\Logi\\LogiBolt\\LogiBoltUpdater.exe",
    "?:\\Program Files (x86)\\Schneider Electric EcoStruxure\\Building Operation 5.0\\Device Administrator\\Python\\python.exe",
    "?:\\Program Files\\Splunk\\bin\\openssl.exe",
    "?:\\Program Files\\SplunkUniversalForwarder\\bin\\openssl.exe",
    "?:\\Users\\*\\AppData\\Local\\Logi\\LogiBolt\\LogiBoltUpdater.exe",
    "?:\\Windows\\system32\\icacls.exe",
    "?:\\Windows\\System32\\OpenSSH\\*"
  )
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Attempted Private Key Access

Private keys, such as SSH keys, are critical for secure authentication in environments. Adversaries may attempt to access these keys to gain unauthorized access. The detection rule identifies suspicious processes on Windows systems that attempt to access files typically associated with private keys, while excluding legitimate processes. This helps in identifying potential credential access attempts by filtering out known benign activities.

### Possible investigation steps

- Review the process details to identify the executable that attempted to access private key files, focusing on the process.args field to understand the specific files targeted.
- Check the process execution context, including the user account under which the process was running, to determine if it aligns with expected behavior or if it indicates potential compromise.
- Investigate the parent process of the suspicious activity to trace back the origin of the execution and assess if it was initiated by a legitimate application or script.
- Examine recent login and authentication logs for the user account associated with the process to identify any unusual access patterns or failed login attempts.
- Correlate the event with other security alerts or logs from the same host or user to identify any additional indicators of compromise or related suspicious activities.
- Verify if the host has any known vulnerabilities or misconfigurations that could have been exploited to execute the process, and assess the need for remediation.

### False positive analysis

- Processes related to legitimate software updates, such as LogiLuUpdater.exe and LogiBoltUpdater.exe, may trigger false positives. Users can handle these by adding these executables to the exclusion list if they are verified as part of regular update activities.
- Security tools like osqueryd.exe and various Guardicore agents may access files that match the pattern used in the detection rule. These should be excluded if they are confirmed to be part of authorized security operations.
- The use of openssl.exe in Splunk installations for legitimate purposes can be mistaken for suspicious activity. Users should verify the context of its use and exclude it if it aligns with expected behavior.
- Python scripts executed by Schneider Electric EcoStruxure software may access key files as part of their normal operation. If these scripts are verified as non-threatening, they should be added to the exclusion list.
- The icacls.exe utility in Windows system32 directory may be used in administrative scripts that access key files. Confirm the legitimacy of these scripts and exclude them if they are part of routine administrative tasks.

### Response and remediation

- Isolate the affected system from the network to prevent further unauthorized access or lateral movement by the adversary.
- Terminate any suspicious processes identified by the detection rule that are attempting to access private key files.
- Conduct a thorough review of the system's access logs to identify any unauthorized access or data exfiltration attempts that may have occurred.
- Change all potentially compromised private keys and associated credentials immediately to prevent unauthorized access using these keys.
- Implement additional monitoring on the affected system and similar systems to detect any further attempts to access private keys or other sensitive files.
- Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine if the threat is part of a larger attack campaign.
- Review and update access controls and permissions to ensure that only authorized processes and users have access to private key files, reducing the risk of future unauthorized access attempts."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1552"
name = "Unsecured Credentials"
reference = "https://attack.mitre.org/techniques/T1552/"
[[rule.threat.technique.subtechnique]]
id = "T1552.004"
name = "Private Keys"
reference = "https://attack.mitre.org/techniques/T1552/004/"



[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

