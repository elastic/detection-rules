[metadata]
bypass_bbr_timing = true
creation_date = "2023/10/10"
maturity = "production"
updated_date = "2025/01/10"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
This rule leverages alert data from various Discovery building block rules to alert on signals with unusual unique
host.id and user.id entries.
"""
from = "now-9m"
index = [".alerts-security.*"]
language = "kuery"
license = "Elastic License v2"
name = "Unusual Discovery Activity by User"
risk_score = 21
rule_id = "cf575427-0839-4c69-a9e6-99fde02606f3"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Discovery",
    "Rule Type: Higher-Order Rule",
    "Rule Type: BBR"
]
timestamp_override = "event.ingested"
type = "new_terms"

query = '''
host.os.type:windows and event.kind:signal and kibana.alert.rule.rule_id:(
  "d68e95ad-1c82-4074-a12a-125fe10ac8ba" or "7b8bfc26-81d2-435e-965c-d722ee397ef1" or
  "0635c542-1b96-4335-9b47-126582d2c19a" or "6ea55c81-e2ba-42f2-a134-bccf857ba922" or
  "e0881d20-54ac-457f-8733-fe0bc5d44c55" or "06568a02-af29-4f20-929c-f3af281e41aa" or
  "c4e9ed3e-55a2-4309-a012-bc3c78dad10a" or "51176ed2-2d90-49f2-9f3d-17196428b169" or
  "1d72d014-e2ab-4707-b056-9b96abe7b511"
)
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Unusual Discovery Activity by User

In Windows environments, discovery activities involve querying system information, which adversaries exploit to gather intelligence for further attacks. This detection rule identifies anomalies by monitoring unique host and user identifiers linked to discovery actions. By leveraging alert data from foundational rules, it flags unusual patterns, aiding in early threat detection and response.

### Possible investigation steps

- Review the alert details to identify the specific host.id and user.id associated with the unusual discovery activity to understand the scope of the potential threat.
- Check the event logs on the identified Windows host for any related discovery activities or other suspicious events around the time of the alert to gather more context.
- Investigate the user account activity associated with the user.id to determine if there are any unauthorized or unexpected actions, such as logins from unusual locations or times.
- Correlate the alert with other security events or alerts involving the same host.id or user.id to identify any patterns or additional indicators of compromise.
- Assess the host's current state for any signs of compromise, such as unexpected processes, network connections, or changes in system configurations, to determine if further containment or remediation actions are necessary.

### False positive analysis

- Routine administrative tasks by IT staff may trigger alerts due to frequent system queries. To manage this, create exceptions for known IT user accounts and host identifiers that regularly perform these tasks.
- Automated scripts or monitoring tools that query system information for legitimate purposes can be mistaken for unusual activity. Identify these scripts and tools, and exclude their associated user and host identifiers from the rule.
- Software updates or installations that involve system checks might generate false positives. Review the timing and context of alerts to correlate them with scheduled updates, and exclude relevant identifiers if necessary.
- Security audits or compliance checks often involve extensive system discovery activities. Document these events and exclude the involved user and host identifiers to prevent unnecessary alerts.
- Training or testing environments where discovery activities are simulated can lead to false positives. Ensure these environments are recognized and excluded from the rule to avoid confusion.

### Response and remediation

- Isolate the affected host immediately to prevent further lateral movement or data exfiltration. Disconnect it from the network while maintaining power to preserve volatile data for forensic analysis.
- Conduct a thorough review of the user's recent activities and access logs to identify any unauthorized access or data manipulation. Focus on the specific user.id and host.id flagged in the alert.
- Reset the credentials of the affected user account and any other accounts that may have been compromised. Ensure that new credentials adhere to strong password policies.
- Scan the isolated host for malware or unauthorized software using updated antivirus and endpoint detection tools. Remove any malicious files or applications found.
- Restore the affected system from a known good backup if any unauthorized changes or malware are detected that cannot be remediated.
- Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine if additional systems or users are affected.
- Implement enhanced monitoring on the affected host and user account to detect any recurrence of unusual discovery activities, adjusting alert thresholds if necessary to improve detection accuracy."""


[[rule.threat]]
framework = "MITRE ATT&CK"

[rule.threat.tactic]
id = "TA0007"
name = "Discovery"
reference = "https://attack.mitre.org/tactics/TA0007/"

[rule.new_terms]
field = "new_terms_fields"
value = ["host.id", "user.id"]
[[rule.new_terms.history_window_start]]
field = "history_window_start"
value = "now-14d"


