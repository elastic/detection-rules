[metadata]
bypass_bbr_timing = true
creation_date = "2023/07/13"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/10"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
This rule identifies the execution of commands that enumerates account or group information. Adversaries may use
built-in applications to get a listing of local system or domain accounts and groups.
"""
from = "now-9m"
index = ["logs-endpoint.events.process-*"]
language = "eql"
license = "Elastic License v2"
name = "Windows Account or Group Discovery"
risk_score = 21
rule_id = "089db1af-740d-4d84-9a5b-babd6de143b0"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Discovery",
    "Rule Type: BBR",
    "Data Source: Elastic Defend",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "windows" and event.type == "start" and
(
  (
   (
    (process.name : "net.exe" or process.pe.original_file_name == "net.exe") or
    (
     (process.name : "net1.exe" or process.pe.original_file_name == "net1.exe") and
     not process.parent.name : "net.exe"
    )
   ) and process.args : ("accounts", "group", "user", "localgroup") and not process.args : "/add"
  ) or
  (process.name:("dsquery.exe", "dsget.exe") and process.args:("*members*", "user")) or
  (process.name:"dsquery.exe" and process.args:"*filter*") or
  process.name:("quser.exe", "qwinsta.exe", "PsGetSID.exe", "PsLoggedOn.exe", "LogonSessions.exe", "whoami.exe") or
  (
    process.name: "cmd.exe" and
    (
      process.args : "echo" and process.args : (
        "%username%", "%userdomain%", "%userdnsdomain%",
        "%userdomain_roamingprofile%", "%userprofile%",
        "%homepath%", "%localappdata%", "%appdata%"
      ) or
      process.args : "set"
    )
  )
) and not process.parent.args: "C:\\Program Files (x86)\\Microsoft Intune Management Extension\\Content\\DetectionScripts\\*.ps1"
and not process.parent.name : "LTSVC.exe" and not user.id : "S-1-5-18"
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Windows Account or Group Discovery

Windows environments provide built-in tools for managing and querying user accounts and groups, essential for system administration. However, adversaries exploit these tools to gather information about user accounts and group memberships, aiding in privilege escalation and lateral movement. The detection rule identifies suspicious use of these tools by monitoring specific command executions and arguments, filtering out benign activities to highlight potential threats.

### Possible investigation steps

- Review the process name and arguments to determine if the command execution aligns with typical administrative tasks or if it appears suspicious. Pay particular attention to commands like net.exe, dsquery.exe, and whoami.exe.
- Check the parent process name and arguments to identify if the command was executed by a legitimate application or script, such as those related to Microsoft Intune Management Extension or LTSVC.exe, which are excluded in the rule.
- Investigate the user ID associated with the process to determine if it belongs to a legitimate system or service account, especially since the rule excludes the system account S-1-5-18.
- Analyze the context of the host where the process was executed, including recent login activities, to identify any unusual patterns or unauthorized access attempts.
- Correlate the alert with other security events or logs from the same host or user to identify potential lateral movement or privilege escalation activities.

### False positive analysis

- Routine administrative tasks using net.exe or net1.exe for legitimate account management may trigger alerts. Exclude these by identifying and whitelisting specific administrative scripts or processes that frequently use these commands.
- Automated scripts or software updates that query user or group information using dsquery.exe or dsget.exe can be mistaken for threats. Monitor and exclude these processes if they are part of regular maintenance or update routines.
- Commands executed by cmd.exe to display environment variables like %username% or %userdomain% during login scripts or system checks can be benign. Identify and exclude these scripts if they are part of standard operating procedures.
- Processes initiated by known management tools such as Microsoft Intune or LTSVC.exe may appear suspicious. Exclude these parent processes to reduce false positives from trusted management software.
- System accounts, particularly those with user ID S-1-5-18, may execute commands that match the rule criteria. Exclude these system accounts to prevent unnecessary alerts from standard system operations.

### Response and remediation

- Isolate the affected system from the network to prevent further unauthorized access or lateral movement by the adversary.
- Terminate any suspicious processes identified by the detection rule, such as those involving net.exe, dsquery.exe, or other flagged applications.
- Conduct a thorough review of user accounts and group memberships on the affected system to identify any unauthorized changes or additions.
- Reset passwords for potentially compromised accounts, especially those with elevated privileges, to mitigate the risk of further exploitation.
- Review and update access controls and permissions to ensure that only authorized users have access to sensitive resources and administrative tools.
- Escalate the incident to the security operations center (SOC) or incident response team for further investigation and to determine if additional systems are affected.
- Implement enhanced monitoring and logging for the affected system and similar environments to detect any recurrence of the threat or related suspicious activities."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1069"
name = "Permission Groups Discovery"
reference = "https://attack.mitre.org/techniques/T1069/"
[[rule.threat.technique.subtechnique]]
id = "T1069.001"
name = "Local Groups"
reference = "https://attack.mitre.org/techniques/T1069/001/"

[[rule.threat.technique.subtechnique]]
id = "T1069.002"
name = "Domain Groups"
reference = "https://attack.mitre.org/techniques/T1069/002/"


[[rule.threat.technique]]
id = "T1087"
name = "Account Discovery"
reference = "https://attack.mitre.org/techniques/T1087/"
[[rule.threat.technique.subtechnique]]
id = "T1087.001"
name = "Local Account"
reference = "https://attack.mitre.org/techniques/T1087/001/"

[[rule.threat.technique.subtechnique]]
id = "T1087.002"
name = "Domain Account"
reference = "https://attack.mitre.org/techniques/T1087/002/"


[[rule.threat.technique]]
id = "T1201"
name = "Password Policy Discovery"
reference = "https://attack.mitre.org/techniques/T1201/"


[rule.threat.tactic]
id = "TA0007"
name = "Discovery"
reference = "https://attack.mitre.org/tactics/TA0007/"

