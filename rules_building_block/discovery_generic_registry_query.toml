[metadata]
bypass_bbr_timing = true
creation_date = "2023/07/13"
integration = ["endpoint"]
maturity = "production"
updated_date = "2025/01/10"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
This rule identifies the execution of commands that can be used to query the Windows Registry. Adversaries may query the
registry to gain situational awareness about the host, like installed security software, programs and settings.
"""
from = "now-24h"
index = ["logs-endpoint.events.process-*"]
interval = "12h"
language = "kuery"
license = "Elastic License v2"
name = "Query Registry using Built-in Tools"
risk_score = 21
rule_id = "ded09d02-0137-4ccc-8005-c45e617e8d4c"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Discovery",
    "Rule Type: BBR",
    "Data Source: Elastic Defend",
]
timestamp_override = "event.ingested"
type = "new_terms"

query = '''
host.os.type:windows and event.category:process and event.type:start and
  (
    (process.name.caseless:"reg.exe" and process.args:"query") or
    (process.name.caseless:("powershell.exe" or "powershell_ise.exe" or "pwsh.exe") and
     process.args:(
       ("get-childitem" or "Get-ChildItem" or "gci" or "dir" or "ls" or
        "get-item" or "Get-Item" or "gi" or
        "get-itemproperty" or "Get-ItemProperty" or "gp") and
       ("hkcu" or "HKCU" or "hkey_current_user" or "HKEY_CURRENT_USER" or
        "hkey_local_machine" or "HKEY_LOCAL_MACHINE" or
        "hklm" or "HKLM" or registry\:\:*)
      )
    )
  ) and
  not process.command_line : (
    "C:\\Windows\\system32\\reg.exe  query hklm\\software\\microsoft\\windows\\softwareinventorylogging /v collectionstate /reg:64" or
    "reg  query \"HKLM\\Software\\WOW6432Node\\Npcap\" /ve  "
  )
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Query Registry using Built-in Tools

The Windows Registry is a critical database for system configuration and application settings. Adversaries exploit built-in tools like `reg.exe` and PowerShell to query the registry, seeking insights into installed software and system configurations. The detection rule identifies suspicious registry queries by monitoring specific command executions, filtering out benign activities, and focusing on potential threats, thus aiding in early threat detection.

### Possible investigation steps

- Review the process details, including process.name and process.args, to confirm if the command execution aligns with known legitimate administrative activities or if it appears suspicious.
- Check the process.command_line field to understand the full context of the command executed and identify any deviations from typical usage patterns.
- Investigate the user account associated with the process execution to determine if the activity is expected for that user or if it indicates potential unauthorized access.
- Correlate the event with other recent events involving the same host or user to identify any patterns or sequences that suggest malicious behavior.
- Examine the host's recent activity logs for any signs of compromise or other suspicious activities that might be related to the registry query.
- Assess the risk and impact of the queried registry keys, such as HKCU or HKLM, to determine if they contain sensitive information that could be leveraged by an adversary.

### False positive analysis

- Routine system inventory checks by IT management tools may trigger this rule. To handle this, identify and exclude specific command patterns used by these tools from the detection rule.
- Software update processes often query the registry to verify installation status. Exclude known update processes by adding their command lines to the exception list.
- Security software may perform regular registry queries as part of its monitoring activities. Review and whitelist these processes to prevent unnecessary alerts.
- Custom scripts used for system administration might query the registry. Document and exclude these scripts if they are verified as non-threatening.
- Automated compliance checks that involve registry queries can be excluded by identifying their specific command signatures and adding them to the exception list.

### Response and remediation

- Isolate the affected system from the network to prevent further unauthorized access or data exfiltration.
- Terminate any suspicious processes identified by the detection rule, such as instances of reg.exe or PowerShell executing unauthorized registry queries.
- Conduct a thorough review of the system's registry to identify any unauthorized changes or entries that may have been made by the adversary.
- Restore any altered registry settings to their original state using known good configurations or backups.
- Escalate the incident to the security operations team for further investigation and to determine if additional systems are affected.
- Implement additional monitoring on the affected system and similar endpoints to detect any recurrence of the suspicious activity.
- Review and update endpoint protection policies to block unauthorized registry access and enhance detection capabilities for similar threats."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1012"
name = "Query Registry"
reference = "https://attack.mitre.org/techniques/T1012/"


[rule.threat.tactic]
id = "TA0007"
name = "Discovery"
reference = "https://attack.mitre.org/tactics/TA0007/"

[rule.new_terms]
field = "new_terms_fields"
value = ["host.id", "user.id"]
[[rule.new_terms.history_window_start]]
field = "history_window_start"
value = "now-7d"


