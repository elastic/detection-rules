[metadata]
bypass_bbr_timing = true
creation_date = "2024/04/30"
integration = ["aws"]
maturity = "production"
updated_date = "2025/01/10"

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
Identifies when an AWS IAM login profile is added to a user. Adversaries may add a login profile to an IAM user who
typically does not have one and is used only for programmatic access. This can be used to maintain access to the account
even if the original access key is rotated or disabled. This is a building block rule and does not generate alerts on
its own. It is meant to be used for correlation with other rules to detect suspicious activity.
"""
from = "now-60m"
index = ["filebeat-*", "logs-aws.cloudtrail-*"]
interval = "10m"
language = "kuery"
license = "Elastic License v2"
name = "AWS IAM Login Profile Added to User"
risk_score = 21
rule_id = "10445cf0-0748-11ef-ba75-f661ea17fbcc"
severity = "low"
tags = [
    "Domain: Cloud",
    "Data Source: AWS",
    "Data Source: Amazon Web Services",
    "Data Source: AWS IAM",
    "Use Case: Identity and Access Audit",
    "Tactic: Persistence",
    "Rule Type: BBR",
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset: aws.cloudtrail and event.provider: "iam.amazonaws.com"
    and event.action: "CreateLoginProfile" and event.outcome: success
'''
note = """## Triage and analysis

> **Disclaimer**:
> This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating AWS IAM Login Profile Added to User

AWS IAM (Identity and Access Management) allows users to manage access to AWS services securely. A login profile enables console access for IAM users, typically used for programmatic access. Adversaries may exploit this by adding a login profile to maintain access even if keys are rotated. The detection rule identifies successful login profile creations, aiding in spotting unauthorized persistence attempts.

### Possible investigation steps

- Review the AWS CloudTrail logs to identify the user associated with the CreateLoginProfile event by examining the event.dataset and event.provider fields.
- Check the IAM userâ€™s activity history to determine if there are any unusual or unauthorized actions performed by this user, focusing on recent changes or access patterns.
- Investigate the source IP address and geolocation associated with the CreateLoginProfile event to assess if it aligns with expected user behavior or if it indicates potential unauthorized access.
- Verify if the IAM user typically has console access or if this is an anomaly, as the rule suggests the user is usually for programmatic access only.
- Correlate this event with other security alerts or logs to identify if there are additional indicators of compromise or persistence tactics being employed by an adversary.

### False positive analysis

- Routine administrative actions: Regularly scheduled maintenance or administrative tasks may involve creating login profiles for IAM users. To manage this, establish a baseline of expected administrative activities and exclude these from alerts.
- Onboarding processes: New employee onboarding might include creating login profiles for IAM users. Coordinate with HR and IT departments to identify and exclude these events from triggering alerts.
- Automated scripts: Some organizations use automated scripts to manage IAM users, which may include creating login profiles. Review and whitelist these scripts to prevent false positives.
- Third-party integrations: Certain third-party services may require login profiles for integration purposes. Identify and document these services, then create exceptions for their legitimate activities.
- Temporary access needs: Occasionally, temporary access might be granted to users for specific projects or tasks. Implement a process to track and exclude these temporary access events from alerting.

### Response and remediation

- Immediately disable the login profile for the affected IAM user to prevent unauthorized console access.
- Review CloudTrail logs to identify any unauthorized activities performed by the IAM user after the login profile was created.
- Rotate and reissue any access keys associated with the affected IAM user to ensure no further unauthorized programmatic access.
- Conduct a thorough review of IAM policies and permissions associated with the affected user to ensure they align with the principle of least privilege.
- Notify the security team and relevant stakeholders about the incident for awareness and further investigation.
- Implement additional monitoring and alerting for any future attempts to create login profiles on IAM users who typically do not require console access.
- Consider enabling multi-factor authentication (MFA) for all IAM users to add an additional layer of security against unauthorized access."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"
[[rule.threat.technique.subtechnique]]
id = "T1078.004"
name = "Cloud Accounts"
reference = "https://attack.mitre.org/techniques/T1078/004/"


[[rule.threat.technique]]
id = "T1098"
name = "Account Manipulation"
reference = "https://attack.mitre.org/techniques/T1098/"
[[rule.threat.technique.subtechnique]]
id = "T1098.003"
name = "Additional Cloud Roles"
reference = "https://attack.mitre.org/techniques/T1098/003/"



[rule.threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"

