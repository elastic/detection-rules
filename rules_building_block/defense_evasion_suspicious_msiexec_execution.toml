[metadata]
creation_date = "2023/09/26"
integration = ["endpoint", "windows"]
maturity = "production"
updated_date = "2025/01/08"
min_stack_version = "8.14.0"
min_stack_comments = "Breaking change at 8.14.0 for the Windows Integration."

[rule]
author = ["Elastic"]
building_block_type = "default"
description = """
Identifies suspicious execution of the built-in Windows Installer, msiexec.exe, to install a package from usual paths or
parent process. Adversaries may abuse msiexec.exe to launch malicious local MSI files.
"""
from = "now-119m"
index = ["logs-endpoint.events.process-*", "winlogbeat-*", "logs-windows.*", "endgame-*"]
interval = "60m"
language = "eql"
license = "Elastic License v2"
name = "Suspicious Execution via MSIEXEC"
references = [
    "https://lolbas-project.github.io/lolbas/Binaries/Msiexec/",
    "https://www.guardicore.com/labs/purple-fox-rootkit-now-propagates-as-a-worm/",
]
risk_score = 21
rule_id = "708c9d92-22a3-4fe0-b6b9-1f861c55502d"
severity = "low"
tags = [
    "Domain: Endpoint",
    "OS: Windows",
    "Use Case: Threat Detection",
    "Tactic: Defense Evasion",
    "Rule Type: BBR",
    "Data Source: Elastic Defend",
    "Data Source: Elastic Endgame",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "windows" and event.action == "start" and
  process.name : "msiexec.exe" and user.id : ("S-1-5-21*", "S-1-12-*") and process.parent.executable != null and
  (
    (process.args : "/i" and process.args : ("/q", "/quiet") and process.args_count == 4 and
     process.args : ("?:\\Users\\*", "?:\\ProgramData\\*") and
     not process.parent.executable : ("?:\\Program Files (x86)\\*.exe",
                                      "?:\\Program Files\\*.exe",
                                      "?:\\Windows\\explorer.exe",
                                      "?:\\Users\\*\\Desktop\\*",
                                      "?:\\Users\\*\\Downloads\\*",
                                      "?:\\programdata\\*")) or

    (process.args_count == 1 and not process.parent.executable : ("?:\\Windows\\explorer.exe", "?:\\Windows\\SysWOW64\\explorer.exe")) or

    (process.args : "/i" and process.args : ("/q", "/quiet") and process.args_count == 4 and
     (process.parent.args : "Schedule" or process.parent.name : "wmiprvse.exe" or
     process.parent.executable : "?:\\Users\\*\\AppData\\*" or
     (process.parent.name : ("powershell.exe", "cmd.exe") and length(process.parent.command_line) >= 200))) or

    (process.args : "/i" and process.args : ("/q", "/quiet") and process.args_count == 4 and
     ?process.working_directory : "?:\\" and process.parent.name : ("cmd.exe", "powershell.exe"))
  ) and

  /* noisy pattern */
  not (process.parent.executable : "?:\\Users\\*\\AppData\\Local\\Temp\\*" and ?process.parent.args_count >= 2 and
       process.args : "?:\\Users\\*\\AppData\\Local\\Temp\\*\\*.msi") and

  not process.args : ("?:\\Program Files (x86)\\*", "?:\\Program Files\\*")
'''
note = """## Triage and analysis

### Disclaimer

This investigation guide was generated using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.

### Investigating Suspicious Execution via MSIEXEC

MSIEXEC is a Windows Installer utility used for installing, maintaining, and removing software. Adversaries exploit it to execute malicious MSI files, often bypassing security controls. The detection rule identifies unusual MSIEXEC activity by scrutinizing execution paths, parent processes, and command-line arguments, flagging deviations from typical usage patterns to uncover potential threats.

### Possible investigation steps

- Review the alert details to understand which specific conditions of the detection rule were met, focusing on the process name, parent process, and command-line arguments.
- Examine the `process.parent.executable` field to identify the parent process that initiated `msiexec.exe`. Determine if this parent process is commonly associated with legitimate software installations.
- Investigate the `process.args` field to analyze the command-line arguments used with `msiexec.exe`, paying particular attention to the presence of `/i`, `/q`, or `/quiet` flags, which may indicate silent installations.
- Check the `process.args_count` to ensure it aligns with typical usage patterns. An unusual count may suggest additional, potentially malicious arguments.
- Analyze the `process.working_directory` to verify if the execution path is consistent with standard software installation directories or if it points to suspicious locations.
- Use Osquery to gather more context about the process and its parent. For example, run the following query to list processes with their parent details: `SELECT pid, name, path, parent, cmdline FROM processes WHERE name = 'msiexec.exe';`
- Investigate the `user.id` field to determine the user account under which `msiexec.exe` was executed. Check if this account has a history of performing software installations.
- Cross-reference the `process.parent.name` with known legitimate processes like `explorer.exe` or `wmiprvse.exe` to assess if the parent process is expected or unusual.
- Look into the `process.parent.command_line` length, especially if the parent process is `powershell.exe` or `cmd.exe`, to identify potentially obfuscated or complex command lines.
- Review historical data for similar alerts involving the same `process.parent.executable` or `process.args` to identify patterns or repeated suspicious behavior.

### False positive analysis

- Legitimate software installations or updates may trigger the rule if they use msiexec.exe with command-line arguments that match the suspicious patterns, such as silent installations using "/q" or "/quiet" switches.
- System administrators or automated deployment tools might use msiexec.exe to install software across multiple systems, which could be flagged if the parent process or execution path is unusual.
- Custom scripts or third-party management tools that leverage msiexec.exe for software management tasks could be misidentified as malicious if they execute from non-standard directories or with uncommon parent processes.
- To manage these false positives, users can create exceptions for known benign processes or paths by adding them to the exclusion list in the detection rule, ensuring that frequent non-threatening behaviors are not flagged.
- Regularly review and update the exclusion list to accommodate changes in legitimate software deployment practices or new trusted applications that may trigger the rule.

### Response and remediation

- Isolate the affected system from the network to prevent further spread of potential threats.
- Analyze the suspicious msiexec.exe process and its parent process to determine if it is part of a known attack pattern or a false positive.
- Terminate any malicious processes identified during the investigation to stop ongoing malicious activity.
- Review and collect relevant logs, including Windows Event Logs and security software logs, to gather evidence and understand the scope of the incident.
- Escalate the incident to the security operations center (SOC) or incident response team if the threat is confirmed to be part of a larger attack campaign.
- Remove any malicious MSI files and associated artifacts from the system to ensure complete remediation.
- Restore the system from a known good backup if the integrity of the system is compromised.
- Implement enhanced logging policies to capture detailed process execution and command-line arguments for future investigations.
- Integrate threat intelligence feeds and security information and event management (SIEM) solutions to improve detection capabilities.
- Apply system hardening measures, such as restricting the execution of msiexec.exe to authorized users and paths, to reduce the risk of similar attacks in the future."""


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1218"
name = "System Binary Proxy Execution"
reference = "https://attack.mitre.org/techniques/T1218/"
[[rule.threat.technique.subtechnique]]
id = "T1218.007"
name = "Msiexec"
reference = "https://attack.mitre.org/techniques/T1218/007/"



[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

